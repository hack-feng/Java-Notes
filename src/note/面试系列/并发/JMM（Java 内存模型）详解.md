JMM(Java å†…å­˜æ¨¡å‹)ä¸»è¦å®šä¹‰äº†å¯¹äºä¸€ä¸ªå…±äº«å˜é‡ï¼Œå½“å¦ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªå…±äº«å˜é‡æ‰§è¡Œå†™æ“ä½œåï¼Œè¿™ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªå…±äº«å˜é‡çš„å¯è§æ€§ã€‚

è¦æƒ³ç†è§£é€å½» JMMï¼ˆJava å†…å­˜æ¨¡å‹ï¼‰ï¼Œæˆ‘ä»¬å…ˆè¦ä» **CPU ç¼“å­˜æ¨¡å‹å’ŒæŒ‡ä»¤é‡æ’åº** è¯´èµ·ï¼

## ä» CPU ç¼“å­˜æ¨¡å‹è¯´èµ· ##

**ä¸ºä»€ä¹ˆè¦å¼„ä¸€ä¸ª CPU é«˜é€Ÿç¼“å­˜å‘¢ï¼Ÿ** ç±»æ¯”æˆ‘ä»¬å¼€å‘ç½‘ç«™åå°ç³»ç»Ÿä½¿ç”¨çš„ç¼“å­˜ï¼ˆæ¯”å¦‚ Redisï¼‰æ˜¯ä¸ºäº†è§£å†³ç¨‹åºå¤„ç†é€Ÿåº¦å’Œè®¿é—®å¸¸è§„å…³ç³»å‹æ•°æ®åº“é€Ÿåº¦ä¸å¯¹ç­‰çš„é—®é¢˜ã€‚ **CPU ç¼“å­˜åˆ™æ˜¯ä¸ºäº†è§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜å¤„ç†é€Ÿåº¦ä¸å¯¹ç­‰çš„é—®é¢˜ã€‚**

æˆ‘ä»¬ç”šè‡³å¯ä»¥æŠŠ **å†…å­˜çœ‹ä½œå¤–å­˜çš„é«˜é€Ÿç¼“å­˜**ï¼Œç¨‹åºè¿è¡Œçš„æ—¶å€™æˆ‘ä»¬æŠŠå¤–å­˜çš„æ•°æ®å¤åˆ¶åˆ°å†…å­˜ï¼Œç”±äºå†…å­˜çš„å¤„ç†é€Ÿåº¦è¿œè¿œé«˜äºå¤–å­˜ï¼Œè¿™æ ·æé«˜äº†å¤„ç†é€Ÿåº¦ã€‚

æ€»ç»“ï¼š**CPU Cache ç¼“å­˜çš„æ˜¯å†…å­˜æ•°æ®ç”¨äºè§£å†³ CPU å¤„ç†é€Ÿåº¦å’Œå†…å­˜ä¸åŒ¹é…çš„é—®é¢˜ï¼Œå†…å­˜ç¼“å­˜çš„æ˜¯ç¡¬ç›˜æ•°æ®ç”¨äºè§£å†³ç¡¬ç›˜è®¿é—®é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜ã€‚**

ä¸ºäº†æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘ç”»äº†ä¸€ä¸ªç®€å•çš„ CPU Cache ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚

> **ğŸ› ä¿®æ­£ï¼ˆå‚è§ï¼š[issue\#1848][issue_1848]ï¼‰**ï¼šå¯¹ CPU ç¼“å­˜æ¨¡å‹ç»˜å›¾ä¸ä¸¥è°¨çš„åœ°æ–¹è¿›è¡Œå®Œå–„ã€‚

![ç¬‘å°æ«-www.xiaoxiaofeng.com](https://image.xiaoxiaofeng.site/spider/2024/11/21/xxf-1732157406502.png) 

ç°ä»£çš„ CPU Cache é€šå¸¸åˆ†ä¸ºä¸‰å±‚ï¼Œåˆ†åˆ«å« L1,L2,L3 Cacheã€‚æœ‰äº› CPU å¯èƒ½è¿˜æœ‰ L4 Cacheï¼Œè¿™é‡Œä¸åšè®¨è®ºï¼Œå¹¶ä¸å¸¸è§

**CPU Cache çš„å·¥ä½œæ–¹å¼ï¼š** å…ˆå¤åˆ¶ä¸€ä»½æ•°æ®åˆ° CPU Cache ä¸­ï¼Œå½“ CPU éœ€è¦ç”¨åˆ°çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ä» CPU Cache ä¸­è¯»å–æ•°æ®ï¼Œå½“è¿ç®—å®Œæˆåï¼Œå†å°†è¿ç®—å¾—åˆ°çš„æ•°æ®å†™å› Main Memory ä¸­ã€‚ä½†æ˜¯ï¼Œè¿™æ ·å­˜åœ¨ **å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§çš„é—®é¢˜** ï¼æ¯”å¦‚æˆ‘æ‰§è¡Œä¸€ä¸ª i++ æ“ä½œçš„è¯ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œçš„è¯ï¼Œå‡è®¾ä¸¤ä¸ªçº¿ç¨‹ä» CPU Cache ä¸­è¯»å–çš„ i=1ï¼Œä¸¤ä¸ªçº¿ç¨‹åšäº† i++ è¿ç®—å®Œä¹‹åå†å†™å› Main Memory ä¹‹å i=2ï¼Œè€Œæ­£ç¡®ç»“æœåº”è¯¥æ˜¯ i=3ã€‚

**CPU ä¸ºäº†è§£å†³å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜å¯ä»¥é€šè¿‡åˆ¶å®šç¼“å­˜ä¸€è‡´åè®®ï¼ˆæ¯”å¦‚ [MESI åè®®][MESI]ï¼‰æˆ–è€…å…¶ä»–æ‰‹æ®µæ¥è§£å†³ã€‚** è¿™ä¸ªç¼“å­˜ä¸€è‡´æ€§åè®®æŒ‡çš„æ˜¯åœ¨ CPU é«˜é€Ÿç¼“å­˜ä¸ä¸»å†…å­˜äº¤äº’çš„æ—¶å€™éœ€è¦éµå®ˆçš„åŸåˆ™å’Œè§„èŒƒã€‚ä¸åŒçš„ CPU ä¸­ï¼Œä½¿ç”¨çš„ç¼“å­˜ä¸€è‡´æ€§åè®®é€šå¸¸ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚

![ç¬‘å°æ«-www.xiaoxiaofeng.com](https://image.xiaoxiaofeng.site/spider/2024/11/21/xxf-1732157406973.png) 

æˆ‘ä»¬çš„ç¨‹åºè¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œæ“ä½œç³»ç»Ÿå±è”½äº†åº•å±‚ç¡¬ä»¶çš„æ“ä½œç»†èŠ‚ï¼Œå°†å„ç§ç¡¬ä»¶èµ„æºè™šæ‹ŸåŒ–ã€‚äºæ˜¯ï¼Œæ“ä½œç³»ç»Ÿä¹Ÿå°±åŒæ ·éœ€è¦è§£å†³å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚

æ“ä½œç³»ç»Ÿé€šè¿‡ **å†…å­˜æ¨¡å‹ï¼ˆMemory Modelï¼‰** å®šä¹‰ä¸€ç³»åˆ—è§„èŒƒæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ— è®ºæ˜¯ Windows ç³»ç»Ÿï¼Œè¿˜æ˜¯ Linux ç³»ç»Ÿï¼Œå®ƒä»¬éƒ½æœ‰ç‰¹å®šçš„å†…å­˜æ¨¡å‹ã€‚

## æŒ‡ä»¤é‡æ’åº ##

è¯´å®Œäº† CPU ç¼“å­˜æ¨¡å‹ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦å¤–ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µ **æŒ‡ä»¤é‡æ’åº** ã€‚

ä¸ºäº†æå‡æ‰§è¡Œé€Ÿåº¦/æ€§èƒ½ï¼Œè®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºä»£ç çš„æ—¶å€™ï¼Œä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºã€‚

**ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’åºï¼Ÿ** ç®€å•æ¥è¯´å°±æ˜¯ç³»ç»Ÿåœ¨æ‰§è¡Œä»£ç çš„æ—¶å€™å¹¶ä¸ä¸€å®šæ˜¯æŒ‰ç…§ä½ å†™çš„ä»£ç çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚

å¸¸è§çš„æŒ‡ä»¤é‡æ’åºæœ‰ä¸‹é¢ 2 ç§æƒ…å†µï¼š

 *  **ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’**ï¼šç¼–è¯‘å™¨ï¼ˆåŒ…æ‹¬ JVMã€JIT ç¼–è¯‘å™¨ç­‰ï¼‰åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œé‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚
 *  **æŒ‡ä»¤å¹¶è¡Œé‡æ’**ï¼šç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯(Instruction-Level Parallelismï¼ŒILP)æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚

å¦å¤–ï¼Œå†…å­˜ç³»ç»Ÿä¹Ÿä¼šæœ‰â€œé‡æ’åºâ€ï¼Œä½†åˆä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„é‡æ’åºã€‚åœ¨ JMM é‡Œè¡¨ç°ä¸ºä¸»å­˜å’Œæœ¬åœ°å†…å­˜çš„å†…å®¹å¯èƒ½ä¸ä¸€è‡´ï¼Œè¿›è€Œå¯¼è‡´ç¨‹åºåœ¨å¤šçº¿ç¨‹ä¸‹æ‰§è¡Œå¯èƒ½å‡ºç°é—®é¢˜ã€‚

Java æºä»£ç ä¼šç»å† **ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’ â€”> æŒ‡ä»¤å¹¶è¡Œé‡æ’ â€”> å†…å­˜ç³»ç»Ÿé‡æ’** çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆæ‰å˜æˆæ“ä½œç³»ç»Ÿå¯æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ã€‚

**æŒ‡ä»¤é‡æ’åºå¯ä»¥ä¿è¯ä¸²è¡Œè¯­ä¹‰ä¸€è‡´ï¼Œä½†æ˜¯æ²¡æœ‰ä¹‰åŠ¡ä¿è¯å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¹Ÿä¸€è‡´** ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹ï¼ŒæŒ‡ä»¤é‡æ’åºå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚

å¯¹äºç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’å’Œå¤„ç†å™¨çš„æŒ‡ä»¤é‡æ’åºï¼ˆæŒ‡ä»¤å¹¶è¡Œé‡æ’å’Œå†…å­˜ç³»ç»Ÿé‡æ’éƒ½å±äºæ˜¯å¤„ç†å™¨çº§åˆ«çš„æŒ‡ä»¤é‡æ’åºï¼‰ï¼Œå¤„ç†è¯¥é—®é¢˜çš„æ–¹å¼ä¸ä¸€æ ·ã€‚

 *  å¯¹äºç¼–è¯‘å™¨ï¼Œé€šè¿‡ç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºçš„æ–¹å¼æ¥ç¦æ­¢é‡æ’åºã€‚
 *  å¯¹äºå¤„ç†å™¨ï¼Œé€šè¿‡æ’å…¥å†…å­˜å±éšœï¼ˆMemory Barrierï¼Œæˆ–æœ‰æ—¶å«åšå†…å­˜æ …æ ï¼ŒMemory Fenceï¼‰çš„æ–¹å¼æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚

> å†…å­˜å±éšœï¼ˆMemory Barrierï¼Œæˆ–æœ‰æ—¶å«åšå†…å­˜æ …æ ï¼ŒMemory Fenceï¼‰æ˜¯ä¸€ç§ CPU æŒ‡ä»¤ï¼Œç”¨æ¥ç¦æ­¢å¤„ç†å™¨æŒ‡ä»¤å‘ç”Ÿé‡æ’åºï¼ˆåƒå±éšœä¸€æ ·ï¼‰ï¼Œä»è€Œä¿éšœæŒ‡ä»¤æ‰§è¡Œçš„æœ‰åºæ€§ã€‚å¦å¤–ï¼Œä¸ºäº†è¾¾åˆ°å±éšœçš„æ•ˆæœï¼Œå®ƒä¹Ÿä¼šä½¿å¤„ç†å™¨å†™å…¥ã€è¯»å–å€¼ä¹‹å‰ï¼Œå°†ä¸»å†…å­˜çš„å€¼å†™å…¥é«˜é€Ÿç¼“å­˜ï¼Œæ¸…ç©ºæ— æ•ˆé˜Ÿåˆ—ï¼Œä»è€Œä¿éšœå˜é‡çš„å¯è§æ€§ã€‚

## JMM(Java Memory Model) ##

### ä»€ä¹ˆæ˜¯ JMMï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ JMMï¼Ÿ ###

Java æ˜¯æœ€æ—©å°è¯•æä¾›å†…å­˜æ¨¡å‹çš„ç¼–ç¨‹è¯­è¨€ã€‚ç”±äºæ—©æœŸå†…å­˜æ¨¡å‹å­˜åœ¨ä¸€äº›ç¼ºé™·ï¼ˆæ¯”å¦‚éå¸¸å®¹æ˜“å‰Šå¼±ç¼–è¯‘å™¨çš„ä¼˜åŒ–èƒ½åŠ›ï¼‰ï¼Œä» Java5 å¼€å§‹ï¼ŒJava å¼€å§‹ä½¿ç”¨æ–°çš„å†…å­˜æ¨¡å‹ [ã€ŠJSR-133ï¼šJava Memory Model and Thread Specificationã€‹][JSR-133_Java Memory Model and Thread Specification] ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œç¼–ç¨‹è¯­è¨€ä¹Ÿå¯ä»¥ç›´æ¥å¤ç”¨æ“ä½œç³»ç»Ÿå±‚é¢çš„å†…å­˜æ¨¡å‹ã€‚ä¸è¿‡ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿå†…å­˜æ¨¡å‹ä¸åŒã€‚å¦‚æœç›´æ¥å¤ç”¨æ“ä½œç³»ç»Ÿå±‚é¢çš„å†…å­˜æ¨¡å‹ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´åŒæ ·ä¸€å¥—ä»£ç æ¢äº†ä¸€ä¸ªæ“ä½œç³»ç»Ÿå°±æ— æ³•æ‰§è¡Œäº†ã€‚Java è¯­è¨€æ˜¯è·¨å¹³å°çš„ï¼Œå®ƒéœ€è¦è‡ªå·±æä¾›ä¸€å¥—å†…å­˜æ¨¡å‹ä»¥å±è”½ç³»ç»Ÿå·®å¼‚ã€‚

è¿™åªæ˜¯ JMM å­˜åœ¨çš„å…¶ä¸­ä¸€ä¸ªåŸå› ã€‚å®é™…ä¸Šï¼Œå¯¹äº Java æ¥è¯´ï¼Œä½ å¯ä»¥æŠŠ JMM çœ‹ä½œæ˜¯ Java å®šä¹‰çš„å¹¶å‘ç¼–ç¨‹ç›¸å…³çš„ä¸€ç»„è§„èŒƒï¼Œé™¤äº†æŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ä¹‹å¤–ï¼Œå…¶è¿˜è§„å®šäº†ä» Java æºä»£ç åˆ° CPU å¯æ‰§è¡ŒæŒ‡ä»¤çš„è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹è¦éµå®ˆå“ªäº›å’Œå¹¶å‘ç›¸å…³çš„åŸåˆ™å’Œè§„èŒƒï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¢å¼ºç¨‹åºå¯ç§»æ¤æ€§çš„ã€‚

**ä¸ºä»€ä¹ˆè¦éµå®ˆè¿™äº›å¹¶å‘ç›¸å…³çš„åŸåˆ™å’Œè§„èŒƒå‘¢ï¼Ÿ** è¿™æ˜¯å› ä¸ºå¹¶å‘ç¼–ç¨‹ä¸‹ï¼Œåƒ CPU å¤šçº§ç¼“å­˜å’ŒæŒ‡ä»¤é‡æ’è¿™ç±»è®¾è®¡å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºè¿è¡Œå‡ºç°ä¸€äº›é—®é¢˜ã€‚å°±æ¯”å¦‚è¯´æˆ‘ä»¬ä¸Šé¢æåˆ°çš„æŒ‡ä»¤é‡æ’åºå°±å¯èƒ½ä¼šè®©å¤šçº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œå‡ºç°é—®é¢˜ï¼Œä¸ºæ­¤ï¼ŒJMM æŠ½è±¡äº† happens-before åŸåˆ™ï¼ˆåæ–‡ä¼šè¯¦ç»†ä»‹ç»åˆ°ï¼‰æ¥è§£å†³è¿™ä¸ªæŒ‡ä»¤é‡æ’åºé—®é¢˜ã€‚

JMM è¯´ç™½äº†å°±æ˜¯å®šä¹‰äº†ä¸€äº›è§„èŒƒæ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œå¼€å‘è€…å¯ä»¥åˆ©ç”¨è¿™äº›è§„èŒƒæ›´æ–¹ä¾¿åœ°å¼€å‘å¤šçº¿ç¨‹ç¨‹åºã€‚å¯¹äº Java å¼€å‘è€…è¯´ï¼Œä½ ä¸éœ€è¦äº†è§£åº•å±‚åŸç†ï¼Œç›´æ¥ä½¿ç”¨å¹¶å‘ç›¸å…³çš„ä¸€äº›å…³é”®å­—å’Œç±»ï¼ˆæ¯”å¦‚ `volatile`ã€`synchronized`ã€å„ç§ `Lock`ï¼‰å³å¯å¼€å‘å‡ºå¹¶å‘å®‰å…¨çš„ç¨‹åºã€‚

### JMM æ˜¯å¦‚ä½•æŠ½è±¡çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ï¼Ÿ ###

**Java å†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰** æŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ï¼Œå°±æ¯”å¦‚è¯´çº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å¿…é¡»å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ã€‚

åœ¨ JDK1.2 ä¹‹å‰ï¼ŒJava çš„å†…å­˜æ¨¡å‹å®ç°æ€»æ˜¯ä» **ä¸»å­˜** ï¼ˆå³å…±äº«å†…å­˜ï¼‰è¯»å–å˜é‡ï¼Œæ˜¯ä¸éœ€è¦è¿›è¡Œç‰¹åˆ«çš„æ³¨æ„çš„ã€‚è€Œåœ¨å½“å‰çš„ Java å†…å­˜æ¨¡å‹ä¸‹ï¼Œçº¿ç¨‹å¯ä»¥æŠŠå˜é‡ä¿å­˜ **æœ¬åœ°å†…å­˜** ï¼ˆæ¯”å¦‚æœºå™¨çš„å¯„å­˜å™¨ï¼‰ä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨ä¸»å­˜ä¸­è¿›è¡Œè¯»å†™ã€‚è¿™å°±å¯èƒ½é€ æˆä¸€ä¸ªçº¿ç¨‹åœ¨ä¸»å­˜ä¸­ä¿®æ”¹äº†ä¸€ä¸ªå˜é‡çš„å€¼ï¼Œè€Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿˜ç»§ç»­ä½¿ç”¨å®ƒåœ¨å¯„å­˜å™¨ä¸­çš„å˜é‡å€¼çš„æ‹·è´ï¼Œé€ æˆæ•°æ®çš„ä¸ä¸€è‡´ã€‚

è¿™å’Œæˆ‘ä»¬ä¸Šé¢è®²åˆ°çš„ CPU ç¼“å­˜æ¨¡å‹éå¸¸ç›¸ä¼¼ã€‚

**ä»€ä¹ˆæ˜¯ä¸»å†…å­˜ï¼Ÿä»€ä¹ˆæ˜¯æœ¬åœ°å†…å­˜ï¼Ÿ**

 *  **ä¸»å†…å­˜**ï¼šæ‰€æœ‰çº¿ç¨‹åˆ›å»ºçš„å®ä¾‹å¯¹è±¡éƒ½å­˜æ”¾åœ¨ä¸»å†…å­˜ä¸­ï¼Œä¸ç®¡è¯¥å®ä¾‹å¯¹è±¡æ˜¯æˆå‘˜å˜é‡ï¼Œè¿˜æ˜¯å±€éƒ¨å˜é‡ï¼Œç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡éƒ½æ˜¯æ”¾åœ¨ä¸»å†…å­˜ä¸­ã€‚ä¸ºäº†è·å–æ›´å¥½çš„è¿è¡Œé€Ÿåº¦ï¼Œè™šæ‹ŸæœºåŠç¡¬ä»¶ç³»ç»Ÿå¯èƒ½ä¼šè®©å·¥ä½œå†…å­˜ä¼˜å…ˆå­˜å‚¨äºå¯„å­˜å™¨å’Œé«˜é€Ÿç¼“å­˜ä¸­ã€‚
 *  **æœ¬åœ°å†…å­˜**ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼Œæœ¬åœ°å†…å­˜å­˜å‚¨äº†è¯¥çº¿ç¨‹ä»¥è¯» / å†™å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚æ¯ä¸ªçº¿ç¨‹åªèƒ½æ“ä½œè‡ªå·±æœ¬åœ°å†…å­˜ä¸­çš„å˜é‡ï¼Œæ— æ³•ç›´æ¥è®¿é—®å…¶ä»–çº¿ç¨‹çš„æœ¬åœ°å†…å­˜ã€‚å¦‚æœçº¿ç¨‹é—´éœ€è¦é€šä¿¡ï¼Œå¿…é¡»é€šè¿‡ä¸»å†…å­˜æ¥è¿›è¡Œã€‚æœ¬åœ°å†…å­˜æ˜¯ JMM æŠ½è±¡å‡ºæ¥çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå¹¶ä¸çœŸå®å­˜åœ¨ï¼Œå®ƒæ¶µç›–äº†ç¼“å­˜ã€å†™ç¼“å†²åŒºã€å¯„å­˜å™¨ä»¥åŠå…¶ä»–çš„ç¡¬ä»¶å’Œç¼–è¯‘å™¨ä¼˜åŒ–ã€‚

Java å†…å­˜æ¨¡å‹çš„æŠ½è±¡ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![ç¬‘å°æ«-www.xiaoxiaofeng.com](https://image.xiaoxiaofeng.site/spider/2024/11/21/xxf-1732157407376.png) 

ä»ä¸Šå›¾æ¥çœ‹ï¼Œçº¿ç¨‹ 1 ä¸çº¿ç¨‹ 2 ä¹‹é—´å¦‚æœè¦è¿›è¡Œé€šä¿¡çš„è¯ï¼Œå¿…é¡»è¦ç»å†ä¸‹é¢ 2 ä¸ªæ­¥éª¤ï¼š

1.  çº¿ç¨‹ 1 æŠŠæœ¬åœ°å†…å­˜ä¸­ä¿®æ”¹è¿‡çš„å…±äº«å˜é‡å‰¯æœ¬çš„å€¼åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­å»ã€‚
2.  çº¿ç¨‹ 2 åˆ°ä¸»å­˜ä¸­è¯»å–å¯¹åº”çš„å…±äº«å˜é‡çš„å€¼ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼ŒJMM ä¸ºå…±äº«å˜é‡æä¾›äº†å¯è§æ€§çš„ä¿éšœã€‚

ä¸è¿‡ï¼Œå¤šçº¿ç¨‹ä¸‹ï¼Œå¯¹ä¸»å†…å­˜ä¸­çš„ä¸€ä¸ªå…±äº«å˜é‡è¿›è¡Œæ“ä½œæœ‰å¯èƒ½è¯±å‘çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

1.  çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 åˆ†åˆ«å¯¹åŒä¸€ä¸ªå…±äº«å˜é‡è¿›è¡Œæ“ä½œï¼Œä¸€ä¸ªæ‰§è¡Œä¿®æ”¹ï¼Œä¸€ä¸ªæ‰§è¡Œè¯»å–ã€‚
2.  çº¿ç¨‹ 2 è¯»å–åˆ°çš„æ˜¯çº¿ç¨‹ 1 ä¿®æ”¹ä¹‹å‰çš„å€¼è¿˜æ˜¯ä¿®æ”¹åçš„å€¼å¹¶ä¸ç¡®å®šï¼Œéƒ½æœ‰å¯èƒ½ï¼Œå› ä¸ºçº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 éƒ½æ˜¯å…ˆå°†å…±äº«å˜é‡ä»ä¸»å†…å­˜æ‹·è´åˆ°å¯¹åº”çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ã€‚

å…³äºä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ç›´æ¥çš„å…·ä½“äº¤äº’åè®®ï¼Œå³ä¸€ä¸ªå˜é‡å¦‚ä½•ä»ä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ï¼Œå¦‚ä½•ä»å·¥ä½œå†…å­˜åŒæ­¥åˆ°ä¸»å†…å­˜ä¹‹é—´çš„å®ç°ç»†èŠ‚ï¼ŒJava å†…å­˜æ¨¡å‹å®šä¹‰æ¥ä»¥ä¸‹å…«ç§åŒæ­¥æ“ä½œï¼ˆäº†è§£å³å¯ï¼Œæ— éœ€æ­»è®°ç¡¬èƒŒï¼‰ï¼š

 *  **é”å®šï¼ˆlockï¼‰**: ä½œç”¨äºä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œå°†ä»–æ ‡è®°ä¸ºä¸€ä¸ªçº¿ç¨‹ç‹¬äº«å˜é‡ã€‚
 *  **è§£é”ï¼ˆunlockï¼‰**: ä½œç”¨äºä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œè§£é™¤å˜é‡çš„é”å®šçŠ¶æ€ï¼Œè¢«è§£é™¤é”å®šçŠ¶æ€çš„å˜é‡æ‰èƒ½è¢«å…¶ä»–çº¿ç¨‹é”å®šã€‚
 *  **readï¼ˆè¯»å–ï¼‰**ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„ load åŠ¨ä½œä½¿ç”¨ã€‚
 *  **load(è½½å…¥)**ï¼šæŠŠ read æ“ä½œä»ä¸»å†…å­˜ä¸­å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡çš„å‰¯æœ¬ä¸­ã€‚
 *  **use(ä½¿ç”¨)**ï¼šæŠŠå·¥ä½œå†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ ç»™æ‰§è¡Œå¼•æ“ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªä½¿ç”¨åˆ°å˜é‡çš„æŒ‡ä»¤æ—¶éƒ½ä¼šä½¿ç”¨è¯¥æŒ‡ä»¤ã€‚
 *  **assignï¼ˆèµ‹å€¼ï¼‰**ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»æ‰§è¡Œå¼•æ“æ¥æ”¶åˆ°çš„å€¼èµ‹ç»™å·¥ä½œå†…å­˜çš„å˜é‡ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªç»™å˜é‡èµ‹å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶æ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚
 *  **storeï¼ˆå­˜å‚¨ï¼‰**ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„ write æ“ä½œä½¿ç”¨ã€‚
 *  **writeï¼ˆå†™å…¥ï¼‰**ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠ store æ“ä½œä»å·¥ä½œå†…å­˜ä¸­å¾—åˆ°çš„å˜é‡çš„å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­ã€‚

é™¤äº†è¿™ 8 ç§åŒæ­¥æ“ä½œä¹‹å¤–ï¼Œè¿˜è§„å®šäº†ä¸‹é¢è¿™äº›åŒæ­¥è§„åˆ™æ¥ä¿è¯è¿™äº›åŒæ­¥æ“ä½œçš„æ­£ç¡®æ‰§è¡Œï¼ˆäº†è§£å³å¯ï¼Œæ— éœ€æ­»è®°ç¡¬èƒŒï¼‰ï¼š

 *  ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°ï¼ˆæ²¡æœ‰å‘ç”Ÿè¿‡ä»»ä½• assign æ“ä½œï¼‰æŠŠæ•°æ®ä»çº¿ç¨‹çš„å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¸­ã€‚
 *  ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­ â€œè¯ç”Ÿâ€ï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆload æˆ– assignï¼‰çš„å˜é‡ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡å®æ–½ use å’Œ store æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæ‰§è¡Œè¿‡äº† assign å’Œ load æ“ä½œã€‚
 *  ä¸€ä¸ªå˜é‡åœ¨åŒä¸€ä¸ªæ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œ lock æ“ä½œï¼Œä½† lock æ“ä½œå¯ä»¥è¢«åŒä¸€æ¡çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œ lock åï¼Œåªæœ‰æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„ unlock æ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ã€‚
 *  å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ lock æ“ä½œï¼Œå°†ä¼šæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡å‰ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œ load æˆ– assign æ“ä½œåˆå§‹åŒ–å˜é‡çš„å€¼ã€‚
 *  å¦‚æœä¸€ä¸ªå˜é‡äº‹å…ˆæ²¡æœ‰è¢« lock æ“ä½œé”å®šï¼Œåˆ™ä¸å…è®¸å¯¹å®ƒæ‰§è¡Œ unlock æ“ä½œï¼Œä¹Ÿä¸å…è®¸å» unlock ä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šä½çš„å˜é‡ã€‚
 *  â€¦â€¦

### Java å†…å­˜åŒºåŸŸå’Œ JMM æœ‰ä½•åŒºåˆ«ï¼Ÿ ###

è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„é—®é¢˜ï¼Œå¾ˆå¤šåˆå­¦è€…éå¸¸å®¹æ˜“ææ··ã€‚ **Java å†…å­˜åŒºåŸŸå’Œå†…å­˜æ¨¡å‹æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ä¸¤ä¸ªä¸œè¥¿**ï¼š

 *  JVM å†…å­˜ç»“æ„å’Œ Java è™šæ‹Ÿæœºçš„è¿è¡Œæ—¶åŒºåŸŸç›¸å…³ï¼Œå®šä¹‰äº† JVM åœ¨è¿è¡Œæ—¶å¦‚ä½•åˆ†åŒºå­˜å‚¨ç¨‹åºæ•°æ®ï¼Œå°±æ¯”å¦‚è¯´å †ä¸»è¦ç”¨äºå­˜æ”¾å¯¹è±¡å®ä¾‹ã€‚
 *  Java å†…å­˜æ¨¡å‹å’Œ Java çš„å¹¶å‘ç¼–ç¨‹ç›¸å…³ï¼ŒæŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»å°±æ¯”å¦‚è¯´çº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å¿…é¡»å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œè§„å®šäº†ä» Java æºä»£ç åˆ° CPU å¯æ‰§è¡ŒæŒ‡ä»¤çš„è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹è¦éµå®ˆå“ªäº›å’Œå¹¶å‘ç›¸å…³çš„åŸåˆ™å’Œè§„èŒƒï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¢å¼ºç¨‹åºå¯ç§»æ¤æ€§çš„ã€‚

### happens-before åŸåˆ™æ˜¯ä»€ä¹ˆï¼Ÿ ###

happens-before è¿™ä¸ªæ¦‚å¿µæœ€æ—©è¯ç”Ÿäº Leslie Lamport äº 1978 å¹´å‘è¡¨çš„è®ºæ–‡[ã€ŠTimeï¼ŒClocks and the Ordering of Events in a Distributed Systemã€‹][Time_Clocks and the Ordering of Events in a Distributed System]ã€‚åœ¨è¿™ç¯‡è®ºæ–‡ä¸­ï¼ŒLeslie Lamport æå‡ºäº†[é€»è¾‘æ—¶é’Ÿ][Link 1]çš„æ¦‚å¿µï¼Œè¿™ä¹Ÿæˆäº†ç¬¬ä¸€ä¸ªé€»è¾‘æ—¶é’Ÿç®—æ³• ã€‚åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œé€šè¿‡ä¸€ç³»åˆ—è§„åˆ™æ¥å®šä¹‰é€»è¾‘æ—¶é’Ÿçš„å˜åŒ–ï¼Œä»è€Œèƒ½é€šè¿‡é€»è¾‘æ—¶é’Ÿæ¥å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„äº‹ä»¶çš„å…ˆåé¡ºåºè¿›è¡Œåˆ¤æ–­ã€‚**é€»è¾‘æ—¶é’Ÿå¹¶ä¸åº¦é‡æ—¶é—´æœ¬èº«ï¼Œä»…åŒºåˆ†äº‹ä»¶å‘ç”Ÿçš„å‰åé¡ºåºï¼Œå…¶æœ¬è´¨å°±æ˜¯å®šä¹‰äº†ä¸€ç§ happens-before å…³ç³»ã€‚**

ä¸Šé¢æåˆ°çš„ happens-before è¿™ä¸ªæ¦‚å¿µè¯ç”Ÿçš„èƒŒæ™¯å¹¶ä¸æ˜¯é‡ç‚¹ï¼Œç®€å•äº†è§£å³å¯ã€‚

JSR 133 å¼•å…¥äº† happens-before è¿™ä¸ªæ¦‚å¿µæ¥æè¿°ä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦ happens-before åŸåˆ™ï¼Ÿ** happens-before åŸåˆ™çš„è¯ç”Ÿæ˜¯ä¸ºäº†ç¨‹åºå‘˜å’Œç¼–è¯‘å™¨ã€å¤„ç†å™¨ä¹‹é—´çš„å¹³è¡¡ã€‚ç¨‹åºå‘˜è¿½æ±‚çš„æ˜¯æ˜“äºç†è§£å’Œç¼–ç¨‹çš„å¼ºå†…å­˜æ¨¡å‹ï¼Œéµå®ˆæ—¢å®šè§„åˆ™ç¼–ç å³å¯ã€‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨è¿½æ±‚çš„æ˜¯è¾ƒå°‘çº¦æŸçš„å¼±å†…å­˜æ¨¡å‹ï¼Œè®©å®ƒä»¬å°½å·±æ‰€èƒ½åœ°å»ä¼˜åŒ–æ€§èƒ½ï¼Œè®©æ€§èƒ½æœ€å¤§åŒ–ã€‚happens-before åŸåˆ™çš„è®¾è®¡æ€æƒ³å…¶å®éå¸¸ç®€å•ï¼š

 *  ä¸ºäº†å¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨çš„çº¦æŸå°½å¯èƒ½å°‘ï¼Œåªè¦ä¸æ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœï¼ˆå•çº¿ç¨‹ç¨‹åºå’Œæ­£ç¡®æ‰§è¡Œçš„å¤šçº¿ç¨‹ç¨‹åºï¼‰ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨æ€ä¹ˆè¿›è¡Œé‡æ’åºä¼˜åŒ–éƒ½è¡Œã€‚
 *  å¯¹äºä¼šæ”¹å˜ç¨‹åºæ‰§è¡Œç»“æœçš„é‡æ’åºï¼ŒJMM è¦æ±‚ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¿…é¡»ç¦æ­¢è¿™ç§é‡æ’åºã€‚

ä¸‹é¢è¿™å¼ æ˜¯ ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹è¿™æœ¬ä¹¦ä¸­çš„ä¸€å¼  JMM è®¾è®¡æ€æƒ³çš„ç¤ºæ„å›¾ï¼Œéå¸¸æ¸…æ™°ã€‚

![ç¬‘å°æ«-www.xiaoxiaofeng.com](https://image.xiaoxiaofeng.site/spider/2024/11/21/xxf-1732157408028.png)

äº†è§£äº† happens-before åŸåˆ™çš„è®¾è®¡æ€æƒ³ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ JSR-133 å¯¹ happens-before åŸåˆ™çš„å®šä¹‰ï¼š

 *  å¦‚æœä¸€ä¸ªæ“ä½œ happens-before å¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœå°†å¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚
 *  ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨ happens-before å…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€ Java å¹³å°çš„å…·ä½“å®ç°å¿…é¡»è¦æŒ‰ç…§ happens-before å…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚å¦‚æœé‡æ’åºä¹‹åçš„æ‰§è¡Œç»“æœï¼Œä¸æŒ‰ happens-before å…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆ JMM ä¹Ÿå…è®¸è¿™æ ·çš„é‡æ’åºã€‚

æˆ‘ä»¬çœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š

```java
int userNum = getUserNum();   // 1
int teacherNum = getTeacherNum();   // 2
int totalNum = userNum + teacherNum;  // 3
```

 *  1 happens-before 2
 *  2 happens-before 3
 *  1 happens-before 3

è™½ç„¶ 1 happens-before 2ï¼Œä½†å¯¹ 1 å’Œ 2 è¿›è¡Œé‡æ’åºä¸ä¼šå½±å“ä»£ç çš„æ‰§è¡Œç»“æœï¼Œæ‰€ä»¥ JMM æ˜¯å…è®¸ç¼–è¯‘å™¨å’Œå¤„ç†å™¨æ‰§è¡Œè¿™ç§é‡æ’åºçš„ã€‚ä½† 1 å’Œ 2 å¿…é¡»æ˜¯åœ¨ 3 æ‰§è¡Œä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯è¯´ 1,2 happens-before 3 ã€‚

**happens-before åŸåˆ™è¡¨è¾¾çš„æ„ä¹‰å…¶å®å¹¶ä¸æ˜¯ä¸€ä¸ªæ“ä½œå‘ç”Ÿåœ¨å¦å¤–ä¸€ä¸ªæ“ä½œçš„å‰é¢ï¼Œè™½ç„¶è¿™ä»ç¨‹åºå‘˜çš„è§’åº¦ä¸Šæ¥è¯´ä¹Ÿå¹¶æ— å¤§ç¢ã€‚æ›´å‡†ç¡®åœ°æ¥è¯´ï¼Œå®ƒæ›´æƒ³è¡¨è¾¾çš„æ„ä¹‰æ˜¯å‰ä¸€ä¸ªæ“ä½œçš„ç»“æœå¯¹äºåä¸€ä¸ªæ“ä½œæ˜¯å¯è§çš„ï¼Œæ— è®ºè¿™ä¸¤ä¸ªæ“ä½œæ˜¯å¦åœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œã€‚**

ä¸¾ä¸ªä¾‹å­ï¼šæ“ä½œ 1 happens-before æ“ä½œ 2ï¼Œå³ä½¿æ“ä½œ 1 å’Œæ“ä½œ 2 ä¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒJMM ä¹Ÿä¼šä¿è¯æ“ä½œ 1 çš„ç»“æœå¯¹æ“ä½œ 2 æ˜¯å¯è§çš„ã€‚

### happens-before å¸¸è§è§„åˆ™æœ‰å“ªäº›ï¼Ÿè°ˆè°ˆä½ çš„ç†è§£ï¼Ÿ ###

happens-before çš„è§„åˆ™å°± 8 æ¡ï¼Œè¯´å¤šä¸å¤šï¼Œé‡ç‚¹äº†è§£ä¸‹é¢åˆ—ä¸¾çš„ 5 æ¡å³å¯ã€‚å…¨è®°æ˜¯ä¸å¯èƒ½çš„ï¼Œå¾ˆå¿«å°±å¿˜è®°äº†ï¼Œæ„ä¹‰ä¸å¤§ï¼Œéšæ—¶æŸ¥é˜…å³å¯ã€‚

1.  **ç¨‹åºé¡ºåºè§„åˆ™**ï¼šä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§ä»£ç é¡ºåºï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œ happens-before äºä¹¦å†™åœ¨åé¢çš„æ“ä½œï¼›
2.  **è§£é”è§„åˆ™**ï¼šè§£é” happens-before äºåŠ é”ï¼›
3.  **volatile å˜é‡è§„åˆ™**ï¼šå¯¹ä¸€ä¸ª volatile å˜é‡çš„å†™æ“ä½œ happens-before äºåé¢å¯¹è¿™ä¸ª volatile å˜é‡çš„è¯»æ“ä½œã€‚è¯´ç™½äº†å°±æ˜¯å¯¹ volatile å˜é‡çš„å†™æ“ä½œçš„ç»“æœå¯¹äºå‘ç”Ÿäºå…¶åçš„ä»»ä½•æ“ä½œéƒ½æ˜¯å¯è§çš„ã€‚
4.  **ä¼ é€’è§„åˆ™**ï¼šå¦‚æœ A happens-before Bï¼Œä¸” B happens-before Cï¼Œé‚£ä¹ˆ A happens-before Cï¼›
5.  **çº¿ç¨‹å¯åŠ¨è§„åˆ™**ï¼šThread å¯¹è±¡çš„ `start()`æ–¹æ³• happens-before äºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚

å¦‚æœä¸¤ä¸ªæ“ä½œä¸æ»¡è¶³ä¸Šè¿°ä»»æ„ä¸€ä¸ª happens-before è§„åˆ™ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ“ä½œå°±æ²¡æœ‰é¡ºåºçš„ä¿éšœï¼ŒJVM å¯ä»¥å¯¹è¿™ä¸¤ä¸ªæ“ä½œè¿›è¡Œé‡æ’åºã€‚

### happens-before å’Œ JMM ä»€ä¹ˆå…³ç³»ï¼Ÿ ###

happens-before ä¸ JMM çš„å…³ç³»ç”¨ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹è¿™æœ¬ä¹¦ä¸­çš„ä¸€å¼ å›¾å°±å¯ä»¥éå¸¸å¥½çš„è§£é‡Šæ¸…æ¥šã€‚

![ç¬‘å°æ«-www.xiaoxiaofeng.com](https://image.xiaoxiaofeng.site/spider/2024/11/21/xxf-1732157408499.png) 

## å†çœ‹å¹¶å‘ç¼–ç¨‹ä¸‰ä¸ªé‡è¦ç‰¹æ€§ ##

### åŸå­æ€§ ###

ä¸€æ¬¡æ“ä½œæˆ–è€…å¤šæ¬¡æ“ä½œï¼Œè¦ä¹ˆæ‰€æœ‰çš„æ“ä½œå…¨éƒ¨éƒ½å¾—åˆ°æ‰§è¡Œå¹¶ä¸”ä¸ä¼šå—åˆ°ä»»ä½•å› ç´ çš„å¹²æ‰°è€Œä¸­æ–­ï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡Œã€‚

åœ¨ Java ä¸­ï¼Œå¯ä»¥å€ŸåŠ©`synchronized`ã€å„ç§ `Lock` ä»¥åŠå„ç§åŸå­ç±»å®ç°åŸå­æ€§ã€‚

`synchronized` å’Œå„ç§ `Lock` å¯ä»¥ä¿è¯ä»»ä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®è¯¥ä»£ç å—ï¼Œå› æ­¤å¯ä»¥ä¿éšœåŸå­æ€§ã€‚å„ç§åŸå­ç±»æ˜¯åˆ©ç”¨ CAS (compare and swap) æ“ä½œï¼ˆå¯èƒ½ä¹Ÿä¼šç”¨åˆ° `volatile`æˆ–è€…`final`å…³é”®å­—ï¼‰æ¥ä¿è¯åŸå­æ“ä½œã€‚

### å¯è§æ€§ ###

å½“ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå¦å¤–çš„çº¿ç¨‹éƒ½æ˜¯ç«‹å³å¯ä»¥çœ‹åˆ°ä¿®æ”¹åçš„æœ€æ–°å€¼ã€‚

åœ¨ Java ä¸­ï¼Œå¯ä»¥å€ŸåŠ©`synchronized`ã€`volatile` ä»¥åŠå„ç§ `Lock` å®ç°å¯è§æ€§ã€‚

å¦‚æœæˆ‘ä»¬å°†å˜é‡å£°æ˜ä¸º `volatile` ï¼Œè¿™å°±æŒ‡ç¤º JVMï¼Œè¿™ä¸ªå˜é‡æ˜¯å…±äº«ä¸”ä¸ç¨³å®šçš„ï¼Œæ¯æ¬¡ä½¿ç”¨å®ƒéƒ½åˆ°ä¸»å­˜ä¸­è¿›è¡Œè¯»å–ã€‚

### æœ‰åºæ€§ ###

ç”±äºæŒ‡ä»¤é‡æ’åºé—®é¢˜ï¼Œä»£ç çš„æ‰§è¡Œé¡ºåºæœªå¿…å°±æ˜¯ç¼–å†™ä»£ç æ—¶å€™çš„é¡ºåºã€‚

æˆ‘ä»¬ä¸Šé¢è®²é‡æ’åºçš„æ—¶å€™ä¹Ÿæåˆ°è¿‡ï¼š

> **æŒ‡ä»¤é‡æ’åºå¯ä»¥ä¿è¯ä¸²è¡Œè¯­ä¹‰ä¸€è‡´ï¼Œä½†æ˜¯æ²¡æœ‰ä¹‰åŠ¡ä¿è¯å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¹Ÿä¸€è‡´** ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹ï¼ŒæŒ‡ä»¤é‡æ’åºå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚

åœ¨ Java ä¸­ï¼Œ`volatile` å…³é”®å­—å¯ä»¥ç¦æ­¢æŒ‡ä»¤è¿›è¡Œé‡æ’åºä¼˜åŒ–ã€‚

## æ€»ç»“ ##

 *  Java æ˜¯æœ€æ—©å°è¯•æä¾›å†…å­˜æ¨¡å‹çš„è¯­è¨€ï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¢å¼ºç¨‹åºå¯ç§»æ¤æ€§çš„ã€‚
 *  CPU å¯ä»¥é€šè¿‡åˆ¶å®šç¼“å­˜ä¸€è‡´åè®®ï¼ˆæ¯”å¦‚ [MESI åè®®][MESI]ï¼‰æ¥è§£å†³å†…å­˜ç¼“å­˜ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚
 *  ä¸ºäº†æå‡æ‰§è¡Œé€Ÿåº¦/æ€§èƒ½ï¼Œè®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºä»£ç çš„æ—¶å€™ï¼Œä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºã€‚ ç®€å•æ¥è¯´å°±æ˜¯ç³»ç»Ÿåœ¨æ‰§è¡Œä»£ç çš„æ—¶å€™å¹¶ä¸ä¸€å®šæ˜¯æŒ‰ç…§ä½ å†™çš„ä»£ç çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚**æŒ‡ä»¤é‡æ’åºå¯ä»¥ä¿è¯ä¸²è¡Œè¯­ä¹‰ä¸€è‡´ï¼Œä½†æ˜¯æ²¡æœ‰ä¹‰åŠ¡ä¿è¯å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¹Ÿä¸€è‡´** ï¼Œæ‰€ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹ï¼ŒæŒ‡ä»¤é‡æ’åºå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚
 *  ä½ å¯ä»¥æŠŠ JMM çœ‹ä½œæ˜¯ Java å®šä¹‰çš„å¹¶å‘ç¼–ç¨‹ç›¸å…³çš„ä¸€ç»„è§„èŒƒï¼Œé™¤äº†æŠ½è±¡äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„å…³ç³»ä¹‹å¤–ï¼Œå…¶è¿˜è§„å®šäº†ä» Java æºä»£ç åˆ° CPU å¯æ‰§è¡ŒæŒ‡ä»¤çš„è¿™ä¸ªè½¬åŒ–è¿‡ç¨‹è¦éµå®ˆå“ªäº›å’Œå¹¶å‘ç›¸å…³çš„åŸåˆ™å’Œè§„èŒƒï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ç®€åŒ–å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå¢å¼ºç¨‹åºå¯ç§»æ¤æ€§çš„ã€‚
 *  JSR 133 å¼•å…¥äº† happens-before è¿™ä¸ªæ¦‚å¿µæ¥æè¿°ä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚




[issue_1848]: https://github.com/Snailclimb/JavaGuide/issues/1848
[CPU]: https://oss.javaguide.cn/github/javaguide/java/concurrent/cpu-cache.png
[MESI]: https://zh.wikipedia.org/wiki/MESI%E5%8D%8F%E8%AE%AE
[cpu-cache-protocol.png]: https://oss.javaguide.cn/github/javaguide/java/concurrent/cpu-cache-protocol.png
[JSR-133_Java Memory Model and Thread Specification]: http://www.cs.umd.edu/~pugh/java/memoryModel/CommunityReview.pdf
[JMM_Java]: https://oss.javaguide.cn/github/javaguide/java/concurrent/jmm.png
[Time_Clocks and the Ordering of Events in a Distributed System]: https://lamport.azurewebsites.net/pubs/time-clocks.pdf
[Link 1]: https://writings.sh/post/logical-clocks
[image-20220731155332375.png]: https://oss.javaguide.cn/github/javaguide/java/concurrent/image-20220731155332375.png
[happens-before _ JMM]: https://oss.javaguide.cn/github/javaguide/java/concurrent/image-20220731084604667.png
[JavaGuide]: https://oss.javaguide.cn/github/javaguide/gongzhonghaoxuanchuan.png