<div class="content-intro view-box markdown-body editormd-preview-container"><h3>简介</h3>
<p>Mycat2支持常用的(自动)<code>HASH</code>型分片算法也兼容<code>1.6</code>的内置的(<code>cobar</code>)分片算法.</p>
<p>
<code>HASH</code>型分片算法默认要求集群名字以<code>c</code>为前缀,数字为后缀,<code>c0</code>就是分片表第一个节点,<code>c1</code>就是第二个节点.该命名规则允许用户手动改变.</p>
<p></p>
<h3>区别</h3>
<p>Mycat2 <code>Hash</code>型分片算法多数基于<code>MOD_HASH(MOD</code>对应<code>JAVA</code>的<code>%</code>运算,实际上是取余运算,而且<code>abs(n)/count等价于abs(n/count)</code></p>
<p>
Mycat2 <code>Hash</code>型分片算法对于值的处理,总是把分片值转换到列属性的数据类型再运算,而<code>1.x</code>系列的分片算法统一转换到字符串类型再运算且只能根据一个分片字段计算出存储节点下标。</p>
<p>
Mycat2 <code>Hash</code>型分片算法适用于等价条件查询，而<code>1.x</code>系列由于含有用户经验的路由规则。</p>
<table class="xhe-table">
<thead>
<tr>
<th style="text-align: center;">分片算法</th>
<th style="text-align: center;">描述</th>
<th style="text-align: center;">分库</th>
<th style="text-align: center;">分表</th>
<th style="text-align: center;">数值类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">MOD_HASH</td>
<td style="text-align: center;">取模哈希</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">数值，字符串</td>
</tr>
<tr>
<td style="text-align: center;">UNI_HASH</td>
<td style="text-align: center;">取模哈希</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">数值，字符串</td>
</tr>
<tr>
<td style="text-align: center;">RIGHT_SHIFT</td>
<td style="text-align: center;">右移哈希</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">数值</td>
</tr>
<tr>
<td style="text-align: center;">RANGE_HASH</td>
<td style="text-align: center;">两字段其一取模</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">数值，字符串</td>
</tr>
<tr>
<td style="text-align: center;">YYYYMM</td>
<td style="text-align: center;">按年月哈希</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">DATE，DATETIME</td>
</tr>
<tr>
<td style="text-align: center;">YYYYDD</td>
<td style="text-align: center;">按年月哈希</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">DATE，DATETIME</td>
</tr>
<tr>
<td style="text-align: center;">YYYYWEEK</td>
<td style="text-align: center;">按年周哈希</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">DATE，DATETIME</td>
</tr>
<tr>
<td style="text-align: center;">HASH</td>
<td style="text-align: center;">取模哈希</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">数值，字符串，如果不是，则转换成字符串</td>
</tr>
<tr>
<td style="text-align: center;">MM</td>
<td style="text-align: center;">按月哈希</td>
<td style="text-align: center;">否</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">DATE，DATETIME</td>
</tr>
<tr>
<td style="text-align: center;">DD</td>
<td style="text-align: center;">按日期哈希</td>
<td style="text-align: center;">否</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">DATE，DATETIME</td>
</tr>
<tr>
<td style="text-align: center;">MMDD</td>
<td style="text-align: center;">按月日哈希</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">DATE，DATETIME</td>
</tr>
<tr>
<td style="text-align: center;">WEEK</td>
<td style="text-align: center;">按周哈希</td>
<td style="text-align: center;">否</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">DATE，DATETIME</td>
</tr>
<tr>
<td style="text-align: center;">STR_HASH</td>
<td style="text-align: center;">字符串哈希</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">是</td>
<td style="text-align: center;">字符串</td>
</tr>
</tbody>
</table>
<p>
所有分片算法都可以用于分表，但是涉及单独按周、月的<code>HASH</code>算法不能用于分库</p>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><code class="hljs"><span class="pln"> </span><span class="com">/*+ mycat:createTable{</span></code></li><li class="L1"><code class="hljs javascript"><span class="com">    <span class="hljs-string">"schemaName"</span>:<span class="hljs-string">"db1"</span>,</span></code></li><li class="L2"><code class="hljs javascript"><span class="com">    <span class="hljs-string">"shadingTable"</span>:{</span></code></li><li class="L3"><code class="hljs"></code></li><li class="L4"><code class="hljs"><span class="com">  </span></code></li><li class="L5"><code class="hljs sql"><span class="com">"createTableSQL":"<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> travelrecord(<span class="hljs-keyword">id</span> <span class="hljs-built_in">int</span>)<span class="hljs-string">",</span></span></code></li><li class="L6"><code class="hljs"></code></li><li class="L7"><code class="hljs"><span class="com">    </span></code></li><li class="L8"><code class="hljs javascript"><span class="com"><span class="hljs-string">"function"</span>:{</span></code></li><li class="L9"><code class="hljs javascript"><span class="com">                <span class="hljs-string">"properties"</span>:{</span></code></li><li class="L0"><code class="hljs javascript"><span class="com">                    <span class="hljs-string">"dbNum"</span>:<span class="hljs-number">2</span>,</span></code></li><li class="L1"><code class="hljs bash"><span class="com">                    <span class="hljs-string">"mappingFormat"</span>:<span class="hljs-string">"c<span class="hljs-variable">${targetIndex}</span>/db1_<span class="hljs-variable">${dbIndex}</span>/travelrecord_<span class="hljs-variable">${tableIndex}</span>"</span>,</span></code></li><li class="L2"><code class="hljs javascript"><span class="com">                    <span class="hljs-string">"tableNum"</span>:<span class="hljs-number">2</span>,</span></code></li><li class="L3"><code class="hljs javascript"><span class="com">                    <span class="hljs-string">"tableMethod"</span>:<span class="hljs-string">"mod_hash(id)"</span>,</span></code></li><li class="L4"><code class="hljs javascript"><span class="com">                    <span class="hljs-string">"storeNum"</span>:<span class="hljs-number">2</span>,</span></code></li><li class="L5"><code class="hljs javascript"><span class="com">                    <span class="hljs-string">"dbMethod"</span>:<span class="hljs-string">"mod_hash(id)"</span></span></code></li><li class="L6"><code class="hljs"><span class="com">                }</span></code></li><li class="L7"><code class="hljs"><span class="com">            }</span></code></li><li class="L8"><code class="hljs"><span class="com">    },</span></code></li><li class="L9"><code class="hljs javascript"><span class="com">    <span class="hljs-string">"tableName"</span>:<span class="hljs-string">"travelrecord"</span></span></code></li><li class="L0"><code class="hljs"><span class="com">} */</span><span class="pun">;</span></code></li></ol></pre>
<p><code>mappingFormat</code>使用样例(文件配置)</p>
<pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><code class="hljs javascript"><span class="pln">    </span><span class="str"><span class="hljs-string">"shardingTables"</span></span><span class="pun">:{</span></code></li><li class="L1"><code class="hljs javascript"><span class="pln">        </span><span class="str"><span class="hljs-string">"log"</span></span><span class="pun">:{</span></code></li><li class="L2"><code class="hljs sql"><span class="pln">            </span><span class="str">"createTableSQL"</span><span class="pun">:</span><span class="str">"<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> cloud.log (\n\t<span class="hljs-string">`id`</span> <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,\n\t<span class="hljs-string">`user_id`</span> <span class="hljs-built_in">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,\n\t<span class="hljs-string">`service_id`</span> <span class="hljs-built_in">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>,\n\t<span class="hljs-string">`submit_time`</span> DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">NULL</span>\n) <span class="hljs-keyword">ENGINE</span> = <span class="hljs-keyword">INNODB</span> <span class="hljs-keyword">CHARSET</span> = utf8\nDBPARTITION <span class="hljs-keyword">BY</span> YYYYDD(submit_time) DBPARTITIONS <span class="hljs-number">2</span>\nTBPARTITION <span class="hljs-keyword">BY</span> MOD_HASH(<span class="hljs-keyword">id</span>) TBPARTITIONS <span class="hljs-number">8</span><span class="hljs-string">"</span></span><span class="pun"><span class="hljs-string">,</span></span></code></li><li class="L3"><code class="hljs javascript"><span class="pln">            </span><span class="str"><span class="hljs-string">"function"</span></span><span class="pun">:{</span></code></li><li class="L4"><code class="hljs javascript"><span class="pln">                </span><span class="str"><span class="hljs-string">"properties"</span></span><span class="pun">:{</span></code></li><li class="L5"><code class="hljs javascript"><span class="pln">                    </span><span class="str"><span class="hljs-string">"dbNum"</span></span><span class="pun">:</span><span class="str"><span class="hljs-string">"2"</span></span><span class="pun">,</span></code></li><li class="L6"><code class="hljs bash"><span class="pln">                    </span><span class="str"><span class="hljs-string">"mappingFormat"</span></span><span class="pun">:</span><span class="str"><span class="hljs-string">"c<span class="hljs-variable">${targetIndex}</span>/cloud_<span class="hljs-variable">${java.time.LocalDate.now().plus(dbIndex.toInteger()).toString().replace(\"-\",\"\")}</span>/log_<span class="hljs-variable">${tableIndex}</span>"</span></span><span class="pun">,</span></code></li><li class="L7"><code class="hljs javascript"><span class="pln">                    </span><span class="str"><span class="hljs-string">"tableNum"</span></span><span class="pun">:</span><span class="str"><span class="hljs-string">"8"</span></span><span class="pun">,</span></code></li><li class="L8"><code class="hljs javascript"><span class="pln">                    </span><span class="str"><span class="hljs-string">"tableMethod"</span></span><span class="pun">:</span><span class="str"><span class="hljs-string">"MOD_HASH(id)"</span></span><span class="pun">,</span></code></li><li class="L9"><code class="hljs javascript"><span class="pln">                    </span><span class="str"><span class="hljs-string">"storeNum"</span></span><span class="pun">:</span><span class="lit"><span class="hljs-number">2</span></span><span class="pun">,</span></code></li><li class="L0"><code class="hljs javascript"><span class="pln">                    </span><span class="str"><span class="hljs-string">"dbMethod"</span></span><span class="pun">:</span><span class="str"><span class="hljs-string">"YYYYDD(submit_time)"</span></span></code></li><li class="L1"><code class="hljs"><span class="pln">                </span><span class="pun">}</span></code></li><li class="L2"><code class="hljs"><span class="pln">            </span><span class="pun">}</span></code></li><li class="L3"><code class="hljs"><span class="pln">        </span><span class="pun">}</span></code></li><li class="L4"><code class="hljs"><span class="pln">    </span><span class="pun">}</span></code></li></ol></pre>
<p><img src="https://atts.w3cschool.cn/attachments/day_210908/202109081337223630.png" alt=""></p>
<ul>
<li><code>targetIndex</code>是目标下标</li>
<li><code>tableIndex</code>是物理分表下标</li>
<li><code>dbIndex</code>是物理分库下标</li>
<li><code>index</code>是总物理分表下标</li>
</ul></div>