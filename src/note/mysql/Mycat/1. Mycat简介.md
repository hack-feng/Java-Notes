## 1. 什么是Mycat

 **什么是Mycat**

Mycat是数据库中间件，所谓中间件数据库中间件是连接Java应用程序和数据库中间的软件。

![image-20231113173526543](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113173526.png?xxfjava)

**为什么要用Mycat** 

![image-20231113175609542](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175609.png?xxfjava)

> **遇到问题：**
> 
>  *  Java与数据库的紧耦合
>  *  高访问量高并发对数据库的压力
>  *  读写请求数据不一致

## 2. Mycat与其他中间件区别

![image-20231113175008856](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175008.png?xxfjava)

目前的数据库中间件有很多，并从各个维度将其与 Mycat进行对比。

**Mycat优势**

![image-20231113175224220](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175224.png?xxfjava)

**性能可靠稳定** 

基于阿里开源的Cobar产品而研发，Cobar的稳定性、可靠性、优秀 的架构和性能以及众多成熟的使用 案例使得MYCAT一开始就拥有一 个很好的起点，站在巨人的肩膀上，我们能看到更远。

**强大的技术团队** 

MyCat现在由一支强大的技术团队维护 , 吸引和聚集了一大批业内 大数据和云计算方面的资深工程师、架构师、DBA，优秀的团队保 障了MyCat的稳定高效运行。而且MyCat不依托于任何商业公司， 而且得到大批开源爱好者的支持。

 **体系完善**

MyCat已经形成了一系列的周边产品,比较有名的是 Mycat-web、 Mycat-NIO、Mycat-Balance 等,已经形成了一个比较完整的解决方 案,而不仅仅是一个中间件。

## 3. Mycat应用场景

![image-20231113175049471](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175049.png?xxfjava)

Mycat还形成了一系列周边产品，比较有名的是 Mycat-web、 Mycat-NIO、Mycat-Balance等，已成为一个比较完整的数据处理 解决方案，而不仅仅是中间件。

**高可用性与MySQL读写分离** 

利用Mycat可以轻松实现热备份，当一台服务器停机时，可以由双 机或集群中的另一台服务器自动接管其业务，从而在无须人工干预的情况下，保证系统持续提供服务。这个切换动作由Mycat自动完成。

![image-20231113175146091](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175146.png?xxfjava)

注意： Mycat 的读写分离及自动切换都依赖于数据库产品的主从数据同步。

**百亿大表水平分表、集群并行计算** 

数据切分是Mycat的核心功能，是指通过某种特定的条件，将存放在同一个数据库中的数据分散存放在多个数据库（主机）中，以达到分散单台设备负载的效果。

![image-20231113175303968](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175304.png?xxfjava)

> **数据切分有两种切分模式**
> 
>  *  按照不同的表将数据切分到不同的数据库中，这种切分可以叫作数据的垂直切分。
>  *  根据表中数据的逻辑关系，将同一个表中的数据按照某种条件拆分到多个数据库中，这种切 分叫作数据的水平切分。当数据量超过800万行且需要做分片时，可以利用Mycat实现数据切 分。

**数据库路由器** 

Mycat基于MySQL 实例的连接池复用机制，可以让每个应用最大程度地共享一个MySQL实例的所有连接池，让数据库的并发访问能力大大提升。

 **整合多种数据源**

当一个项目需要用到多种数据源如Oracle、MySQL、SQL Server、 PostgreSQL时，可以利用Mycat进行整合，只需访问Mycat 这一个 数据源就行。

![image-20231113175321838](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175321.png?xxfjava)

## 4. 核心概念详解

![image-20231113175343303](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175343.png?xxfjava)

**逻辑库schema** 

业务开发人员通常在实际应用中并不需要知道中间件的存在，只需 要关注数据库，所以数据库中间件可以被当作一个或多个数据库集 群构成的逻辑库。

![image-20231113175421169](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175421.png?xxfjava)

> **注意：**
> 
> 逻辑库，与MySQL中的Database（数据库）对应，⼀个逻辑库中定义了所包括的Table。

**逻辑表table** 

既然有逻辑库，就会有逻辑表。在分布式数据库中，对于应用来说，读写数据的表就是逻辑表。逻辑表可以分布在一个或多个分片库中，也可以不分片。

![image-20231113175635716](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175635.png?xxfjava)

> **注意：**
> 
> Table：表，即物理数据库中存储的某⼀张表，与传统数据库不同，这⾥的表格需要声明其所存储的逻辑数据节点DataNode。

**节点主机DataNode** 

将数据切分后，每个分片节点不一定会独占一台机器，同一台机器上可以有多个分片数据库，这样一个或多个分片节点所在的机器就是节点主机。为了规避单节点主机并发数量的限制,尽量将读写压力高的分片节点均匀地放在不同的节点主机上。

![image-20231113175659168](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175659.png?xxfjava)

**数据库主机DataHost** 

数据切分后，每个分片节点(dataNode)不一定都会独占一台机器， 同一机器上面可以有多个分片数据库，这样一个或多个分片节点 (dataNode)所在的机器就是节点主机(dataHost),为了规避单节点主 机并发数限制，尽量将读写压力高的分片节点(dataNode)均衡的放 在不同的节点主机(dataHost)。

**用户**

MyCat的用户(类似于MySQL的用户，支持多用户）

![image-20231113175709775](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175709.png?xxfjava)

## 5. Mycat原理

![image-20231113175833663](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175833.png?xxfjava)

Mycat 的原理中最重要的一个动词是“拦截”，它拦截了用户发送过来的SQL 语句。

![image-20231113175931299](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175931.png?xxfjava)

> 流程： 首先对 SQL 语句做了一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此 SQL 发 往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。

流程示例

![image-20231113175816845](https://image.xiaoxiaofeng.site/blog/2023/11/13/xxf-20231113175816.png?xxfjava)

> 1 解析SQL语句涉及的表。
>
> 2 查看表的定义，如果表存在分片规则，则获取SQL语句的分片字段。
>
> 3 将SQL语句发送到相应的分片去执行。
>
> 4 最后处理所有分片返回的数据并返回给客户端。

## 6. Mycat1.x与Mycat2功能对比

| 功能                                     | 1.6                            | 2                                  |
| ---------------------------------------- | ------------------------------ | ---------------------------------- |
| 多语句                                   | 不支持                         | 支持                               |
| blob值                                   | 支持一部分                     | 支持                               |
| 全局二级索引                             | 不支持                         | 支持                               |
| 任意跨库join(包含复杂查询)               | catlet支持                     | 支持                               |
| 分片表与分片表JOIN查询                   | ER表支持                       | 支持                               |
| 关联子查询                               | 不支持                         | 支持一部分                         |
| 分库同时分表                             | 不支持                         | 支持                               |
| 存储过程                                 | 支持固定形式的                 | 支持更多                           |
| 支持逻辑视图                             | 不支持                         | 支持                               |
| 支持物理视图                             | 支持                           | 支持                               |
| 批量插入                                 | 不支持                         | 支持                               |
| 执行计划管理                             | 不支持                         | 支持                               |
| 路由注释                                 | 支持                           | 支持                               |
| 集群功能                                 | 支持                           | 支持更多集群类型                   |
| 自动hash分片算法                         | 不支持                         | 支持                               |
| 支持第三方监控                           | 支持mycat-web                  | 支持普罗米斯,kafka日志等监控       |
| 流式合拼结果集                           | 支持                           | 支持                               |
| 范围查询                                 | 支持                           | 支持                               |
| 单表映射物理表                           | 不支持                         | 支持                               |
| XA事务                                   | 弱XA                           | 支持,事务自动恢复                  |
| 支持MySQL8                               | 需要更改mysql8的服务器配置支持 | 支持                               |
| 虚拟表                                   | 不支持                         | 支持                               |
| joinClustering                           | 不支持                         | 支持                               |
| union all语法                            | 不支持                         | 支持                               |
| BKAJoin                                  | 不支持                         | 支持                               |
| 优化器注释                               | 不支持                         | 支持                               |
| ER表                                     | 支持                           | 支持                               |
| 全局序列号                               | 支持                           | 支持                               |
| 保存点                                   | 不支持                         | 支持                               |
| 离线迁移                                 | 支持                           | 支持（实验）                       |
| 增量迁移                                 | CRC32算法支持                  | BINLOG追平（实验）                 |
| 安全停机                                 | 不支持                         | 支持（实验）                       |
| HAProxy协议                              | 不支持                         | 支持                               |
| 会话粘滞                                 | update后select会粘滞           | update后select会粘滞且支持设置时间 |
| 全局表插入支持全局序列号                 | 不支持                         | 支持                               |
| 全局表插入支持主表插入自增结果作为序列号 | 不支持                         | 支持                               |
| 外部调用的分片算法                       | 不支持但可定制                 | 支持                               |

## 7. 本系列文章

本系列文章持续更新中，包括Mycat搭建，读写分离，分库分表等，敬请期待。

后续更新完成统一维护链接，占个坑先...

