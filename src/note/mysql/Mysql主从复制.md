## ä¸€ã€æ— èŠçš„ç†è®ºçŸ¥è¯†

MySQLçš„ä¸»ä»å¤åˆ¶å’ŒMySQLçš„è¯»å†™åˆ†ç¦»ä¸¤è€…æœ‰ç€ç´§å¯†è”ç³»ï¼Œé¦–å…ˆè¦éƒ¨ç½²ä¸»ä»å¤åˆ¶ï¼Œåªæœ‰ä¸»ä»å¤åˆ¶å®Œæˆäº†ï¼Œæ‰èƒ½åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ•°æ®çš„è¯»å†™åˆ†ç¦»ã€‚

**ä¸ºä»€ä¹ˆè¦ä¸»ä»å¤åˆ¶** 

> æ³¨æ„ï¼š MySQLæ˜¯ç°åœ¨æ™®éä½¿ç”¨çš„æ•°æ®åº“ï¼Œä½†æ˜¯å¦‚æœå®•æœºäº†å¿…ç„¶ä¼šé€ æˆæ•°æ®ä¸¢å¤±ã€‚ä¸ºäº†ä¿è¯MySQLæ•°æ®åº“çš„å¯é æ€§ã€‚å°±è¦ä¼šä¸€äº›æé«˜å¯é æ€§çš„æŠ€æœ¯ã€‚

**å¦‚ä½•è§£å†³æ€§èƒ½é—®é¢˜** 

ç”Ÿæ´»ä¸­æœ‰å¾ˆå½¢è±¡çš„ä¾‹å­ï¼Œæ¯”å¦‚ä½ å»è¶…å¸‚ä¹°ä¸œè¥¿ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªæ”¶é“¶å°ï¼Œåªå¯ä»¥æ’ä¸€é˜Ÿä¸€æ¬¡ç­‰å¾…ï¼Œå¦‚æœæœ‰å¤šä¸ªæ”¶é“¶å°ï¼Œå°±å¯ä»¥æ’å¤šé˜Ÿï¼Œå¤§å¤§æå‡äº†æ•ˆç‡ã€‚

### 1. ä¸»ä»å¤åˆ¶åŸç†

**mysqlæ”¯æŒçš„å¤åˆ¶ç±»å‹ï¼š**

â‘ STATEMENT:åŸºäºè¯­å¥çš„å¤åˆ¶ï¼Œåœ¨ä¸»æœåŠ¡å™¨ä¸Šæ‰§è¡Œsqlè¯­å¥ï¼Œåœ¨ä»æœåŠ¡å™¨ä¸Šæ‰§è¡ŒåŒæ ·çš„è¯­å¥ï¼ŒMySQLé»˜è®¤é‡‡ç”¨åŸºäºè¯­å¥çš„å¤åˆ¶ï¼Œæ‰§è¡Œæ•ˆç‡é«˜

â‘¡ROW:åŸºäºè¡Œçš„å¤åˆ¶ï¼ŒæŠŠæ”¹å˜çš„å†…å®¹å¤åˆ¶è¿‡å»ï¼Œè€Œä¸æ˜¯æŠŠå‘½ä»¤åœ¨ä»æœåŠ¡å™¨ä¸Šæ‰§è¡Œä¸€è¾¹

â‘¢MIXED:æ··åˆç±»å‹çš„å¤åˆ¶ï¼Œé»˜è®¤é‡‡ç”¨åŸºäºè¯­å¥çš„å¤åˆ¶ï¼Œä¸€æ—¦å‘ç°åŸºäºè¯­å¥æ— æ³•ç²¾ç¡®å¤åˆ¶æ—¶ï¼Œå°±ä¼šé‡‡ç”¨åŸºäºè¡Œçš„å¤åˆ¶

### 2. ä¸»ä»å¤åˆ¶çš„å·¥ä½œè¿‡ç¨‹

ä¸»ä»å¤åˆ¶æ ¸å¿ƒéƒ¨åˆ†å°±æ˜¯ä¸¤ä¸ªæ—¥å¿—ã€ä¸‰ä¸ªçº¿ç¨‹ï¼ˆé«˜ç‰ˆæœ¬çš„mysqlä»¥åŠå¼‚æ­¥å¤åˆ¶ã€åŠåŒæ­¥å¤åˆ¶ã€å…¨åŒæ­¥å¤åˆ¶

æ ¸å¿ƒé‡ç‚¹ï¼šä¸¤ä¸ªæ—¥å¿—æ–‡ä»¶ï¼šäºŒè¿›åˆ¶æ—¥å¿—ã€ä¸­ç»§æ—¥å¿—ã€ä¸‰ä¸ªçº¿ç¨‹ï¼šmasterçš„dump threadã€slaveçš„IOã€SQL

ä¸»è¦åŸç†ï¼šmasterå°†æ•°æ®ä¿å­˜åœ¨äºŒè¿›åˆ¶æ—¥å¿—ä¸­ï¼ŒIOå‘dumpå‘å‡ºåŒæ­¥è¯·æ±‚ï¼ŒdumpæŠŠæ•°æ®å‘é€ç»™IOçº¿ç¨‹ã€‚IOä¼šå†™å…¥åˆ°æœ¬åœ°çš„ä¸­ç»§æ—¥å¿—ï¼ŒSQLçº¿ç¨‹ä¼šè¯»å–æœ¬åœ°çš„æ—¥å¿—æ•°æ®ï¼ŒåŒæ­¥åˆ°è‡ªå·±çš„æ•°æ®åº“ä¸­ï¼Œå®ŒæˆåŒæ­¥

![image-20231113175747700](https://image.xiaoxiaofeng.site/blog/2023/11/15/xxf-20231115165032.png?xxfjava)

â‘ MasterèŠ‚ç‚¹å°†æ•°æ®çš„æ”¹å˜è®°å½•æˆäºŒè¿›åˆ¶æ—¥å¿—(bin log),å½“Masterä¸Šçš„æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œåˆ™å°†å…¶æ”¹å˜å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—ä¸­

â‘¡SlaveèŠ‚ç‚¹ä¼šåœ¨ä¸€å®šæ—¶é—´é—´éš”å†…å¯¹Masterçš„äºŒè¿›åˆ¶æ—¥å¿—è¿›è¡Œæ¢æµ‹å…¶æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼Œå¦‚æœå‘ç”Ÿæ”¹å˜ï¼Œåˆ™å¼€å§‹ä¸€ä¸ªI/Oçº¿ç¨‹è¯·æ±‚Masterçš„äºŒè¿›åˆ¶æ—¶é—´

â‘¢åŒæ—¶MasterèŠ‚ç‚¹ä¸ºæ¯ä¸ªI/Oçº¿ç¨‹å¯åŠ¨ä¸€ä¸ªdumpçº¿ç¨‹ï¼Œç”¨äºå‘å…¶å‘ç”ŸäºŒè¿›åˆ¶äº‹ä»¶ï¼Œå¹¶ä¿å­˜è‡³SlaveèŠ‚ç‚¹æœ¬åœ°çš„ä¸­ç»§æ—¥å¿—(Relay log)ä¸­ï¼ŒSlaveèŠ‚ç‚¹å°†å¯åŠ¨SQLçº¿ç¨‹ä»ä¸­ç»§æ—¥å¿—ä¸­è¯»å–äºŒè¿›åˆ¶æ—¥å¿—ï¼Œåœ¨æœ¬åœ°é‡æ”¾ï¼Œå³è§£ææˆsqlè¯­å¥é€ä¸€æ‰§è¡Œï¼Œä½¿å¾—å…¶æ•°æ®å’ŒMasterèŠ‚ç‚¹çš„ä¿æŒä¸€è‡´ï¼Œæœ€åI/Oçº¿ç¨‹å’ŒSQLçº¿ç¨‹å°†è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è¢«å”¤é†’

**æ³¨ï¼š**ä¸­ç»§æ—¥å¿—é€šå¸¸ä¼šä½äºOSç¼“å­˜ä¸­ï¼Œæ‰€ä»¥ä¸­ç»§æ—¥å¿—çš„å¼€é”€å¾ˆå°

å¤åˆ¶è¿‡ç¨‹æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„é™åˆ¶ï¼Œå³å¤åˆ¶åœ¨Slaveä¸Šæ˜¯ä¸²è¡ŒåŒ–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´Masterä¸Šçš„å¹¶è¡Œæ›´æ–°æ“ä½œä¸èƒ½åœ¨Slaveä¸Šå¹¶è¡Œæ“ä½œ

```
ä¸»MySQLæœåŠ¡å™¨åšçš„å¢åˆ æ”¹æ“ä½œï¼Œéƒ½ä¼šå†™å…¥è‡ªå·±çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆBinary logï¼‰
ç„¶åä»MySQLä»æœåŠ¡å™¨æ‰“å¼€è‡ªå·±çš„I/Oçº¿ç¨‹è¿æ¥ä¸»æœåŠ¡å™¨ï¼Œè¿›è¡Œè¯»å–ä¸»æœåŠ¡å™¨çš„äºŒè¿›åˆ¶æ—¥å¿—
I/Oå»ç›‘å¬äºŒè¿›åˆ¶æ—¥å¿—ï¼Œä¸€æ—¦ç”±æ–°çš„æ•°æ®ï¼Œä¼šå‘èµ·è¯·æ±‚è¿æ¥
è¿™æ—¶å€™ä¼šè§¦å‘dumpçº¿ç¨‹ï¼Œdump threadå“åº”è¯·æ±‚ï¼Œä¼ é€æ•°æ®ç»™I/O(dumpçº¿ç¨‹è¦ä¹ˆå¤„äºç­‰å¾…ï¼Œè¦ä¹ˆå¤„äºç¡çœ çŠ¶æ€)
I/Oæ¥æ”¶åˆ°æ•°æ®ä¹‹åå­˜æ”¾åœ¨ä¸­ç»§æ—¥å¿—
SQL threadçº¿ç¨‹ä¼šè¯»å–ä¸­ç»§æ—¥å¿—é‡Œçš„æ•°æ®ï¼Œå­˜æ”¾åˆ°è‡ªå·±çš„æœåŠ¡å™¨ä¸­

dumpé€šè¿‡TPä¹Ÿå°±æ˜¯ç½‘ç»œçš„æ–¹å¼å‘é€ç»™IO
```

### 3. MySQLå››ç§åŒæ­¥æ–¹å¼

**å¼‚æ­¥å¤åˆ¶(Async Replication)**

ä¸»åº“å°†æ›´æ–°å†™å…¥Binlogæ—¥å¿—æ–‡ä»¶ï¼Œä¸éœ€è¦ç­‰å¾…æ•°æ®æ›´æ–°æ˜¯å¦å·²ç»å¤åˆ¶åˆ°ä»åº“ä¸­ï¼Œå°±å¯ä»¥ç»§ç»­å¤„ç†æ›´å¤šçš„è¯·æ±‚ï¼ŒMasterå°†äº‹ä»¶å†™å…¥binlogï¼Œä½†å¹¶ä¸çŸ¥é“Slaveæ˜¯å¦æˆ–ä½•æ—¶å·²ç»æ¥æ”¶ä¸”å·²å¤„ç†ï¼Œåœ¨å¼‚æ­¥å¤åˆ¶çš„æœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œå¦‚æœMasterå®•æœºï¼Œäº‹åŠ¡åœ¨Masterä¸Šå·²ç»æäº¤ï¼Œä½†å¯èƒ½è¿™äº›äº‹åŠ¡æ²¡æœ‰ä¼ åˆ°ä»»ä½•çš„Slaveä¸Šï¼Œå‡è®¾æœ‰Masterâ€“>Salveæ•…éšœè½¬ç§»çš„æœºåˆ¶ï¼Œæ­¤æ—¶Slaveä¹Ÿå¯èƒ½ä¼šä¸¢å¤±äº‹åŠ¡ï¼ŒMysqlå¤åˆ¶é»˜è®¤æ˜¯å¼‚æ­¥å¤åˆ¶ï¼Œå¼‚æ­¥å¤åˆ¶æä¾›äº†æœ€ä½³æ€§èƒ½

**åŒæ­¥å¤åˆ¶ï¼ˆSync Replicationï¼‰**

ä¸»åº“å°†æ›´æ–°å†™å…¥Binlogæ—¥å¿—æ–‡ä»¶åï¼Œéœ€è¦ç­‰å¾…æ•°æ®æ›´æ–°å·²ç»å¤åˆ¶åˆ°ä»åº“ä¸­ï¼Œå¹¶ä¸”å·²ç»åœ¨ä»åº“æ‰§è¡ŒæˆåŠŸï¼Œç„¶åæ‰èƒ½è¿”å›ç»§ç»­å¤„ç†å…¶å®ƒçš„è¯·æ±‚ï¼ŒåŒæ­¥å¤åˆ¶æä¾›äº†æœ€ä½³å®‰å…¨æ€§ï¼Œä¿è¯æ•°æ®å®‰å…¨ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œä½†å¯¹æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“

**åŠåŒæ­¥å¤åˆ¶ï¼ˆSemi-Sync Replicationï¼‰**

ä¸»åº“æäº¤æ›´æ–°å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶åï¼Œç­‰å¾…æ•°æ®æ›´æ–°å†™å…¥äº†ä»æœåŠ¡å™¨ä¸­ç»§æ—¥å¿—ä¸­ï¼Œç„¶åæ‰èƒ½å†ç»§ç»­å¤„ç†å…¶å®ƒè¯·æ±‚ï¼Œè¯¥åŠŸèƒ½ç¡®ä¿è‡³å°‘æœ‰1ä¸ªä»åº“æ¥æ”¶å®Œä¸»åº“ä¼ é€’è¿‡æ¥çš„binlogå†…å®¹å·²ç»å†™å…¥åˆ°è‡ªå·±çš„relay logé‡Œé¢äº†ï¼Œæ‰ä¼šé€šçŸ¥ä¸»åº“ä¸Šé¢çš„ç­‰å¾…çº¿ç¨‹ï¼Œè¯¥æ“ä½œå®Œæ¯•

åŠåŒæ­¥å¤åˆ¶æ˜¯æœ€ä½³å®‰å…¨æ€§äºæœ€ä½³æ€§èƒ½ ä¹‹é—´çš„ä¸€ä¸ªæŠ˜ä¸­

MySQL5.5ç‰ˆæœ¬ä¹‹ä¸­å¼•å…¥äº†åŠåŒæ­¥å¤åˆ¶åŠŸèƒ½ï¼Œä¸»ä»æœåŠ¡å™¨å¿…é¡»å®‰è£…åŠåŒæ­¥å¤åˆ¶æ’ä»¶ï¼Œæ‰èƒ½å¼€å¯è¯¥å¤åˆ¶åŠŸèƒ½ï¼Œå¦‚æœç­‰å¾…è¶…æ—¶ï¼Œè¶…è¿‡rpl_semi_sync_master_timeoutå‚æ•°è®¾ç½®æ—¶é—´(é»˜è®¤å€¼ä¸º10000ï¼Œè¡¨ç¤º10ç§’)ï¼Œåˆ™å…³é—­åŠåŒæ­¥å¤åˆ¶ã€‚å¹¶è‡ªåŠ¨è½¬æ¢ä¸ºå¼‚æ­¥å¤åˆ¶æ¨¡å¼ï¼Œå½“master dumpçº¿ç¨‹å‘é€å®Œä¸€ä¸ªäº‹åŠ¡çš„æ‰€æœ‰äº‹ä»¶ä¹‹åï¼Œå¦‚æœåœ¨rpl_semi_sync_master_timeoutå†…ï¼Œæ”¶åˆ°äº†ä»åº“çš„å“åº”ï¼Œåˆ™ä¸»ä»åˆé‡æ–°æ¢å¤ä¸ºå¢å¼ºåŠåŒæ­¥å¤åˆ¶

ACK (Acknowledge characterï¼‰å³æ˜¯ç¡®è®¤å­—ç¬¦ã€‚

**å¢å¼ºåŠåŒæ­¥å¤åˆ¶ï¼ˆlossless Semi-Sync Replicationã€æ— æŸå¤åˆ¶ï¼‰**

å¢å¼ºåŠåŒæ­¥æ—¶åœ¨MySQL 5.7å¼•å…¥ï¼Œå…¶å®åŠåŒæ­¥å¯ä»¥çœ‹æˆä¸€ä¸ªè¿‡æ¸¡åŠŸèƒ½ï¼Œå› ä¸ºé»˜è®¤çš„é…ç½®å°±æ˜¯å¢å¼ºåŠåŒæ­¥ï¼Œå¤§å®¶ä¸€èˆ¬è¯´çš„åŠåŒæ­¥å¤åˆ¶å…¶å®å°±æ˜¯å¢å¼ºçš„åŠåŒæ­¥å¤åˆ¶ï¼Œä¹Ÿå°±æ˜¯æ— æŸå¤åˆ¶

å¢å¼ºåŠåŒæ­¥å’ŒåŠåŒæ­¥ä¸åŒçš„æ˜¯ï¼Œç­‰å¾…ACKæ—¶é—´ä¸åŒ

rpl_semi_sync_master_wait_point =AFTER_SYNC(é»˜è®¤)

åŠåŒæ­¥çš„é—®é¢˜æ˜¯å› ä¸ºç­‰å¾…ACKçš„ç‚¹æ˜¯Commitä¹‹åï¼Œæ­¤æ—¶Masterå·²ç»å®Œæˆæ•°æ®å˜æ›´ï¼Œç”¨æˆ·å·²ç»å¯ä»¥çœ‹åˆ°æœ€æ–°æ•°æ®ï¼Œå½“Binlogè¿˜æœªåŒæ­¥åˆ°Slaveæ—¶ï¼Œå‘ç”Ÿä¸»ä»åˆ‡æ¢ï¼Œé‚£ä¹ˆæ­¤æ—¶ä»åº“æ˜¯æ²¡æœ‰è¿™ä¸ªæœ€æ–°æ•°æ®çš„ï¼Œç”¨æˆ·çœ‹åˆ°çš„è¿˜æ˜¯è€æ•°æ®ï¼Œå¢å¼ºåŠåŒæ­¥å°†ç­‰å¾…ACKçš„ç‚¹æ”¾åœ¨æäº¤Commitä¹‹å‰ï¼Œæ­¤æ—¶æ•°æ®è¿˜æœªè¢«æäº¤ï¼Œå¤–ç•Œçœ‹ä¸åˆ°æ•°æ®å˜æ›´ï¼Œæ­¤æ—¶å¦‚æœå‘ç”Ÿä¸»ä»åˆ‡æ¢ï¼Œæ–°åº“ä¾ç„¶è¿˜æ˜¯è€æ•°æ®ï¼Œä¸å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜

## äºŒã€dockerä¸‹å®‰è£…ã€å¯åŠ¨mysql
dockerä¸‹å®‰è£…mysql 8.0.15
~~~shell
docker pull mysql:8.0.15
~~~

### 1. å®‰è£…ä¸»åº“

å¯åŠ¨mysql-masterï¼Œå½“ä½œä¸»åº“

~~~shell
docker run -p 3306:3306 --name mysql_master -e MYSQL_ROOT_PASSWORD=123456 -d 7bb2586065cd
~~~

> æ­¤æ—¶å¯åŠ¨å·²å®Œæˆï¼Œåœ¨dockerå¯åŠ¨é•œåƒæ—¶å¯†ç åŠ å¯†ä½¿ç”¨çš„æ˜¯caching_sha2_passwordï¼Œ
> åœ¨æœåŠ¡å™¨ç«¯å¯åŠ¨é»˜è®¤ä½¿ç”¨mysql_native_password åŠ å¯†çš„ï¼Œ
> å¦‚éœ€è¦ä½¿ç”¨å¤–éƒ¨å·¥å…·è¿æ¥ï¼Œéœ€è¦è¿›å…¥dockerå®¹å™¨é‡ç½®rootå¯†ç ã€‚

è¿›å…¥dockerå®¹å™¨ä¿®æ”¹Mysqlè¿œç¨‹è¿æ¥çš„å¯†ç 
~~~shell
docker exec -it mysql_master /bin/sh

# mysql -u root -p

# è¾“å…¥ç™»å½•å¯†ç ï¼ˆè®¾ç½®çš„MYSQL_ROOT_PASSWORDï¼‰ï¼š123456

mysql> ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY 'test001';
~~~

> é€€å‡ºæ•°æ®åº“è®¾ç½®å’Œdockerå®¹å™¨ï¼Œä½¿ç”¨exitå‘½ä»¤

![image-20231110135242436](https://image.xiaoxiaofeng.site/blog/2023/11/10/xxf-20231110135348.png?xxfjava)


### 2. å®‰è£…ä»åº“

å¯åŠ¨mysql-slaveï¼Œå½“ä½œä»åº“
~~~shell
docker run  -p 3307:3306 --name mysql_slave -e MYSQL_ROOT_PASSWORD=123456 -d 7bb2586065cd
~~~

è¿›å…¥dockerå®¹å™¨ä¿®æ”¹Mysqlè¿œç¨‹è¿æ¥çš„å¯†ç 
~~~shell
docker exec -it mysql_slave /bin/sh

# mysql -u root -p

# è¾“å…¥ç™»å½•å¯†ç ï¼ˆè®¾ç½®çš„MYSQL_ROOT_PASSWORDï¼‰ï¼š123456

mysql> ALTER USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY 'test001';
~~~

å®‰è£…å®Œä¸»åº“å’Œä»åº“åå¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20231110150836045](https://image.xiaoxiaofeng.site/blog/2023/11/10/xxf-20231110150836.png?xxfjava)

## ä¸‰ã€é…ç½®Master(ä¸»)

~~~shell
docker exec -it mysql_master /bin/sh
~~~

`cd /etc/mysql`åˆ‡æ¢åˆ°/etc/mysqlç›®å½•ä¸‹ï¼Œç„¶å`vi my.cnf`å¯¹my.cnfè¿›è¡Œç¼–è¾‘ã€‚
æ­¤æ—¶ä¼šæŠ¥å‡ºbash: `/bin/sh: 3: vi: not found`ï¼Œéœ€è¦æˆ‘ä»¬åœ¨dockerå®¹å™¨å†…éƒ¨è‡ªè¡Œå®‰è£…vimã€‚
ä½¿ç”¨`apt-get install vim`å‘½ä»¤å®‰è£…vim

å¦‚æœå‡ºç°å¦‚ä¸‹é—®é¢˜ï¼š
~~~shell
Reading package lists... Done
Building dependency tree       
Reading state information... Done
E: Unable to locate package vim
~~~

æ‰§è¡Œ`apt-get update`ï¼Œç„¶åå†æ¬¡æ‰§è¡Œ`apt-get install vim`å³å¯æˆåŠŸå®‰è£…vimã€‚

> å¦‚æœdockerå†…éƒ¨å®‰è£…ä¸äº†Vimï¼Œå¯ä»¥å°†æ–‡ä»¶æ‹·è´å‡ºæ¥ï¼Œä¿®æ”¹å®Œä¹‹ååœ¨æ‹·è´è¿›å»ï¼Œæˆ–è€…å¯åŠ¨æ—¶ä½¿ç”¨docker -vçš„æ–¹å¼æŒ‚è½½
>
> ```shell
> #å°†å®¹å™¨ä¸­çš„æ–‡ä»¶æ‹·è´å‡ºæ¥
> sudo docker cp å®¹å™¨ID:/etc/mysql/my.cnf /data/mysql/master
> #å°†å®¹å™¨ä¸­çš„æ–‡ä»¶æ‹·è´å›å»
> sudo docker cp /data/mysql/master/my.cnf  å®¹å™¨ID:/etc/mysql/
> ```

ç„¶åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨vimç¼–è¾‘my.cnfï¼Œåœ¨my.cnfä¸­æ·»åŠ 

~~~shell
[mysqld]
## åŒä¸€å±€åŸŸç½‘å†…ï¼Œæ³¨æ„è¦å”¯ä¸€
server-id=99  
## å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—åŠŸèƒ½ï¼Œå¯ä»¥éšä¾¿å–ï¼ˆå…³é”®ï¼‰
log-bin=mysql-bin
~~~

> **éœ€è¦é‡å¯mysqlæœåŠ¡**ï¼Œ`docker restart å®¹å™¨ID`

ä¸‹ä¸€æ­¥åœ¨Masteræ•°æ®åº“åˆ›å»ºæ•°æ®åŒæ­¥ç”¨æˆ·

~~~shell
CREATE USER 'slave'@'%' IDENTIFIED BY '123456';
ALTER USER 'slave'@'%' IDENTIFIED WITH mysql_native_password BY '123456';
~~~

æˆäºˆç”¨æˆ· slave REPLICATION SLAVEæƒé™å’ŒREPLICATION CLIENTæƒé™ï¼Œç”¨äºåœ¨ä¸»ä»åº“ä¹‹é—´åŒæ­¥æ•°æ®ã€‚
~~~shell
GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave'@'%';
~~~
![åˆ›å»ºç”¨æˆ·å›¾ç‰‡](https://image.xiaoxiaofeng.site/article/img/2022/11/07/xxf-20221107144222.jpg)

## å››ã€é…ç½®Slave(ä»)
å’Œé…ç½®Master(ä¸»)ä¸€æ ·ï¼Œåœ¨Slaveé…ç½®æ–‡ä»¶my.cnfä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š
~~~shell
[mysqld]
## è®¾ç½®server_id,æ³¨æ„è¦å”¯ä¸€
server-id=101  
## å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—åŠŸèƒ½ï¼Œä»¥å¤‡Slaveä½œä¸ºå…¶å®ƒSlaveçš„Masteræ—¶ä½¿ç”¨
log-bin=mysql-slave-bin   
## relay_logé…ç½®ä¸­ç»§æ—¥å¿—
relay_log=edu-mysql-relay-bin
~~~

**é…ç½®å®Œæˆåä¹Ÿéœ€è¦é‡å¯mysqlæœåŠ¡å’Œdockerå®¹å™¨**ï¼Œæ“ä½œå’Œé…ç½®Master(ä¸»)ä¸€è‡´ã€‚

## äº”ã€é“¾æ¥Master(ä¸»)å’ŒSlave(ä»)

åœ¨Masterè¿›å…¥mysqlï¼Œæ‰§è¡Œ`show master status;`

![ç¬‘å°æ«ä¸“å±å›¾ç‰‡](https://image.xiaoxiaofeng.site/article/img/2022/11/07/xxf-20221107144256.jpg)

Fileå’ŒPositionå­—æ®µçš„å€¼åé¢å°†ä¼šç”¨åˆ°ï¼Œåœ¨åé¢çš„æ“ä½œå®Œæˆä¹‹å‰ï¼Œéœ€è¦ä¿è¯Masteråº“ä¸èƒ½åšä»»ä½•æ“ä½œï¼Œå¦åˆ™å°†ä¼šå¼•èµ·çŠ¶æ€å˜åŒ–ï¼ŒFileå’ŒPositionå­—æ®µçš„å€¼å˜åŒ–ã€‚

åœ¨Slave ä¸­è¿›å…¥ mysqlï¼Œæ‰§è¡Œ
~~~shell
change master to master_host='172.17.0.8', master_user='slave', master_password='test001', master_port=3306, master_log_file='mysql-bin.000002', master_log_pos=994, master_connect_retry=30;
~~~

* å‘½ä»¤è¯´æ˜

![ç¬‘å°æ«ä¸“å±å›¾ç‰‡](https://image.xiaoxiaofeng.site/article/img/2022/11/07/xxf-20221107144301.jpg)

```shell
master_host ï¼šMasterçš„åœ°å€ï¼ŒæŒ‡çš„æ˜¯å®¹å™¨çš„ç‹¬ç«‹ip,å¯ä»¥é€šè¿‡docker inspect --format='{{.NetworkSettings.IPAddress}}' å®¹å™¨åç§°|å®¹å™¨idæŸ¥è¯¢å®¹å™¨çš„ipã€‚å¦‚æœä¸æ˜¯dockerç›´æ¥æ”¾æœåŠ¡å™¨çš„IPåœ°å€å°±è¡Œï¼Œä¿è¯ä¸¤ä¸ªæœåŠ¡å™¨äº’é€šå³å¯

master_portï¼šMasterçš„ç«¯å£å·ï¼ŒæŒ‡çš„æ˜¯å®¹å™¨çš„ç«¯å£å·

master_userï¼šç”¨äºæ•°æ®åŒæ­¥çš„ç”¨æˆ·

master_passwordï¼šç”¨äºåŒæ­¥çš„ç”¨æˆ·çš„å¯†ç 

master_log_fileï¼šæŒ‡å®š Slave ä»å“ªä¸ªæ—¥å¿—æ–‡ä»¶å¼€å§‹å¤åˆ¶æ•°æ®ï¼Œå³ä¸Šæ–‡ä¸­æåˆ°çš„ File å­—æ®µçš„å€¼

master_log_posï¼šä»å“ªä¸ª Position å¼€å§‹è¯»ï¼Œå³ä¸Šæ–‡ä¸­æåˆ°çš„ Position å­—æ®µçš„å€¼

master_connect_retryï¼šå¦‚æœè¿æ¥å¤±è´¥ï¼Œé‡è¯•çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ˜¯ç§’ï¼Œé»˜è®¤æ˜¯60ç§’
```

åœ¨Slave ä¸­çš„mysqlç»ˆç«¯æ‰§è¡Œ`show slave status;`ç”¨äºæŸ¥çœ‹ä¸»ä»åŒæ­¥çŠ¶æ€ã€‚

![ç¬‘å°æ«ä¸“å±å›¾ç‰‡](https://image.xiaoxiaofeng.site/article/img/2022/11/07/xxf-20221107144310.png)

* Slave_IO_Runningï¼šè´Ÿè´£ä»åº“å»ä¸»åº“è¯»å–äºŒè¿›åˆ¶æ—¥å¿—ï¼Œå¹¶å†™å…¥åˆ°ä»åº“çš„ä¸­ç»§æ—¥å¿—
* Slave_SQL_Runningï¼šè´Ÿè´£å°†ä¸­ç»§æ—¥å¿—è½¬æ¢æˆSQLè¯­å¥åæ‰§è¡Œ

æ­£å¸¸æƒ…å†µä¸‹ï¼ŒSlaveIORunning å’Œ SlaveSQLRunning éƒ½æ˜¯Noï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å¼€å¯ä¸»ä»å¤åˆ¶è¿‡ç¨‹ã€‚
ä½¿ç”¨`start slave;`å¼€å¯ä¸»ä»å¤åˆ¶è¿‡ç¨‹ï¼Œç„¶åå†æ¬¡æŸ¥è¯¢ä¸»ä»åŒæ­¥çŠ¶æ€`show slave status;`ã€‚

![ç¬‘å°æ«ä¸“å±å›¾ç‰‡](https://image.xiaoxiaofeng.site/article/img/2022/11/07/xxf-20221107144315.png)

SlaveIORunning å’Œ SlaveSQLRunning éƒ½æ˜¯Yesï¼Œè¯´æ˜ä¸»ä»å¤åˆ¶å·²ç»å¼€å¯ã€‚æ­¤æ—¶å¯ä»¥æµ‹è¯•æ•°æ®åŒæ­¥æ˜¯å¦æˆåŠŸã€‚

## å…­ã€ä¸»ä»å¤åˆ¶æ’é”™

###  1. é”™è¯¯ï¼šerror connecting to master 'xxxx' - retry-time: 30 retries: xx

![ç¬‘å°æ«ä¸“å±å›¾ç‰‡](https://image.xiaoxiaofeng.site/article/img/2022/11/07/xxf-20221107144320.png)

ä½¿ç”¨start slaveå¼€å¯ä¸»ä»å¤åˆ¶è¿‡ç¨‹åï¼Œå¦‚æœSlaveIORunningä¸€ç›´æ˜¯Connectingï¼Œåˆ™è¯´æ˜ä¸»ä»å¤åˆ¶ä¸€ç›´å¤„äºè¿æ¥çŠ¶æ€ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯ä¸‹é¢å‡ ç§åŸå› é€ æˆçš„ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ® Last_IO_Erroræç¤ºäºˆä»¥æ’é™¤ã€‚

1ã€ç½‘ç»œä¸é€š

    æ£€æŸ¥ip,ç«¯å£,è¿™é‡Œdockerè™½ç„¶æ˜ å°„å‡ºå»çš„mysqlç«¯å£æ˜¯3320ï¼Œä½†é€šè¿‡å†…ç½‘è®¿é—®ä»ç„¶æ˜¯3306

2ã€å¯†ç ä¸å¯¹

    æ£€æŸ¥æ˜¯å¦åˆ›å»ºç”¨äºåŒæ­¥çš„ç”¨æˆ·å’Œç”¨æˆ·å¯†ç æ˜¯å¦æ­£ç¡®

3ã€posä¸å¯¹

    æ£€æŸ¥Masterçš„ Position



### 2. é”™è¯¯ï¼šERROR 1872 (HY000): Slave failed to initialize relay log info structure from the repository

æ£€æŸ¥my.cnfï¼Œæ˜¯å¦æŒ‡å®šrelay_logï¼ŒæŒ‡å®šçš„relay_logæ˜¯å¦è¢«å…¶ä»–serverå ç”¨ã€‚

è§£å†³æ–¹æ³•ï¼šä¿®æ”¹my.cnfæŒ‡å®šrelay_logï¼Œç„¶åé‡å¯æœåŠ¡ã€‚

å…ˆæ‰§è¡Œ`reset slave`å‘½ä»¤ï¼Œåœ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

~~~shell
change master to master_host='172.17.0.8', master_user='slave', master_password='test001', master_port=3306, master_log_file='mysql-bin.000002', master_log_pos=994, master_connect_retry=30;
~~~
æœ€åå¯åŠ¨`start slave;`

### 3. æ“ä½œä»åº“é…ç½®åï¼Œä¸»åº“å‘ç”Ÿå˜æ›´

åœ¨master`show master status;`æŸ¥è¯¢ä¸»åº“æœ€æ–°çš„çŠ¶æ€

ç„¶åæ‰§è¡Œ`reset slave`å‘½ä»¤ï¼Œå†æ‰§è¡Œæ›´æ–°åçš„é“¾æ¥å‘½ä»¤ï¼š

~~~shell
change master to master_host='172.17.0.8', master_user='slave', master_password='test001', master_port=3306, master_log_file='mysql-bin.000002', master_log_pos=994, master_connect_retry=30;
~~~

æœ€åå¯åŠ¨`start slave;`

## ä¸ƒã€æµ‹è¯•ä¸»ä»å¤åˆ¶æµ‹è¯•

åœ¨ä¸»åº“ï¼ˆmasterï¼‰åˆ›å»ºtestæ•°æ®åº“ï¼Œå¹¶æ·»åŠ testè¡¨ï¼Œç„¶åå¯ä»¥çœ‹åˆ°ä»åº“ä¸­ä¹Ÿå‡ºç°äº†å¯¹åº”çš„æ•°æ®åº“å’Œè¡¨

![ç¬‘å°æ«ä¸“å±å›¾ç‰‡](https://image.xiaoxiaofeng.site/article/img/2022/11/07/xxf-20221107144324.png)

## å…«ã€ç»™è¿è¡Œä¸­çš„æ•°æ®åº“æ·»åŠ ä»åº“

ç»™è¿è¡Œä¸­çš„æ•°æ®åº“æ·»åŠ ä»åº“æ“ä½œå’Œä¸Šè¿°æ·»åŠ ä»åº“æ“ä½œä¸€è‡´ã€‚

éœ€è¦æ³¨æ„å‡ ç‚¹

1. ä¸»åº“æ˜¯å¦å¼€å¯binlogæ—¥å¿—ã€‚å¦‚æœæ²¡æœ‰éœ€è¦å¼€å¯ã€‚
2. ä¸»åº“è¿è¡Œä¸­master_log_posæ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œè¦æ³¨æ„èŠ‚ç‚¹ã€‚
3. éœ€è¦å…ˆå°†ä¸»åº“çš„æ•°æ®å¤‡ä»½åˆ°ä»åº“ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚

## ä¹ã€æ€»ç»“

æœ¬æ–‡ä¸»è¦è®²è§£äº†Mysqlä¸»ä»å¤åˆ¶çš„æ“ä½œï¼Œå¦‚æœæœ‰å¤šä¸ªä»åº“ï¼Œé‡å¤æ‰§è¡Œä»åº“çš„æ“ä½œå³å¯ã€‚

**åˆ‡è®°ï¼šå¯¹æ•°æ®çš„å¢åˆ æ”¹æ“ä½œä¸€å®šè¦åœ¨ä¸»åº“ä¸Šæ“ä½œï¼Œä¸è¦åœ¨ä»åº“ä¸Šæ“ä½œã€‚**



æœ¬æ–‡åˆ°æ­¤å°±ç»“æŸäº†ï¼Œæœ‰é—®é¢˜å°±æ‰¾**ç¬‘å°æ«**ã€‚

ç‚¹ä¸ªå…³æ³¨å’Œæ”¶è—å§ï¼Œä¸ç„¶å°±ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡

![image-20231110154837139](https://image.xiaoxiaofeng.site/blog/2023/11/10/xxf-20231110170138.png?xxfjava)

