
# 1、回顾一下Buffer Pool是个什么东西？ #

## 1.1 增删改直接操作的是内存还是磁盘？ ##

现在我们先来回顾一下数据库中的Buffer Pool是个什么东西？其实他是一个非常关键的组件，因为我们通过之前的讲解都知道一点，那就是数据库中的数据实际上最终都是要存放在磁盘文件上的。

我们在对数据库执行增删改操作的时候，不可能直接更新磁盘上的数据的，因为如果你对磁盘进行随机读写操作，那速度是相当的慢，随便一个大磁盘文件的随机读写操作，可能都要几百毫秒。如果要是那么搞的话，可能你的数据库每秒也就只能处理几百个请求了！

之前我们也都讲解过了，你在对数据库执行增删改操作的时候，实际上主要都是针对内存里的Buffer Pool中的数据进行的，也就是你实际上主要是对数据库的内存里的数据结构进行了增删改，如下图所示。  
![笑小枫-www.xiaoxiaofeng.com](https://image.xiaoxiaofeng.site/spider/2022/11/2/xxf-1667354391971.jpg)

## 1.2 数据库崩溃了，内存中数据丢了怎么办？ ##

当然，我们之前都说过，其实每个人都担心一个事，就是你在数据库的内存里执行了一堆增删改的操作，内存数据是更新了，但是这个时候如果数据库突然崩溃了，那么内存里更新好的数据不是都没了吗？

所以其实之前我们就用了很多章节讲这个问题，MySQL就怕这个问题，所以引入了一个redo log机制，你在对内存里的数据进行增删改的时候，同时会把增删改对应的日志写入redo log中，如下图。  
![笑小枫-www.xiaoxiaofeng.com](https://image.xiaoxiaofeng.site/spider/2022/11/2/xxf-1667354393796.jpg)  
万一你的数据库突然崩溃了，没关系，只要从redo log日志文件里读取出来你之前做过哪些增删改操作，瞬间就可以重新把这些增删改操作在你的内存里执行一遍，这就可以恢复出来你之前做过哪些增删改操作了。

当然对于数据更新的过程，是有一套严密的步骤的，还涉及到**undo log、binlog、提交事务、buffer pool脏数据刷回磁盘**等等。我们之前都讲过了，这里不再重复，这里仅仅是回顾一下数据库中的Buffer Pool这个东西。

## 1.3 Buffer Pool的一句话总结 ##

所以这里我们简单对Buffer Pool这个东西做一下总结，他其实是数据库中我们第一个必须要搞清楚的核心组件，因为增删改操作首先就是针对这个内存中的Buffer Pool里的数据执行的，同时配合了后续的redo log、刷磁盘等机制和操作。

所以**Buffer Pool就是数据库的一个内存组件，里面缓存了磁盘上的真实数据，然后我们的Java系统对数据库执行的增删改操作，其实主要就是对这个内存数据结构中的缓存数据执行的**。

# 2、Buffer Pool这个内存数据结构到底长个什么样子？ #

我们先来看一下下面的图，里面就画了数据库中的Buffer Pool内存组件。  
![笑小枫-www.xiaoxiaofeng.com](https://image.xiaoxiaofeng.site/spider/2022/11/2/xxf-1667354395746.jpg)

## 2.1 如何配置MySQL的Buffer Pool的大小？ ##

我们先来看一下下面的图，里面就画了数据库中的Buffer Pool内存组件。  
因为Buffer Pool本质其实就是数据库的一个内存组件，你可以理解为他就是一片内存数据结构，所以这个内存数据结构肯定是有一定的大小的，不可能是无限大的。

这个Buffer Pool默认情况下是128MB，还是有一点偏小了，我们实际生产环境下完全可以对Buffer Pool进行调整。比如我们的数据库如果是16核32G的机器，那么你就可以给Buffer Pool分配个2GB的内存，使用下面的配置就可以了。

    [server]
    innodb_buffer_pool_size = 2147483648

## 2.2 数据页 ##

在将Buffer Pool之前，我们先来了解一个概念：数据页。想必好多人也听说过这个，但是数据页是个什么样的结构呢？存放的是什么样的数据呢？别急，下面会慢慢道来。

接着我们来看下一个问题，假设现在我们的数据库中一定有一片内存区域是Buffer Pool了，那么我们的数据是如何放在Buffer Pool中的？

也就是说我们都知道数据库里有一个一个的表，一个表有很多字段，然后一个表里有很多行数据，每行数据都有好多的字段值。所以大家觉得我们的数据是一行一行的放在Buffer Pool里面的吗？

这就明显不是了，实际上**MySQL对数据抽象出来了一个数据页的概念，是把很多行数据放在了一个数据页里**，也就是说我们的**磁盘文件中就是会有很多的数据页，每一页数据里放了很多行数据**。

所以实际上假设我们要更新一行数据，**此时数据库会找到这行数据所在的数据页，不是只加载一行数据，而是从磁盘文件里把这行数据所在的数据页直接给加载到Buffer Pool里去**。也就是说，Buffer Pool中存放的也是一个一个的数据页，如下图：

![笑小枫-www.xiaoxiaofeng.com](https://image.xiaoxiaofeng.site/spider/2022/11/2/xxf-1667354396367.jpg)

## 2.3 磁盘上的数据页和Buffer Pool中的数据页是如何对应起来的？ ##

 *  实际上默认情况下，磁盘中存放的数据页的大小是16KB，也就是说，一页数据包含了16KB的内容。
 *  而Buffer Pool中存放的一个一个的数据页，我们通常叫做缓存页，因为毕竟Buffer Pool是一个缓冲池，里面的数据都是从磁盘缓存到内存去的。
 *  而Buffer Pool中默认情况下，一个缓存页的大小和磁盘上的一个数据页的大小是一一对应起来的，都是16KB。

所以我们看下图，图中的Buffer Pool标注出来了的内存大小，假设是128MB吧，然后数据页的大小是16KB。

![笑小枫-www.xiaoxiaofeng.com](https://image.xiaoxiaofeng.site/spider/2022/11/2/xxf-1667354397720.jpg)

## 2.4 缓存页描述信息 ##

接着我们要了解下一个概念，**对于每个缓存页，实际上都会有一个描述信息，这个描述信息大体可以认为是用来描述这个缓存页的**。  
比如包含如下的一些东西：这个数据页所属的表空间、数据页的编号、这个缓存页在Buffer Pool中的内存地址以及别的一些东西，就相当于缓存页的元数据一样。

每个缓存页都会对应一个描述信息，这个描述信息本身也是一块数据，**在Buffer Pool中，每个缓存页的描述数据放在最前面，然后各个缓存页放在后面**。

所以此时我们看下面的图，Buffer Pool实际看起来大概长这个样子。  
![笑小枫-www.xiaoxiaofeng.com](https://image.xiaoxiaofeng.site/spider/2022/11/2/xxf-1667354398889.jpg)  
而且这里我们要注意一点，**Buffer Pool中的描述数据大概相当于缓存页大小的5%左右**，也就是每个描述数据大概是800个字节左右的大小，然后假设你设置的buffer pool大小是128MB，实际上Buffer Pool真正的最终大小会超出一些，可能有个130多MB的样子，**因为他里面还要存放每个缓存页的描述数据**。

