## å…³äºæœ¬æ–‡

å…¶å®ç”¨æˆ·ç™»å½•æ‹¦æˆªçš„è¿™å—ä¸æƒ³è¿™ä¹ˆæ—©å†™ï¼ŒåŠ ä¸ªç™»å½•åé¢å¥½å¤šä¸œè¥¿å°±è¦è€ƒè™‘ç™»å½•çŠ¶æ€äº†ï¼Œæˆ‘å…¶å®æƒ³æŠŠè¿™ä¸ªç³»åˆ—å†™æˆ`éå¿…è¦å…³ç³»ï¼Œè§£è€¦æ€§æ¯”è¾ƒå¼º`çš„ç³»åˆ—ã€‚ä½†æ˜¯ï¼Œå†™å®Œredisï¼Œæ€»æ˜¯æ„Ÿè§‰ç™»å½•æ˜¯å¯¹å®ƒæœ€ç®€å•çš„å®è·µï¼Œé‚£å°±åŠ ä¸Šå§ï¼Œåæ­£åé¢å¾ˆå¤šæ–‡ç« ä¹Ÿä¼šç”¨åˆ°ï¼Œä½†å¤§å¤šæ–‡ç« æˆ‘ä»ä¼šä¸è€ƒè™‘ç™»å½•çŠ¶æ€ã€‚

> è¿™é‡Œåªæ˜¯è®²æ˜ç™½ç™»å½•æœºåˆ¶ï¼Œå¦‚ä½•å®ç°ã€‚å®é™…ä½¿ç”¨ä¸­ä¼šè€ƒè™‘å¾ˆå¤šåˆ«çš„ï¼Œä¾‹å¦‚ç”¨æˆ·æƒé™ï¼Œç™»å½•æœºåˆ¶é™åˆ¶ç­‰ç­‰~è¿™é‡Œå°±å…ˆä¸åšè¿‡å¤šçš„å™è¿°ã€‚
>
> è¿™é‡Œåªè®²æŠ€æœ¯å’Œå®ç°ï¼Œä¸è®²ä»»ä½•ä¸šåŠ¡åœºæ™¯å“ˆï¼Œç‰µæ‰¯åˆ°åœºæ™¯çš„é—®é¢˜å°±ä¼šå¤æ‚Nå€ï¼Œè€Œä¸”é€šç”¨æ€§å¾€å¾€ä¸å°½äººæ„~

æœ¬æ–‡ä¾èµ–äºrediså’Œmybatis plusï¼Œè¿™äº›éƒ½æ˜¯æœ€åŸºç¡€çš„æ¨¡å—ï¼Œæ‰€ä»¥éƒ½æ”¾åœ¨æœ€å‰é¢å†™äº†ï¼Œå¤§å®¶å¯ä»¥çº¿è¿‡ä¸€ä¸‹ç›¸å…³çš„æ–‡ç« ã€‚

[SpringBooté›†æˆRedis]()

[SpringBooté›†æˆMybatis Plus]()

> æœ¬æ–‡æ˜¯åŸºäºjwt+redisæ¥å®ç°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹å§

## ä»€ä¹ˆæ˜¯JWT

ä»€ä¹ˆæ˜¯JWT,JWT(å…¨ç§°ï¼šJson Web Token)æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†(RFC 7519)ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç´§å‡‘çš„ã€è‡ªåŒ…å«çš„æ–¹å¼ï¼Œç”¨äºä½œä¸ºJSONå¯¹è±¡åœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ã€‚ è¯¥ä¿¡æ¯å¯ä»¥è¢«éªŒè¯å’Œä¿¡ä»»ï¼Œå› ä¸ºå®ƒæ˜¯æ•°å­—ç­¾åçš„ã€‚

ä¸Šé¢è¯´æ³•æ¯”è¾ƒæ–‡ç»‰ç»‰ï¼Œç®€å•ç‚¹è¯´å°±æ˜¯ä¸€ç§è®¤è¯æœºåˆ¶ï¼Œè®©åå°çŸ¥é“è¯¥è¯·æ±‚æ˜¯æ¥è‡ªäºå—ä¿¡çš„å®¢æˆ·ç«¯ã€‚

### JWTçš„ä¼˜ç‚¹
* jsonæ ¼å¼çš„é€šç”¨æ€§ï¼Œæ‰€ä»¥JWTå¯ä»¥è·¨è¯­è¨€æ”¯æŒï¼Œæ¯”å¦‚Javaã€JavaScriptã€PHPã€Nodeç­‰ç­‰ã€‚
* å¯ä»¥åˆ©ç”¨Payloadå­˜å‚¨ä¸€äº›éæ•æ„Ÿçš„ä¿¡æ¯ã€‚
* ä¾¿äºä¼ è¾“ï¼ŒJWTç»“æ„ç®€å•ï¼Œå­—èŠ‚å ç”¨å°ã€‚
* ä¸éœ€è¦åœ¨æœåŠ¡ç«¯ä¿å­˜ä¼šè¯ä¿¡æ¯ï¼Œæ˜“äºåº”ç”¨çš„æ‰©å±•ã€‚

### JWTçš„ç¼ºç‚¹
* å®‰å…¨æ€§æ²¡æ³•ä¿è¯ï¼Œæ‰€ä»¥jwté‡Œä¸èƒ½å­˜å‚¨æ•æ„Ÿæ•°æ®ã€‚å› ä¸ºjwtçš„payloadå¹¶æ²¡æœ‰åŠ å¯†ï¼Œåªæ˜¯ç”¨Base64ç¼–ç è€Œå·²ã€‚
* æ— æ³•ä¸­é€”åºŸå¼ƒã€‚å› ä¸ºä¸€æ—¦ç­¾å‘äº†ä¸€ä¸ªjwtï¼Œåœ¨åˆ°æœŸä¹‹å‰å§‹ç»ˆéƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œå¦‚æœç”¨æˆ·ä¿¡æ¯å‘ç”Ÿæ›´æ–°äº†ï¼Œåªèƒ½ç­‰æ—§çš„jwtè¿‡æœŸåé‡æ–°ç­¾å‘æ–°çš„jwtã€‚
* ç»­ç­¾é—®é¢˜ã€‚å½“ç­¾å‘çš„jwtä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¸€ç›´åœ¨æ“ä½œé¡µé¢ï¼ŒæŒ‰é“ç†åº”è¯¥ä¸€ç›´ä¸ºå®¢æˆ·ç«¯ç»­é•¿æœ‰æ•ˆæ—¶é—´ï¼Œå¦åˆ™å½“jwtæœ‰æ•ˆæœŸåˆ°äº†å°±ä¼šå¯¼è‡´ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ã€‚

### å¯¹äºJWTçš„ç¼ºç‚¹ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ
* é’ˆå¯¹JWTçš„ç¼ºç‚¹ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œåªå‚¨å­˜å¸¸ç”¨çš„æ— æ•æ„Ÿæ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·IDï¼Œç”¨æˆ·è§’è‰²ç­‰ã€‚
* ä¸­é€”åºŸå¼ƒå’Œç»­ç­¾é—®é¢˜ï¼Œé€šè¿‡å’Œredisé…åˆä½¿ç”¨ï¼Œå°†tokenè¿”å›æ—¶ï¼ŒåŒæ­¥ä¿å­˜redisï¼Œé€šè¿‡æ§åˆ¶tokenåœ¨redisçš„æœ‰æ•ˆæœŸæ¥è¿›è¡Œæ§åˆ¶ã€‚
* è¿˜å¯ä»¥é€šè¿‡ç»Ÿè®¡redisæœ‰æ•ˆæ•°æ®ï¼Œå¯¹åœ¨çº¿ç”¨æˆ·è¿›è¡Œç»Ÿè®¡æˆ–å¼ºåˆ¶ä¸‹çº¿ç­‰æ“ä½œã€‚

## ä½¿ç”¨JWTåˆ¤æ–­ç”¨æˆ·ç™»å½•æµç¨‹

ä»¥ç”¨æˆ·ç™»å½•åŠŸèƒ½ä¸ºä¾‹ï¼Œç¨‹åºæµç¨‹å¦‚ä¸‹ï¼š

**ç”¨æˆ·ç™»å½•**

![ç¬‘å°æ«-www.xiaoxiaofeng.site](http://file.xiaoxiaofeng.site/blog/image/2022/06/30/20220630143121.jpeg)

**tokenè®¤è¯è®¿é—®**

![ç¬‘å°æ«-www.xiaoxiaofeng.site](http://file.xiaoxiaofeng.site/blog/image/2022/06/30/20220630143121.jpeg)

æ³¨ï¼šç³»ç»Ÿä¸­é‡‡ç”¨JWTå¯¹ç”¨æˆ·ç™»å½•æˆæƒéªŒè¯ã€‚

**åŸºäºTokençš„èº«ä»½éªŒè¯æµç¨‹**

ä½¿ç”¨åŸºäºTokençš„èº«ä»½éªŒè¯ï¼Œåœ¨æœåŠ¡ç«¯ä¸éœ€è¦å­˜å‚¨ç”¨æˆ·çš„ç™»å½•è®°å½•ã€‚å¤§æ¦‚çš„æµç¨‹æ˜¯è¿™æ ·çš„:

1ã€å®¢æˆ·ç«¯ä½¿ç”¨ç”¨æˆ·åæˆ–å¯†ç è¯·æ±‚ç™»å½•ï¼›

2ã€æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ï¼Œå»éªŒè¯ç”¨æˆ·åä¸å¯†ç ï¼›

3ã€éªŒè¯æˆåŠŸåï¼ŒæœåŠ¡ç«¯ä¼šä½¿ç”¨JWTç­¾å‘ä¸€ä¸ªTokenï¼Œä¿å­˜åˆ°Redisä¸­ï¼ŒåŒæ—¶å†æŠŠè¿™ä¸ªTokenå‘é€ç»™å®¢æˆ·ç«¯ï¼›

4ã€å®¢æˆ·ç«¯æ”¶åˆ°Tokenä»¥åå¯ä»¥æŠŠå®ƒå­˜å‚¨èµ·æ¥ï¼Œæ¯”å¦‚æ”¾åœ¨Cookieé‡Œæˆ–è€…Local Storageé‡Œï¼›

5ã€å®¢æˆ·ç«¯æ¯æ¬¡å‘æœåŠ¡ç«¯è¯·æ±‚èµ„æºçš„æ—¶å€™éœ€è¦åœ¨è¯·æ±‚Headeré‡Œé¢å¸¦ç€æœåŠ¡ç«¯ç­¾å‘çš„Tokenï¼›

6ã€æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ï¼Œç„¶åå»éªŒè¯å®¢æˆ·ç«¯è¯·æ±‚é‡Œé¢å¸¦ç€çš„Tokenï¼Œå¦‚æœéªŒè¯æˆåŠŸï¼Œå°±å‘å®¢æˆ·ç«¯è¿”å›è¯·æ±‚çš„æ•°æ®ã€‚éªŒè¯å¤±è´¥ï¼Œè¿”å›å¤±è´¥åŸå› ã€‚


## åŠŸèƒ½å®ç°

è‡ªåŠ¨ç”Ÿæˆçš„`User.java`ã€`UserMapper.java`ã€`UserMapper.xml`...å°±ä¸è´´ä»£ç äº†ï¼Œæ²¡æœ‰ä¸šåŠ¡ä»£ç ï¼Œä¸”å çš„ç¯‡å¹…è¿‡å¤§ã€‚åœ¨[SpringBooté›†æˆMybatis Plus]()æ–‡ç« ä¸­åˆ›å»ºè¿‡å°±å¯ä»¥å¿½ç•¥äº†å“ˆ~

ä»£ç ç”Ÿæˆè§[SpringBooté›†æˆMybatis Plus]()ä¸€æ–‡ã€‚

### æ¶‰åŠåˆ°çš„è¡¨sql

åœ¨[SpringBooté›†æˆMybatis Plus]()æ–‡ç« ä¸­åˆ›å»ºè¿‡çš„å°±å¯ä»¥å¿½ç•¥äº†

~~~sql
CREATE TABLE `usc_user` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
  `account` varchar(30) DEFAULT NULL COMMENT 'ç”¨æˆ·è´¦å·',
  `user_name` varchar(30) DEFAULT NULL COMMENT 'ç”¨æˆ·å§“å',
  `nick_name` varchar(30) DEFAULT NULL COMMENT 'ç”¨æˆ·æ˜µç§°',
  `user_type` varchar(2) DEFAULT '00' COMMENT 'ç”¨æˆ·ç±»å‹ï¼ˆ00ç³»ç»Ÿç”¨æˆ·,01å°ç¨‹åºç”¨æˆ·ï¼‰',
  `email` varchar(50) DEFAULT '' COMMENT 'ç”¨æˆ·é‚®ç®±',
  `phone` varchar(11) DEFAULT '' COMMENT 'æ‰‹æœºå·ç ',
  `sex` char(1) DEFAULT '0' COMMENT 'ç”¨æˆ·æ€§åˆ«ï¼ˆ0ç”· 1å¥³ 2æœªçŸ¥ï¼‰',
  `avatar` varchar(100) DEFAULT '' COMMENT 'å¤´åƒåœ°å€',
  `salt` varchar(32) DEFAULT NULL COMMENT 'ç”¨æˆ·åŠ å¯†ç›å€¼',
  `password` varchar(100) DEFAULT '' COMMENT 'å¯†ç ',
  `status` char(1) DEFAULT '0' COMMENT 'å¸å·çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰',
  `create_id` bigint(20) DEFAULT NULL COMMENT 'åˆ›å»ºäººid',
  `create_name` varchar(64) DEFAULT '' COMMENT 'åˆ›å»ºè€…',
  `create_time` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_id` bigint(20) DEFAULT NULL COMMENT 'æ›´æ–°äººid',
  `update_name` varchar(64) DEFAULT '' COMMENT 'æ›´æ–°è€…',
  `update_time` datetime DEFAULT NULL COMMENT 'æ›´æ–°æ—¶é—´',
  `delete_flag` tinyint(1) DEFAULT '0' COMMENT 'åˆ é™¤æ ‡å¿—',
  `remark` varchar(500) DEFAULT NULL COMMENT 'å¤‡æ³¨',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='ç”¨æˆ·ä¸­å¿ƒ-ç”¨æˆ·ä¿¡æ¯è¡¨';
~~~

### å¼•å…¥ä¾èµ–

é¦–å…ˆæˆ‘ä»¬åœ¨pomæ–‡ä»¶ä¸­å¼•å…¥ä¾èµ–

~~~xml
<!-- å¼•å…¥JWTç›¸å…³ -->
<dependency>
    <groupId>com.auth0</groupId>
    <artifactId>java-jwt</artifactId>
    <version>3.18.3</version>
</dependency>
~~~

### é€šç”¨ç±»

å…ˆæŠŠæˆ‘ä»¬çš„é€šç”¨ç±»åˆ›å»ºä¸€ä¸‹ï¼Œä¸€äº›å¸¸é‡ï¼Œæˆ‘ä»¬ç»Ÿä¸€æ”¾åœ¨ä¸€ä¸ªé…ç½®ä¸­ï¼Œæ–¹ä¾¿æ—¥åç»´æŠ¤ã€‚

* åœ¨config.beanåˆ›å»ºé€šç”¨ç±»`GlobalConfig.java`

```java
package com.maple.demo.config.bean;

/**
 * @author ç¬‘å°æ«
 * @date 2022/7/20
 */
public class GlobalConfig {

    private GlobalConfig() {

    }

    /**
     * ç”¨æˆ·å‚¨å­˜åœ¨redisä¸­çš„è¿‡æœŸæ—¶é—´
     */
    public static final long EXPIRE_TIME = 60 * 60 * 12L;

    /**
     * ç”Ÿæˆtokençš„ç§é’¥ï¼Œæ•°æ®åº“é¢„ç•™äº†saltå­—æ®µï¼Œå¯ä»¥æ¯ä¸ªç”¨æˆ·åˆ›å»ºæ—¶ç”Ÿæˆä¸åŒçš„ç§é’¥ï¼Œæ•°æ®å®‰å…¨æ€§æ›´é«˜ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ï¼Œæš‚ä¸æ¼”ç¤ºäº†
     */
    public static final String SECRET = "maple1223";
    
    public static final String TOKEN_NAME = "Authorization";

    /**
     * ç”¨æˆ·ç™»å½•tokenä¿å­˜åœ¨redisçš„keyå€¼
     *
     * @param account ç”¨æˆ·ç™»å½•å¸å·
     * @return tokenä¿å­˜åœ¨redisçš„key
     */
    public static String getRedisUserKey(String account) {
        return "MAPLE_ADMIN:" + account;
    }
}
```

* config.beanåˆ›å»º`TokenBean.java`ä¿å­˜çš„jwtçš„ä¿¡æ¯

~~~java
package com.maple.demo.config.bean;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.RequiredArgsConstructor;

/**
 * @author ç¬‘å°æ«
 * @date 2022/7/20
 */
@Data
@Builder
@RequiredArgsConstructor
@AllArgsConstructor
public class TokenBean {
    /**
     * ç”¨æˆ·ID
     */
    private Long userId;

    /**
     * ç”¨æˆ·è´¦å·
     */
    private String account;

    /**
     * ç”¨æˆ·ç±»å‹
     */
    private String userType;
}
~~~

### JWTå·¥å…·ç±»

åœ¨æˆ‘ä»¬çš„utilåŒ…ä¸‹åˆ›å»º`JwtUtil.java`å·¥å…·ç±»ğŸ‘‡

```java
package com.maple.demo.util;

import com.auth0.jwt.JWT;
import com.auth0.jwt.JWTVerifier;
import com.auth0.jwt.algorithms.Algorithm;
import com.auth0.jwt.exceptions.JWTDecodeException;
import com.auth0.jwt.interfaces.DecodedJWT;
import com.maple.demo.config.bean.ErrorCode;
import com.maple.demo.config.bean.GlobalConfig;
import com.maple.demo.config.bean.TokenBean;
import com.maple.demo.config.exception.MapleCheckException;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.util.Objects;

/**
 * Jwtå¸¸ç”¨æ“ä½œ
 *
 * @author ç¬‘å°æ«
 * @date 2021/12/23
 */
public class JwtUtil {

    private static final String ACCOUNT = "account";
    private static final String USER_ID = "userId";
    private static final String USER_TYPE = "userType";

    /**
     * æ ¡éªŒtokenæ˜¯å¦æ­£ç¡®
     *
     * @param token å¯†é’¥
     * @return æ˜¯å¦æ­£ç¡®
     */
    public static boolean verify(String token, String account) {
        try {
            Algorithm algorithm = Algorithm.HMAC256(GlobalConfig.SECRET);
            JWTVerifier verifier = JWT.require(algorithm).withClaim(ACCOUNT, account).build();
            verifier.verify(token);
            return true;
        } catch (Exception exception) {
            return false;
        }
    }

    /**
     * è·å¾—tokenä¸­çš„ä¿¡æ¯æ— éœ€secretè§£å¯†ä¹Ÿèƒ½è·å¾—
     *
     * @return tokenä¸­åŒ…å«çš„ç”¨æˆ·ç™»å½•å¸å·
     */
    public static String getAccount() {
        try {
            DecodedJWT jwt = getJwt();
            if (jwt == null) {
                return null;
            }
            return jwt.getClaim(ACCOUNT).asString();
        } catch (JWTDecodeException e) {
            return null;
        }
    }

    /**
     * è·å¾—tokenä¸­çš„ä¿¡æ¯æ— éœ€secretè§£å¯†ä¹Ÿèƒ½è·å¾—
     *
     * @return tokenä¸­åŒ…å«çš„ç”¨æˆ·ç™»å½•å¸å·
     */
    public static String getAccount(String token) {
        try {
            DecodedJWT jwt = JWT.decode(token);
            return jwt.getClaim(ACCOUNT).asString();
        } catch (JWTDecodeException e) {
            return null;
        }
    }

    public static Long getUserId() {
        try {
            DecodedJWT jwt = getJwt();
            if (jwt == null) {
                return null;
            }
            return jwt.getClaim(USER_ID).asLong();
        } catch (JWTDecodeException e) {
            return null;
        }
    }

    /**
     * è·å¾—tokenä¸­çš„ä¿¡æ¯æ— éœ€secretè§£å¯†ä¹Ÿèƒ½è·å¾—
     *
     * @return tokenä¸­åŒ…å«çš„ç”¨æˆ·ID
     */
    public static Long getUserId(String token) {
        try {
            DecodedJWT jwt = JWT.decode(token);
            return jwt.getClaim(USER_ID).asLong();
        } catch (JWTDecodeException e) {
            return null;
        }
    }

    public static TokenBean getTokenMsg() {
        TokenBean tokenBean = new TokenBean();
        try {
            DecodedJWT jwt = getJwt();
            if (jwt == null) {
                return tokenBean;
            }
            tokenBean.setUserId(jwt.getClaim(USER_ID).asLong());
            tokenBean.setAccount(jwt.getClaim(ACCOUNT).asString());
            return tokenBean;

        } catch (JWTDecodeException e) {
            return tokenBean;
        }
    }

    private static DecodedJWT getJwt() {
        ServletRequestAttributes servletRequestAttributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (Objects.isNull(servletRequestAttributes)) {
            throw new MapleCheckException(ErrorCode.PARAM_ERROR);
        }
        HttpServletRequest request = servletRequestAttributes.getRequest();

        String authorization = request.getHeader(GlobalConfig.TOKEN_NAME);
        if (authorization == null) {
            return null;
        }
        return JWT.decode(authorization);
    }

    /**
     * æ ¡éªŒtokenæ˜¯å¦æœ‰æ•ˆ
     *
     * @param token tokenä¿¡æ¯
     * @return è¿”å›ç»“æœ
     */
    public static boolean verifyToken(String token) {
        try {
            JWTVerifier verifier = JWT.require(Algorithm.HMAC256(GlobalConfig.SECRET)).build();
            DecodedJWT jwt = verifier.verify(token);
            jwt.getClaims();
            return true;
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
    }

    /**
     * åˆ›å»ºtoken
     *
     * @param tokenBean tokenä¿å­˜çš„ä¿¡æ¯
     * @return token
     */
    public static String createToken(TokenBean tokenBean) {
        Algorithm algorithm = Algorithm.HMAC256(GlobalConfig.SECRET);
        return JWT.create()
                .withClaim(USER_ID, tokenBean.getUserId())
                .withClaim(ACCOUNT, tokenBean.getAccount())
                .withClaim(USER_TYPE, tokenBean.getUserType())
                .sign(algorithm);
    }
}
```

### Filterç™»å½•æ‹¦æˆªå™¨

ç‰µæ‰¯åˆ°äº†ä¸‰ä¸ªå¼‚å¸¸codeï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`ErrorCode.java`é‡Œé¢è¡¥å……ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰å¼•å…¥è‡ªå®šä¹‰å¼‚å¸¸ï¼Œå¯ä»¥æ‰‹åŠ¨`throw new RuntimeException("ç¬‘å°æ«çš„å¼‚å¸¸ä¿¡æ¯")`æ›¿æ¢ä¸€ä¸‹å°±è¡Œäº†ã€‚

~~~java
NO_TOKEN("1001", "ç”¨æˆ·æœªç™»å½•"),
TOKEN_EXPIRE("1002", "ç™»é™†è¶…æ—¶ï¼Œè¯·é‡æ–°ç™»å½•"),
TOKEN_EXCHANGE("1003", "è´¦å·åœ¨å…¶ä»–åœ°æ–¹ç™»å½•ï¼Œè´¦å·è¢«è¸¢å‡º"),
USER_LOGIN_ERROR("2001", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"),
USER_STATUS_ERROR("2002", "ç”¨æˆ·å·²è¢«åœç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"),
~~~

åˆ›å»ºä¸€ä¸ªå­˜æ”¾æ‹¦æˆªå™¨çš„åŒ…`filter`ï¼Œç„¶ååœ¨åŒ…å†…åˆ›å»ºæˆ‘ä»¬çš„æ‹¦æˆªå™¨`JwtFilter`ï¼Œä»£ç å¦‚ä¸‹ï¼šğŸ‘‡

~~~java
package com.maple.demo.filter;

import com.alibaba.fastjson.JSON;
import com.maple.demo.config.bean.ErrorCode;
import com.maple.demo.config.bean.GlobalConfig;
import com.maple.demo.util.JwtUtil;
import com.maple.demo.util.RedisUtil;
import com.maple.demo.util.ResultJson;
import lombok.AllArgsConstructor;
import org.springframework.beans.factory.BeanFactory;
import org.springframework.http.HttpMethod;
import org.springframework.util.StringUtils;
import org.springframework.web.context.support.WebApplicationContextUtils;

import javax.servlet.*;
import javax.servlet.annotation.WebFilter;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.Arrays;
import java.util.List;
import java.util.regex.Pattern;

/**
 * åˆ¤æ–­ç”¨æˆ·ç™»å½•token
 *
 * @author ç¬‘å°æ«
 * @date 2022/07/20
 */
@WebFilter(filterName = "jwtFilter", urlPatterns = {"/*"})
@AllArgsConstructor
public class JwtFilter implements Filter {

    private final List<String> excludedUrlList;

    @Override
    public void init(FilterConfig filterConfig) {
        excludedUrlList.addAll(Arrays.asList(
                "/sso/login",
                "/sso/logout",
                "/example/*",
                "/webjars/**",
                "/swagger/**",
                "/v2/api-docs",
                "/doc.html",
                "/swagger-ui.html",
                "/swagger-resources/**",
                "/swagger-resources"
        ));
    }

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        String url = ((HttpServletRequest) request).getRequestURI();
        boolean isMatch = false;
        for (String excludedUrl : excludedUrlList) {
            if (Pattern.matches(excludedUrl.replace("*", ".*"), url)) {
                isMatch = true;
                break;
            }
        }
        if (isMatch) {
            chain.doFilter(request, response);
        } else {
            HttpServletRequest httpServletRequest = (HttpServletRequest) request;
            HttpServletResponse httpServletResponse = (HttpServletResponse) response;
            //å¤„ç†è·¨åŸŸé—®é¢˜ï¼Œè·¨åŸŸçš„è¯·æ±‚é¦–å…ˆä¼šå‘ä¸€ä¸ªoptionsç±»å‹çš„è¯·æ±‚
            if (httpServletRequest.getMethod().equals(HttpMethod.OPTIONS.name())) {
                chain.doFilter(request, response);
            }
            BeanFactory factory = WebApplicationContextUtils.getRequiredWebApplicationContext(request.getServletContext());
            RedisUtil redisService = (RedisUtil) factory.getBean("redisUtil");
            String account;
            String authorization = httpServletRequest.getHeader(GlobalConfig.TOKEN_NAME);
            // åˆ¤æ–­tokenæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ä»£è¡¨æœªç™»å½•
            if (StringUtils.isEmpty(authorization)) {
                writeRsp(httpServletResponse, ErrorCode.NO_TOKEN);
                return;
            } else {
                account = JwtUtil.getAccount(authorization);
                String token = (String) redisService.get(GlobalConfig.getRedisUserKey(account));
                // åˆ¤æ–­tokenæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨ä»£è¡¨ç™»é™†è¶…æ—¶
                if (StringUtils.isEmpty(token)) {
                    writeRsp(httpServletResponse, ErrorCode.TOKEN_EXPIRE);
                    return;
                } else {
                    // åˆ¤æ–­tokenæ˜¯å¦ç›¸ç­‰ï¼Œä¸ç›¸ç­‰ä»£è¡¨åœ¨å…¶ä»–åœ°æ–¹ç™»å½•
                    if (!token.equalsIgnoreCase(authorization)) {
                        writeRsp(httpServletResponse, ErrorCode.TOKEN_EXCHANGE);
                        return;
                    }
                }
            }
            // ä¿å­˜redisï¼Œæ¯æ¬¡è°ƒç”¨æˆåŠŸéƒ½åˆ·æ–°è¿‡æœŸæ—¶é—´
            redisService.set(GlobalConfig.getRedisUserKey(account), authorization, GlobalConfig.EXPIRE_TIME);
            chain.doFilter(httpServletRequest, httpServletResponse);
        }
    }

    @Override
    public void destroy() {
        Filter.super.destroy();
    }

    private void writeRsp(HttpServletResponse response, ErrorCode errorCode) {
        response.setStatus(HttpServletResponse.SC_BAD_REQUEST);
        response.setHeader("content-type", "application/json;charset=UTF-8");
        try {
            response.getWriter().println(JSON.toJSON(new ResultJson(errorCode.getCode(), errorCode.getMsg())));
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
~~~

### ç”¨æˆ·ç™»å½•æ¥å£

#### modelå’Œparam

åˆ›å»ºä¸€ä¸ªvoåŒ…å§ï¼Œåç»­çš„modelå’Œqueryå¯¹è±¡ç»Ÿä¸€æ”¾åœ¨è¿™é‡Œäº†~

åœ¨voåŒ…ä¸‹åˆ›å»ºä¸€ä¸ªqueryåŒ…ï¼Œç„¶ååˆ›å»ºç™»å½•è¯·æ±‚å¯¹è±¡`LoginQuery.java`

```java
package com.maple.demo.vo.query;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * @author ç¬‘å°æ«
 * @date 2022/7/20
 */
@Data
@ApiModel(value = "ç”¨æˆ·ç™»å½•è¯·æ±‚å¯¹è±¡", description = "ç”¨æˆ·ä¸­å¿ƒ-ç”¨æˆ·ç™»å½•è¯·æ±‚å¯¹è±¡")
public class LoginQuery {
    @ApiModelProperty(value = "ç™»å½•è´¦å·")
    private String account;

    @ApiModelProperty(value = "ç™»å½•å¯†ç ")
    private String password;
}

```

åœ¨voåŒ…ä¸‹åˆ›å»ºä¸€ä¸ªmodelåŒ…ï¼Œç„¶ååˆ›å»ºè¿”å›çš„ç”¨æˆ·ä¿¡æ¯å¯¹è±¡`UserModel.java`

```java
package com.maple.demo.vo.model;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.RequiredArgsConstructor;

/**
 * ç”¨æˆ·ä¸­å¿ƒ-ç”¨æˆ·ä¿¡æ¯
 *
 * @author ç¬‘å°æ«
 * @date 2022/7/20
 */
@Data
@Builder
@RequiredArgsConstructor
@AllArgsConstructor
@ApiModel(value = "ç”¨æˆ·è§†å›¾å¯¹è±¡", description = "ç”¨æˆ·ä¸­å¿ƒ-ç”¨æˆ·ä¿¡æ¯")
public class UserModel {

    @ApiModelProperty(value = "ç”¨æˆ·ID")
    private Long id;

    @ApiModelProperty(value = "ç”¨æˆ·è´¦å·")
    private String account;

    @ApiModelProperty(value = "ç”¨æˆ·å§“å")
    private String userName;

    @ApiModelProperty(value = "ç”¨æˆ·æ˜µç§°")
    private String nickName;

    @ApiModelProperty(value = "ç”¨æˆ·ç±»å‹")
    private String userType;

    @ApiModelProperty(value = "ç”¨æˆ·é‚®ç®±")
    private String email;

    @ApiModelProperty(value = "æ‰‹æœºå·ç ")
    private String phone;

    @ApiModelProperty(value = "ç”¨æˆ·æ€§åˆ«")
    private String sex;

    @ApiModelProperty(value = "å¤´åƒåœ°å€")
    private String avatar;

    @ApiModelProperty(value = "å¸å·çŠ¶æ€")
    private String status;

    @ApiModelProperty(value = "å¤‡æ³¨")
    private String remark;

    @ApiModelProperty(value = "ç”¨æˆ·éªŒè¯Token")
    private String token;
}
```

#### controller

```java
package com.maple.demo.controller;

import com.maple.demo.service.IUserService;
import com.maple.demo.vo.model.UserModel;
import com.maple.demo.vo.query.LoginQuery;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.AllArgsConstructor;
import org.springframework.web.bind.annotation.*;


/**
 * ç³»ç»Ÿç™»å½•
 *
 * @author ç¬‘å°æ«
 * @date 2022/12/8
 */
@Api(tags = "ç®¡ç†ç³»ç»Ÿ-ç³»ç»Ÿç™»å½•æ“ä½œ")
@RestController
@AllArgsConstructor
@RequestMapping(value = "/sso")
public class LoginController {

    private final IUserService userService;

    @ApiOperation(value = "ç”¨æˆ·ç™»å½•")
    @PostMapping("/login")
    public UserModel login(@RequestBody LoginQuery req) {
        return userService.login(req);
    }

    @ApiOperation(value = "ç”¨æˆ·é€€å‡ºç™»å½•")
    @GetMapping("/logout")
    public void logout() {
        userService.logout();
    }
}
```

#### service

```java
package com.maple.demo.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.maple.demo.entity.User;
import com.maple.demo.vo.model.UserModel;
import com.maple.demo.vo.query.LoginQuery;

/**
 * <p>
 * ç”¨æˆ·ä¸­å¿ƒ-ç”¨æˆ·ä¿¡æ¯è¡¨ æœåŠ¡ç±»
 * </p>
 *
 * @author ç¬‘å°æ«
 * @since 2022-07-11
 */
public interface IUserService extends IService<User> {
    /**
     * ç”¨æˆ·ç™»å½•
     *
     * @param req ç”¨æˆ·ä¿¡æ¯
     * @return ç”¨æˆ·ç™»å½•ä¿¡æ¯
     */
    UserModel login(LoginQuery req);

    /**
     * é€€å‡ºç³»ç»Ÿï¼Œæ¸…é™¤ç”¨æˆ·token
     */
    void logout();
}
```

#### serviceImpl

```java
package com.maple.user.service.impl;

import com.baomidou.mybatisplus.core.toolkit.Wrappers;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.maple.common.config.GlobalConfig;
import com.maple.common.config.exception.ErrorCode;
import com.maple.common.config.exception.MapleCheckException;
import com.maple.common.config.exception.MapleCommonException;
import com.maple.common.model.TokenBean;
import com.maple.common.util.JwtUtil;
import com.maple.common.util.Md5Util;
import com.maple.common.util.RedisUtil;
import com.maple.user.bean.User;
import com.maple.user.bean.UserRole;
import com.maple.user.mapper.UserMapper;
import com.maple.user.mapper.UserRoleMapper;
import com.maple.user.service.IUserService;
import com.maple.user.vo.model.UserModel;
import com.maple.user.vo.query.LoginQuery;
import lombok.AllArgsConstructor;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;


/**
 * <p>
 * ç”¨æˆ·ä¸­å¿ƒ-ç”¨æˆ·ä¿¡æ¯è¡¨ æœåŠ¡å®ç°ç±»
 * </p>
 *
 * @author Maple
 * @since 2021-12-07
 */
@Service
@AllArgsConstructor
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements IUserService {

    private final UserMapper userMapper;

    private final UserRoleMapper userRoleMapper;

    private final RedisUtil redisUtil;

    @Override
    public UserModel login(LoginQuery req) {
        User user = userMapper.selectOne(Wrappers.lambdaQuery(User.class)
                .eq(User::getAccount, req.getAccount())
                .eq(User::getUserType, "00")
                .last("LIMIT 1"));
        if (Objects.isNull(user)) {
            throw new MapleCheckException(ErrorCode.USER_LOGIN_ERROR);
        }
        if ("1".equals(user.getStatus())) {
            throw new MapleCheckException(ErrorCode.USER_STATUS_ERROR);
        }
        if (!Md5Util.verifyPassword(req.getPassword(), user.getPassword(), user.getUserName())) {
            throw new MapleCheckException(ErrorCode.USER_LOGIN_ERROR);
        }

        List<Long> userRoles = userRoleMapper.selectList(Wrappers.lambdaQuery(UserRole.class)
                .eq(UserRole::getUserId, user.getId()))
                .stream().map(UserRole::getRoleId).collect(Collectors.toList());
        TokenBean tokenBean = TokenBean.builder()
                .userId(user.getId())
                .userType(user.getUserType())
                .account(user.getUserName())
                .deptId(user.getDeptId())
                .roleList(StringUtils.join(userRoles, ","))
                .build();

        UserModel userModel = new UserModel();
        BeanUtils.copyProperties(user, userModel);
        String token;
        try {
            token = JwtUtil.createToken(tokenBean);
        } catch (Exception e) {
            log.error(e.getMessage());
            throw new MapleCommonException(ErrorCode.COMMON_ERROR);
        }
        userModel.setToken(token);
        redisUtil.set(GlobalConfig.getRedisUserKey(user.getAccount()), token);
        return userModel;
    }

    @Override
    public void logout() {
        redisUtil.remove(GlobalConfig.getRedisUserKey(JwtUtil.getAccount()));
    }
}
```

### ä½¿ç”¨JWTçš„ç”¨æˆ·ä¿¡æ¯

ç›´æ¥ä½¿ç”¨`JwtUtil.class`å·¥å…·ç±»é‡Œçš„æ–¹æ³•ï¼Œå³å¯æ‹¿åˆ°å¯¹åº”çš„æ•°æ®

~~~
JwtUtil.getUserId();
JwtUtil.getAccount();
~~~

## åŠŸèƒ½æµ‹è¯•

ç›´æ¥åœ¨`LoginController.java`é‡Œé¢æ·»åŠ `getUserId`æ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼Œè¯¦ç»†ä»£ç å¦‚ä¸‹ï¼š

~~~java
package com.maple.rest.controller.manage;

import com.maple.common.util.JwtUtil;
import com.maple.user.service.IMenuService;
import com.maple.user.service.IUserService;
import com.maple.user.vo.model.UserModel;
import com.maple.user.vo.query.LoginQuery;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.AllArgsConstructor;
import org.springframework.web.bind.annotation.*;

/**
 * ç³»ç»Ÿç™»å½•
 *
 * @author ç¬‘å°æ«
 * @date 2021/12/8
 */
@Api(tags = "ç®¡ç†ç³»ç»Ÿ-ç³»ç»Ÿç™»å½•æ“ä½œ")
@RestController
@AllArgsConstructor
@RequestMapping(value = "/sso")
public class LoginController {

    private final IUserService userService;

    private final IMenuService menuService;

    @ApiOperation(value = "ç”¨æˆ·ç™»å½•")
    @PostMapping("/login")
    public UserModel login(@RequestBody LoginQuery req) {
        return userService.login(req);
    }

    @ApiOperation(value = "ç”¨æˆ·é€€å‡ºç™»å½•")
    @GetMapping("/logout")
    public void logout() {
        userService.logout();
    }

    @ApiOperation(value = "è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯")
    @GetMapping("/getUserId")
    public String getUserId() {
        return "å½“å‰ç™»å½•ç”¨æˆ·çš„IDä¸º" + JwtUtil.getUserId();
    }
}

~~~
åœ¨æœªç™»å½•çŠ¶æ€è¯·æ±‚æ¥å£ï¼Œè¿”å›ä¿¡æ¯å¦‚ä¸‹ï¼š
![ç¬‘å°æ«-20220630155943091](http://file.xiaoxiaofeng.site/blog/image/2022/06/30/20220630155943.png)

è°ƒç”¨ç™»å½•æ¥å£ï¼Œè¿›è¡Œç”¨æˆ·ç™»å½•
![ç¬‘å°æ«-20220630160212694](http://file.xiaoxiaofeng.site/blog/image/2022/06/30/20220630160213.png)

ç™»å½•åï¼Œæ‹¿åˆ°tokenï¼Œåœ¨è¯·æ±‚å¤´è®¾ç½®`Authorization`å‚æ•°åï¼Œå†æ¬¡è°ƒç”¨ï¼Œè¿”å›ä¿¡æ¯å¦‚ä¸‹ï¼š
![ç¬‘å°æ«-20220630160319904](http://file.xiaoxiaofeng.site/blog/image/2022/06/30/20220630160320.png)

æœ¬æ–‡ä»£ç å¦‚æœç›´æ¥å¤åˆ¶ï¼Œå¯èƒ½ä¼šç¼ºå¤±ä¸€äº›ç±»ï¼Œå› ä¸ºå°ç¼–ç›´æ¥æ‘˜é€‰çš„äº†é¡¹ç›®ä¸­åœ¨ç”¨çš„åŠŸèƒ½ï¼Œæ²¡æœ‰ç²¾åŠ›å†æ¬¡é‡å¤´æ•´ç†ï¼Œä½†æ•´ä½“é€»è¾‘æ€æƒ³æ²¡æœ‰å½±å“ã€‚

åç»­æ•´ä¸ªSpringBootç³»åˆ—å®Œå–„åï¼Œä¼šæŠŠæ•´ä¸ªç³»åˆ—çš„ä»£ç è¿›è¡Œå¼€æºï¼Œå¤§å®¶å¯ä»¥ä¸‹è½½è¿›è¡Œå‚è€ƒã€‚

åç»­çš„æ–‡ç« æ›´åŠ ç²¾å½©ï¼Œä½¿ç”¨SpringBootä»0æ­å»ºæ•´ç«™ï¼Œæˆ‘ä¼šä¸€ç›´æ›´æ–°ä¸‹å»çš„ã€‚

## å…³äºç¬‘å°æ«

> æœ¬ç« åˆ°è¿™é‡Œç»“æŸäº†ï¼Œå–œæ¬¢çš„æœ‹å‹å…³æ³¨ä¸€ä¸‹æˆ‘å‘¦ï¼Œå¤§ä¼™çš„æ”¯æŒï¼Œå°±æ˜¯æˆ‘åšæŒå†™ä¸‹å»çš„åŠ¨åŠ›ã€‚
> è€è§„çŸ©ï¼Œæ‡‚äº†å°±ç‚¹èµæ”¶è—ï¼›ä¸æ‡‚å°±é—®ï¼Œæ—¥å¸¸åœ¨çº¿ï¼Œæˆ‘ä¼šå°±ä¼šå›å¤å“ˆ~
> åç»­æ–‡ç« ä¼šé™†ç»­æ›´æ–°ï¼Œæ–‡æ¡£ä¼šåŒæ­¥åœ¨å¾®ä¿¡å…¬ä¼—å·ã€ä¸ªäººåšå®¢ã€CSDNå’ŒGitHubä¿æŒåŒæ­¥æ›´æ–°ã€‚
> å¾®ä¿¡å…¬ä¼—å·ï¼šç¬‘å°æ«
> ç¬‘å°æ«ä¸ªäººåšå®¢ï¼š[https://www.xiaoxiaofeng.site](https://www.xiaoxiaofeng.site)
> CSDNï¼š[https://zhangfz.blog.csdn.net](https://zhangfz.blog.csdn.net)
> GitHubæ–‡æ¡£ï¼š[https://github.com/hack-feng/Java-Notes](https://github.com/hack-feng/Java-Notes) 
