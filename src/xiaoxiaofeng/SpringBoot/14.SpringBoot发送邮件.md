## æœ¬æ–‡ç®€ä»‹

æœ¬æ–‡ä¸»è¦ä»‹ç»äº†ä½¿ç”¨SpringBootå‘é€é‚®ä»¶ï¼Œä¸»è¦åŒ…å«å¦‚ä½•è·å–å‘é€é‚®ä»¶çš„æˆæƒç ï¼Œè¿™é‡Œä»¥QQé‚®ç®±ä¸ºä¾‹ï¼Œç„¶åä»‹ç»äº†åŠŸèƒ½å¦‚ä½•å®ç°ï¼ŒåŒ…æ‹¬é€šè¿‡æ¨¡æ¿å‘é€é‚®ä»¶ï¼Œå‘é€å¸¦å›¾ç‰‡çš„é‚®ä»¶ï¼Œå‘é€å¸¦é™„ä»¶çš„é‚®ä»¶ï¼Œå‘é€å¸¦æœ‰å¤šä¸ªé™„ä»¶çš„é‚®ä»¶ã€‚

## è·å–SMTPæˆæƒç 

ä½¿ç”¨SPringBootå‘é€é‚®ä»¶å‘¢ï¼Œé¦–å…ˆéœ€è¦å‘é€é‚®ä»¶çš„åœ°å€å¼€é€šSMTPæœåŠ¡ï¼Œå¹¶è·å–åˆ°å¯¹åº”çš„æˆæƒç ï¼Œæ¥ä¸‹æ¥å°±ä»¥QQé‚®ç®±ä¸ºä¾‹ï¼Œç®€å•çš„ä»‹ç»ä¸€ä¸‹æ€ä¹ˆå¯é€šSMTPï¼Œå¹¶ä¸”è·å–åˆ°æˆæƒç å€¼ã€‚å…·ä½“æ“ä½œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

1. é¦–å…ˆç™»å½•QQé‚®ç®±ç½‘é¡µç‰ˆï¼Œç„¶ååœ¨è®¾ç½®é‡Œé¢æ‰¾åˆ°è´¦æˆ·

![image-20220722102856334](https://s2.loli.net/2022/07/22/7zZF1XofpKwTcm8.png)

2. å¯ä»¥çœ‹åˆ°ä¸‹å›¾ä¸­çš„ä¸€å †æœåŠ¡ï¼Œæˆ‘ä»¬åªè¦å¼€é€šSMTPæœåŠ¡å³å¯ã€‚

![image-20220722103017127](https://s2.loli.net/2022/07/22/PrUYsKez2A6EBJQ.png)

3. QQé‚®ç®±å¼€é€šSMTPæœåŠ¡éœ€è¦ä½¿ç”¨å¯†ä¿æ‰‹æœºå‘é€çŸ­ä¿¡ç éªŒè¯ï¼Œæˆ‘åœ¨å‘é€çš„æ—¶å€™ï¼Œæç¤º`1069070069`è¿™ä¸ªå·ç å·²å…³é—­æœåŠ¡ï¼Œå¯ä»¥å‘é€ä¸‹é¢çš„`10690329021269`ã€‚

![image-20220722103304011](https://s2.loli.net/2022/07/22/PwMW5kXIyeU17jQ.png)

4. éªŒè¯æˆåŠŸåï¼Œå¯ä»¥çœ‹åˆ°å¯¹åº”çš„æˆæƒç ï¼Œæˆ‘ä»¬å¤åˆ¶å‡ºæ¥ï¼Œç•™ç€å¤‡ç”¨ã€‚ğŸ˜º

![image-20220722103408797](https://s2.loli.net/2022/07/22/3O7FI18lCRfLbpX.png)

### å‘é€é‚®ä»¶åŠŸèƒ½å®ç°

ä¸Šé¢æˆ‘ä»¬å·²ç»è·å–åˆ°QQé‚®ç®±çš„STMPæœåŠ¡çš„æˆæƒç ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆå®ç°åŠŸèƒ½ã€‚

* pom.xmlæ·»åŠ å¼•ç”¨
~~~xml
<!-- é…ç½®thymeleafæ¨¡æ¿ä¾èµ– -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-thymeleaf</artifactId>
</dependency>

<!-- æ”¯æŒå‘é€é‚®ä»¶ä¾èµ– -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>
~~~

* é…ç½®å‘é€é‚®ä»¶çš„application
~~~yaml
spring
  mail:
    default-encoding: UTF-8
    host: smtp.qq.com
    username: ä½ çš„é‚®ç®±åœ°å€
    password: ä½ çš„æˆæƒç 
    port: 22
    protocol: smtp
    properties:
      mail:
        smtp:
          ssl:
            enable: true
          socketFactory:
            port: 465
            class: javax.net.ssl.SSLSocketFactory
~~~

è¿™é‡Œçš„é…ç½®æ–‡ä»¶æ˜¯ä»¥QQé‚®ç®±çš„ä¸ºä¾‹ï¼Œå¦‚æœæ˜¯å…¶ä»–çš„é‚®ç®±ï¼Œå¯ä»¥å‚è€ƒè¡¨æ ¼é‡Œçš„SMTPæœåŠ¡å™¨åœ°å€å’Œå¯¹åº”çš„ç«¯å£å·ã€‚

| é‚®ç®±ç±»å‹   | SMTPæœåŠ¡å™¨åœ°å€  | ç«¯å£å·   |
| ---------- | --------------- | -------- |
| QQé‚®ç®±     | smtp.qq.com     | 465æˆ–587 |
| sinaé‚®ç®±   | smtp.sina.cn    | 465æˆ–587 |
| 126é‚®ç®±    | smtp.126.com    | 465æˆ–994 |
| aliyuné‚®ç®± | smtp.aliyun.com | 465æˆ–994 |
| 163é‚®ç®±    | smtp.163.com    | 465æˆ–994 |
| yeahé‚®ç®±   | smtp.yeah.net   | 465æˆ–994 |

* åœ¨`config.bean`åŒ…ä¸‹ç¼–å†™å‘é€é‚®ä»¶ç±»`EmailBean.java`ğŸ‘‡

~~~java
package com.maple.demo.config.bean;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.RequiredArgsConstructor;
import org.thymeleaf.context.Context;

import java.util.List;

/**
 * @author ç¬‘å°æ«
 * @date 2022/7/22
 */
@Data
@Builder
@AllArgsConstructor
@RequiredArgsConstructor
public class EmailBean {
    /**
     * å¡«å……å†…å®¹
     */
    private Context context;

    /**
     * ä½¿ç”¨æ¨¡æ¿ï¼Œå’Œtextäº’æ–¥ï¼Œä¼˜å…ˆä½¿ç”¨æ¨¡æ¿ï¼Œæ¨¡æ¿ä¸å­˜åœ¨å‘é€textå†…å®¹
     */
    private String templateName;

    /**
     * å‘é€ç»™è°
     */
    private String toUser;

    /**
     * æŠ„é€ç»™è°
     */
    private String[] ccUser;

    /**
     * é‚®ä»¶ä¸»ä½“
     */
    private String subject;

    /**
     * é‚®ä»¶å†…å®¹ï¼Œå’ŒtemplateNameäº’æ–¥ï¼Œä¼˜å…ˆä½¿ç”¨æ¨¡æ¿ï¼Œæ¨¡æ¿ä¸å­˜åœ¨å‘é€textå†…å®¹
     */
    private String text;

    /**
     * é™„ä»¶åˆ—è¡¨
     */
    private List<String> attachmentList;
}
~~~

* åœ¨`util`åŒ…ä¸‹ç¼–å†™é‚®ä»¶çš„å·¥å…·ç±»`EmailUtil.java`ğŸ‘‡

~~~java
package com.maple.demo.util;

import com.maple.demo.config.bean.EmailBean;
import lombok.RequiredArgsConstructor;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.FileSystemResource;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import org.thymeleaf.TemplateEngine;

import javax.mail.MessagingException;
import javax.mail.internet.MimeMessage;

/**
 * @author ç¬‘å°æ«
 * @date 2022/7/22
 */
@Service
@RequiredArgsConstructor
public class EmailUtil {

    private final JavaMailSender mailSender;

    private final TemplateEngine templateEngine;

    @Value("${spring.mail.username}")
    private String from;

    @Async
    public void sendEmail(EmailBean emailBean) {
        try {
            // è§£å†³é™„ä»¶åç§°è¿‡é•¿å¯¼è‡´çš„é™„ä»¶åç§°ä¹±ç é—®é¢˜
            System.setProperty("mail.mime.splitlongparameters", "false");
            // å®šä¹‰é‚®ä»¶ä¿¡æ¯
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper;
            helper = new MimeMessageHelper(message, true);
            helper.setFrom(from);
            helper.setTo(emailBean.getToUser());
            helper.setSubject(emailBean.getSubject());
            if (emailBean.getCcUser() != null && emailBean.getCcUser().length > 0) {
                helper.setCc(emailBean.getCcUser());
            }

            // å¦‚æœå­˜åœ¨æ¨¡æ¿ï¼Œå®šä¹‰é‚®ä»¶æ¨¡æ¿ä¸­çš„å†…å®¹ï¼Œcontextçš„å†…å®¹å¯¹åº”email.htmlçš„${project}å ä½çš„å†…å®¹
            if (emailBean.getContext() != null && StringUtils.isNotBlank(emailBean.getTemplateName())) {
                String emailContent = templateEngine.process(emailBean.getTemplateName(), emailBean.getContext());
                helper.setText(emailContent, true);
            } else {
                helper.setText(emailBean.getText());
            }

            // å¦‚æœå­˜åœ¨é™„ä»¶ï¼Œå®šä¹‰é‚®ä»¶çš„é™„ä»¶
            if (emailBean.getAttachmentList() != null && !emailBean.getAttachmentList().isEmpty()) {
                for (String attachment : emailBean.getAttachmentList()) {
                    FileSystemResource file = new FileSystemResource(attachment);
                    if (StringUtils.isNotBlank(file.getFilename())) {
                        helper.addAttachment(file.getFilename(), file);
                    }

                }
            }
            mailSender.send(message);
        } catch (MessagingException e) {
            e.printStackTrace();
        }
    }
}

~~~

* é…ç½®å‘é€é‚®ä»¶çš„æ¨¡æ¿
  åœ¨`resources`ç›®å½•ä¸‹åˆ›å»º`templates`ç›®å½•ã€‚åˆ›å»º`email.html`æ¨¡æ¿ã€‚

  è¿™é‡Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é…ç½®htmlé¡µé¢ï¼Œè¿™ç§æ–¹å¼æ˜¯é€šè¿‡é…ç½®thymeleafæ¨¡æ¿çš„å½¢å¼è¿›è¡Œå‘é€ï¼Œå¦‚æœç›´æ¥å¯ä»¥å‘é€æ–‡æœ¬å†…å®¹å³å¯ï¼Œåˆ™ä¸ç”¨é…ç½®ã€‚

  å¦‚æœé…ç½®çš„æ¨¡ç‰ˆæ¯”è¾ƒå¤šï¼Œä¸”ç»å¸¸å˜åŠ¨æˆ–è€…ç”±ä¸šåŠ¡äººå‘˜é…ç½®ï¼Œå¯ä»¥ç›´æ¥æ·»åŠ ä¸€å¼ é‚®ä»¶æ¨¡ç‰ˆé…ç½®è¡¨ï¼Œå‰ç«¯é€šè¿‡å¯Œæ–‡æœ¬çš„å½¢å¼è¿›è¡Œé¡µé¢é…ç½®ï¼Œç„¶åå–é‚®ä»¶æ¨¡ç‰ˆçš„é…ç½®è¡¨å†…å®¹å³å¯ã€‚ç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œè¿™é‡Œåªè¯´ä¸€ä¸‹æ€è·¯ï¼Œä¸å†è¿›è¡Œæ¼”ç¤ºï¼Œæœ‰ä»€ä¹ˆç–‘é—®å¯ä»¥ç•™è¨€æˆ–è€…è”ç³»æˆ‘ã€‚
~~~html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>xiaoxiaofeng</title>
    <style>
        body {
            text-align: center;
            margin-left: auto;
            margin-right: auto;
        }
        #main {
            text-align: center;
        }
    </style>
</head>
<body>
<div id="main">
    <h3>æ¬¢è¿ä½¿ç”¨ <span th:text="${project}"></span></h3>
    æ‚¨çš„éªŒè¯ç æ˜¯ï¼š<h2><span th:text="${code}"></span></h2>
    <span>æœ¬ç«™ç”±<a href="https://www.xiaoxiaofeng.com" target="_blank">ç¬‘å°æ«(https://www.xiaoxiaofeng.com)</a>æä¾›æŠ€æœ¯æ”¯æŒ</span>
</div>
</body>
</html>
~~~

##  åŠŸèƒ½æµ‹è¯•

ç¼–å†™ä¸€ä¸ªå‘é€é‚®ä»¶çš„æ©é¥°controllerï¼Œä¸»è¦æ¼”ç¤ºä¸¤ç§æ¨¡å¼å‘é€é‚®ä»¶

* é€šè¿‡çº¯æ–‡æœ¬å‘é€é‚®ä»¶ï¼ŒåŒ…å«é™„ä»¶
* é€šè¿‡htmlæ¨¡ç‰ˆå‘é€é‚®ä»¶

~~~java
package com.maple.demo.controller;

import com.maple.demo.config.bean.EmailBean;
import com.maple.demo.util.EmailUtil;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.AllArgsConstructor;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.thymeleaf.context.Context;

import java.util.ArrayList;
import java.util.List;

/**
 * @author ç¬‘å°æ«
 * @date 2022/7/22
 */
@RestController
@AllArgsConstructor
@RequestMapping("/example")
@Api(tags = "å®ä¾‹æ¼”ç¤º-å‘é€é‚®ä»¶")
public class TestSendEmailController {

    private final EmailUtil emailUtil;

    @PostMapping("/sendEmailText")
    @ApiOperation(value = "å‘é€çº¯æ–‡æœ¬å¸¦é™„ä»¶çš„é‚®ä»¶")
    public void sendEmailText(String text) {
        List<String> attachmentList = new ArrayList<>();
        // å®šä¹‰ç»å¯¹è·¯å¾„
        attachmentList.add("D:\\xiaoxiaofeng.jpg");
        // å®šä¹‰ç›¸å¯¹è·¯å¾„
        attachmentList.add("src/main/resources/templates/email.html");

        EmailBean emailBean = EmailBean.builder()
                .text(text)
                .subject("æ¬¢è¿ä½¿ç”¨ç¬‘å°æ«ä¸ªäººåšå®¢")
                .toUser("1150640979@qq.com")
                .attachmentList(attachmentList)
                .build();

        emailUtil.sendEmail(emailBean);
    }

    @PostMapping("/sendEmailTemplate")
    @ApiOperation(value = "æ ¹æ®htmlæ¨¡æ¿å‘é€éªŒè¯ç é‚®ä»¶")
    public void sendEmailTemplate() {
        Context context = new Context();
        context.setVariable("project", "ç¬‘å°æ«ä¸ªäººåšå®¢");
        // ç”Ÿæˆ6ä½æ•°å­—éªŒè¯ç 
        String code = String.valueOf((int) (Math.random() * 900000 + 100000));
        context.setVariable("code", code);
        EmailBean emailBean = EmailBean.builder()
                .context(context)
                .templateName("email")
                .subject("ç¬‘å°æ«å‘é€éªŒè¯ç ")
                .toUser("1150640979@qq.com")
                .build();

        emailUtil.sendEmail(emailBean);
    }
}
~~~

ä½¿ç”¨æˆ‘ä»¬çš„æ¥å£æœåŠ¡å¹³å°è¿›è¡Œè°ƒç”¨

![image-20220722155018734](https://s2.loli.net/2022/07/22/wQCSZEJTMma3F92.png)

çº¯æ–‡æœ¬çš„é‚®ä»¶çš„æµ‹è¯•ç»“æœğŸ‘‡ï¼Œå¯ä»¥çœ‹åˆ°æ·»åŠ çš„ä¸¤ä¸ªé™„ä»¶ã€‚

![image-20220722161355471](https://s2.loli.net/2022/07/22/5Q6zOqHetRvfKAC.png)

é€šè¿‡htmlæ¨¡ç‰ˆå‘é€é‚®ä»¶çš„æµ‹è¯•ç»“æœğŸ‘‡

![image-20220722154523528](https://s2.loli.net/2022/07/22/2kev4WiCDyYJjbf.png)

## å…³äºç¬‘å°æ«ğŸ’•

> æœ¬ç« åˆ°è¿™é‡Œç»“æŸäº†ï¼Œå–œæ¬¢çš„æœ‹å‹å…³æ³¨ä¸€ä¸‹æˆ‘å‘¦ğŸ˜˜ğŸ˜˜ï¼Œå¤§ä¼™çš„æ”¯æŒï¼Œå°±æ˜¯æˆ‘åšæŒå†™ä¸‹å»çš„åŠ¨åŠ›ã€‚
> è€è§„çŸ©ï¼Œæ‡‚äº†å°±ç‚¹èµæ”¶è—ï¼›ä¸æ‡‚å°±é—®ï¼Œæ—¥å¸¸åœ¨çº¿ï¼Œæˆ‘ä¼šå°±ä¼šå›å¤å“ˆ~ğŸ¤ª
> åç»­æ–‡ç« ä¼šé™†ç»­æ›´æ–°ï¼Œæ–‡æ¡£ä¼šåŒæ­¥åœ¨å¾®ä¿¡å…¬ä¼—å·ã€ä¸ªäººåšå®¢ã€CSDNå’ŒGitHubä¿æŒåŒæ­¥æ›´æ–°ã€‚ğŸ˜¬
> å¾®ä¿¡å…¬ä¼—å·ï¼šç¬‘å°æ«
> ç¬‘å°æ«ä¸ªäººåšå®¢ï¼š[https://www.xiaoxiaofeng.com](https://www.xiaoxiaofeng.com)
> CSDNï¼š[https://zhangfz.blog.csdn.net](https://zhangfz.blog.csdn.net)
> æœ¬æ–‡æºç ï¼š[https://github.com/hack-feng/maple-demo](https://github.com/hack-feng/maple-demo) 
