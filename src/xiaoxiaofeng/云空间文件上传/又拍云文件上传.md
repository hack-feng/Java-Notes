## å…³äºæœ¬æ–‡ğŸ¨

> æœ¬æ–‡ä¸»è¦è®²è¿°äº†ä½¿ç”¨åˆæ‹äº‘å½“ä½œäº‘å‚¨å­˜ç©ºé—´ï¼Œå¦‚ä½•åœ¨æ§åˆ¶å°ä½¿ç”¨ï¼Œé…ç½®æ¡¶ï¼Œé…ç½®ç®¡ç†å‘˜ä¿¡æ¯ç­‰åŠŸèƒ½ï¼Œå¹¶æä¾›SpringBootç»§æ‰¿åˆæ‹äº‘SDKçš„demoå·¥å…·ç±»ï¼Œä»¥åŠå¼€å‘ä¸­ç»å¸¸é‡åˆ°çš„é—®é¢˜ï¼Œæ“ä½œè¯¦æƒ…è¯·è§ä¸‹æ–‡ã€‚

å¿«é€Ÿä½¿ç”¨åˆæ‹äº‘ï¼ŒåŒ…æ‹¬åˆ›å»ºç©ºé—´ã€åˆ›å»ºæ“ä½œå‘˜ç­‰æ“ä½œï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ï¼Œè¯¦ç»†è§åˆæ‹äº‘å®˜æ–¹æ–‡æ¡£ï¼š

https://help.upyun.com/knowledge-base/quick_start/


## æ“ä½œæ­¥éª¤ğŸ¾

* åˆå§‹åŒ– RestManager

  ~~~java
  RestManager manager = new RestManager("ç©ºé—´åç§°", "æ“ä½œå‘˜åç§°", "æ“ä½œå‘˜å¯†ç ");
  ~~~

  > å…¶ä¸­ï¼Œç©ºé—´åç§°å³ä¸ºäº‘å­˜å‚¨çš„ã€ŒæœåŠ¡åç§°ã€ã€‚

* ä¸Šä¼ æ–‡ä»¶

  ~~~java
  public Response writeFile(String filePath, byte[] data, Map params)
  public Response writeFile(String filePath, File file, Map params)
  public Response writeFile(String filePath, InputStream inputStream, Map params)
  ~~~

  > filePath æ˜¯ä¿å­˜åˆ°åˆæ‹äº‘å­˜å‚¨çš„æ–‡ä»¶è·¯å¾„ï¼Œä»¥ / å¼€å§‹ã€‚
  >
  > ç¬¬äºŒä¸ªå‚æ•° æ¥å— InputStream ã€ File å’Œ byte[] ä¸‰ç§ç±»å‹çš„æ•°æ®ã€‚
  >
  > params ä¸Šä¼ é¢å¤–å¯é€‰å‚æ•°ï¼Œè¯¦è§ api æ–‡æ¡£ã€‚

* è¿”å›ç»“æœ

  ~~~java
  Response response = manager.writeFile(filePath, file, params);
  ~~~

  > å¦‚æœ response.isSuccessful() ä¸º trueï¼Œåˆ™è¡¨ç¤ºä¸Šä¼ æˆåŠŸï¼Œé€šè¿‡åˆæ‹äº‘ç»‘å®šçš„åŸŸå + å®šä¹‰æ–‡ä»¶çš„è·¯å¾„ å³å¯è®¿é—®æ–‡ä»¶ã€‚ä¾‹å¦‚æˆ‘çš„ filePath æ˜¯ /test/1.jpgï¼Œåˆæ‹äº‘ç»‘å®šçš„åŸŸåæ˜¯ https://www.xiaoxiaofeng.comï¼Œé‚£ä¹ˆæ–‡ä»¶çš„é“¾æ¥å³ä¸º https://www.xiaoxiaofeng.com/test/1.jpgã€‚



## æ“ä½œå·¥å…·ç±»ğŸ‘€

å·¥å…·ç±»åªæä¾›æœ€åŸºç¡€çš„æ“ä½œï¼Œè®©ä½ å¯ä»¥ä½¿ç”¨å·¥å…·ç±»å®ç°ç®€å•çš„ä¸Šä¼ åŠŸèƒ½ï¼Œæ›´å¤šåŠŸèƒ½éœ€è¦æ ¹æ®å®˜ç½‘æä¾›çš„skdè‡ªå·±æ‰©å±•ã€‚

ä»£ç ä¸­ç‰µæ‰¯åˆ°ä¸€äº›å…¶ä»–éæ ¸å¿ƒçš„ç±»ï¼Œè¿™é‡Œä¸ä¸€ä¸€è´´å‡ºæ¥äº†ï¼Œéœ€è¦çœ‹è¯¦æƒ…ï¼Œæ–‡æœ«æœ‰æºç åœ°å€ã€‚

åˆæ‹äº‘å®˜æ–¹sdkåŠç®€é™‹æ–‡æ¡£ğŸ˜‚ï¼šhttps://github.com/upyun/java-sdk

pomä¾èµ–ï¼š

~~~xml
        <!-- åˆæ‹äº‘OSS -->
        <dependency>
            <groupId>com.upyun</groupId>
            <artifactId>java-sdk</artifactId>
            <version>4.2.3</version>
        </dependency>
~~~



é…ç½®æ–‡ä»¶ï¼š

~~~yml
file:
  upy:
    bucketName: mapleBucket
    userName: æ“ä½œç”¨æˆ·åç§°
    password: æ“ä½œç”¨æˆ·å¯†ç 
    showUrl: å›æ˜¾åœ°å€-www.xiaoxiaofeng.com
~~~



FileProperties.javağŸ‘‡ğŸ‘‡ğŸ‘‡

~~~java
package com.maple.demo.config.bean;

import lombok.Data;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;

/**
 * @author ç¬‘å°æ«
 * @date 2022/7/22
 * @see <a href="https://www.xiaoxiaofeng.com">https://www.xiaoxiaofeng.com</a>
 */
@Data
@Configuration
public class FileProperties {
  
    // --------------åˆæ‹äº‘OBSé…ç½® start----------------
    /**
     * AK
     */
    @Value("${file.upy.bucketName}")
    private String upyBucketName;

    @Value("${file.upy.userName}")
    private String upyUserName;

    @Value("${file.upy.password}")
    private String upyPassword;

    @Value("${file.upy.showUrl}")
    private String upyShowUrl;
    // --------------åˆæ‹äº‘OBSé…ç½® end-------------------
    
}

~~~

UpyOssUtil.javağŸ‘‡ğŸ‘‡ğŸ‘‡


~~~java
package com.maple.demo.util.file;

import com.maple.demo.config.bean.ErrorCode;
import com.maple.demo.config.bean.FileProperties;
import com.maple.demo.config.exception.MapleCheckException;
import com.maple.demo.util.common.DateUtil;
import com.upyun.RestManager;
import com.upyun.UpException;
import lombok.AllArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import okhttp3.Response;
import org.apache.commons.compress.utils.IOUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Component;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.util.Calendar;
import java.util.Date;

/**
 * åˆæ‹äº‘ å¯¹è±¡å­˜å‚¨å·¥å…·ç±»
 * åˆæ‹äº‘å®¢æˆ·ç«¯é…ç½®ï¼šhttps://help.upyun.com/knowledge-base/quick_start/
 * åˆæ‹äº‘å®˜æ–¹sdkï¼šhttps://github.com/upyun/java-sdk
 *
 * @author ç¬‘å°æ«
 * @date 2022/7/22
 * @see <a href="https://www.xiaoxiaofeng.com">https://www.xiaoxiaofeng.com</a>
 */
@Slf4j
@Component
@AllArgsConstructor
public class UpyOssUtil {

    private final FileProperties fileProperties;

    /**
     * æ ¹æ®urlä¸Šä¼ æ–‡ä»¶åˆ°ä¸ƒç‰›äº‘
     */
    public String uploadUpy(String url) {
        String filePath = setFilePath();
        String dateStr = DateUtil.dateToStr(new Date(), DateUtil.YYMMDDHHMMSS);
        String fileName = filePath + "xxf-" + dateStr + url.substring(url.lastIndexOf("."));
        RestManager restManager = new RestManager(fileProperties.getObsBucketName(), fileProperties.getUpyUserName(), fileProperties.getUpyPassword());

        URI u = URI.create(url);
        try (InputStream inputStream = u.toURL().openStream()) {
            byte[] bytes = IOUtils.toByteArray(inputStream);
            Response response = restManager.writeFile(fileName, bytes, null);
            if (response.isSuccessful()) {
                return fileProperties.getUpyShowUrl() + fileName;
            }
        } catch (IOException | UpException e) {
            e.printStackTrace();
        }
        throw new MapleCheckException(ErrorCode.COMMON_ERROR, "åˆæ‹äº‘ossä¸Šä¼ æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•");
    }

    /**
     * MultipartFileä¸Šä¼ æ–‡ä»¶åˆ°ä¸ƒç‰›äº‘
     */
    public String uploadUpy(MultipartFile file) {
        String dateStr = DateUtil.dateToStr(new Date(), DateUtil.YYMMDDHHMMSS);
        String fileName = file.getOriginalFilename();
        if (StringUtils.isBlank(fileName)) {
            throw new MapleCheckException(ErrorCode.COMMON_ERROR, "è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥");
        }
        String objectKey = setFilePath() + dateStr + fileName.substring(file.getOriginalFilename().lastIndexOf("."));
        RestManager restManager = new RestManager(fileProperties.getObsBucketName(), fileProperties.getUpyUserName(), fileProperties.getUpyPassword());

        try (InputStream inputStream = file.getInputStream()) {
            Response response = restManager.writeFile(objectKey, inputStream, null);
            if (response.isSuccessful()) {
                return fileProperties.getUpyShowUrl() + fileName;
            }
        } catch (IOException | UpException e) {
            e.printStackTrace();
        }
        throw new MapleCheckException(ErrorCode.COMMON_ERROR, "åˆæ‹äº‘ossä¸Šä¼ æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•");
    }

    /**
     * è®¾ç½®æ–‡ä»¶ä¸Šä¼ è·¯å¾„
     */
    private String setFilePath() {
        Calendar calendar = Calendar.getInstance();
        String flag = "/";
        int year = calendar.get(Calendar.YEAR);
        int month = calendar.get(Calendar.MONTH) + 1;
        int day = calendar.get(Calendar.DATE);
        return "/spider/" + year + flag + month + flag + day + flag;
    }
}
~~~



## é‡åˆ°çš„é—®é¢˜ğŸ§

å¦‚æœä¸Šä¼ æœ‰é”™è¯¯ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ response.code() å¯¹ç…§ä¸‹é¢çš„é”™è¯¯ç è¡¨è¿›è¡Œé—®é¢˜æ’æŸ¥ã€‚

* filePath é—®é¢˜

  ç¬¬ä¸€æ¬¡ä¸Šä¼ çš„æ—¶å€™ï¼Œæˆ‘çš„ filePath åªå†™äº†ç›®å½•å /testï¼Œè¿è¡Œä¹‹åæŠ¥é”™ä¸º 406ã€‚ç„¶åæˆ‘æ‰æ˜ç™½ï¼Œè¿™ä¸ª filePath å…¶å®è¯´ç™½äº†å°±æ˜¯æŠŠæ–‡ä»¶æ”¾åˆ°åˆæ‹äº‘çš„ç›®å½•åŠ æ–‡ä»¶åï¼Œä¾‹å¦‚ /test/1.jpgï¼Œå°±æ˜¯ test ç›®å½•ä¸‹çš„ 1.jpg æ–‡ä»¶ï¼Œæ–‡ä»¶è·¯å¾„çš„åç¼€è¦å’Œæ–‡ä»¶çš„åç¼€ä¸€è‡´ã€‚

* ç¼–ç é—®é¢˜

  æˆ‘ä¼ è¾“çš„æ–‡ä»¶æ˜¯å›¾ç‰‡ï¼Œä¸”ä¸ä¼šé‡å¤ï¼Œæ‰€ä»¥æˆ‘ç›´æ¥æŠŠ file.getName() ä½œä¸ºæ–‡ä»¶åï¼Œæµ‹è¯•çš„æ—¶å€™ä¸€åˆ‡æ­£å¸¸ï¼Œä½†æ˜¯ç¨‹åºåœ¨ Windows ä¸‹ä¼šæç¤º path encoding should be utf8ï¼Œé”™è¯¯ç æ˜¯ 40000030ã€‚

  æœ€åé€šè¿‡ URLEncoder.encode(file.getName(), "UTF-8")) è§£å†³äº†é—®é¢˜ï¼Œå¦‚æœæ–‡ä»¶åæœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œä¹Ÿæ¨èå…ˆè¿›è¡Œ encodeã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ–‡ä»¶åã€‚

* æ–‡ä»¶è¦†ç›–é—®é¢˜

  è‹¥ç©ºé—´å†…æŒ‡å®šç›®å½•å·²å­˜åœ¨ç›¸åŒæ–‡ä»¶ï¼Œåˆ™ä¼šè¢«è¦†ç›–ï¼Œä¸”ä¸å¯é€†ã€‚

  ä¸Šä¼ çš„æ—¶å€™è¦ç‰¹åˆ«æ³¨æ„ï¼Œå®˜æ–¹æ¨èå¯ä»¥é€šè¿‡è·å–æ–‡ä»¶ä¿¡æ¯æ¥åˆ¤æ–­æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–‡ä»¶ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºå¦‚æœå¯¹æ–‡ä»¶åæ²¡æœ‰è¦æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ UUID æˆ–è€… MD5 ä½œä¸ºæ–‡ä»¶åï¼Œä¹Ÿå¯ä»¥é¿å…æ–‡ä»¶åé‡å¤ã€‚
  
  ## å…³äºç¬‘å°æ«ğŸ’•
  
  > æœ¬ç« åˆ°è¿™é‡Œç»“æŸäº†ï¼Œå–œæ¬¢çš„æœ‹å‹å…³æ³¨ä¸€ä¸‹æˆ‘å‘¦ï¼Œå¤§ä¼™çš„æ”¯æŒï¼Œå°±æ˜¯æˆ‘åšæŒå†™ä¸‹å»çš„åŠ¨åŠ›ã€‚
  >
  > å¾®ä¿¡å…¬ä¼—å·ï¼šç¬‘å°æ«
  >
  > ç¬‘å°æ«ä¸ªäººåšå®¢ï¼š[https://www.xiaoxiaofeng.com](https://www.xiaoxiaofeng.com)
  >
  > CSDNï¼š[https://zhangfz.blog.csdn.net](https://zhangfz.blog.csdn.net)
  >
  > æœ¬æ–‡æºç ï¼š[https://github.com/hack-feng/maple-demo](https://github.com/hack-feng/maple-demo) 
