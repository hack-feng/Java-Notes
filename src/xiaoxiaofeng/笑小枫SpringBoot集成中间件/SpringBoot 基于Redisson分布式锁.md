
## 1. åˆ†å¸ƒå¼é” 

### 1.1 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†å¸ƒå¼é” 

ä»¥ä¸‹æ˜¯ä½¿ç”¨åˆ†å¸ƒå¼é”çš„ä¸€äº›ä¸»è¦åŸå› ï¼š

1.  **ä¿æŒæ•°æ®ä¸€è‡´æ€§**ï¼š åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ•°æ®ä¸€è‡´æ€§æ˜¯è‡³å…³é‡è¦çš„ã€‚ä½¿ç”¨åˆ†å¸ƒå¼é”å¯ä»¥é˜²æ­¢å¹¶å‘æ›´æ–°å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œç¡®ä¿æ•°æ®åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¹‹é—´ä¿æŒä¸€è‡´
2.  **é¿å…é‡å¤æ‰§è¡Œ**ï¼š å½“å¤šä¸ªè¿›ç¨‹å¯èƒ½æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡æ—¶ï¼Œåˆ†å¸ƒå¼é”å¯ä»¥é˜²æ­¢ä»»åŠ¡è¢«é‡å¤æ‰§è¡Œï¼Œä¾‹å¦‚ï¼Œé˜²æ­¢å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å¤„ç†åŒä¸€æ¡æ•°æ®
3.  **èµ„æºåŒæ­¥**ï¼š åˆ†å¸ƒå¼é”å¯ä»¥ç”¨æ¥åŒæ­¥å¯¹å…±äº«èµ„æºçš„è®¿é—®ï¼Œæ¯”å¦‚æ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿæˆ–è€…å¤–éƒ¨æœåŠ¡ç­‰

### 1.2 åˆ†å¸ƒå¼é”çš„åº”ç”¨åœºæ™¯

ä»¥ä¸‹æ˜¯åˆ†å¸ƒå¼é”çš„ä¸€äº›å…·ä½“åº”ç”¨åœºæ™¯ï¼š

 *  **è®¢å•å¤„ç†**ï¼šåœ¨ç”µå­å•†åŠ¡ç³»ç»Ÿä¸­ï¼Œé¿å…å¤šä¸ªæœåŠ¡å®ä¾‹åŒæ—¶å¤„ç†åŒä¸€ä¸ªè®¢å•
 *  **åº“å­˜ç®¡ç†**ï¼šç¡®ä¿åœ¨æ›´æ–°å•†å“åº“å­˜æ—¶ä¸ä¼šå› ä¸ºå¹¶å‘æ“ä½œå¯¼è‡´åº“å­˜æ•°é‡é”™è¯¯
 *  **ä»»åŠ¡è°ƒåº¦**ï¼šåœ¨åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿä¸­ï¼Œé˜²æ­¢åŒä¸€ä¸ªä»»åŠ¡è¢«å¤šä¸ªå·¥ä½œèŠ‚ç‚¹åŒæ—¶æ‰§è¡Œ
 *  **ç¼“å­˜æ›´æ–°**ï¼šåœ¨ç¼“å­˜æ•°æ®éœ€è¦æ›´æ–°æ—¶ï¼Œé˜²æ­¢å¤šä¸ªå®ä¾‹åŒæ—¶å†™å…¥ï¼Œå¯¼è‡´ç¼“å­˜æ•°æ®ä¸ä¸€è‡´

### 1.3 åˆ†å¸ƒå¼é”çš„å®ç°åŸç†

![img](https://image.xiaoxiaofeng.site/blog/2025/01/16/xxf-20250116132140.png?xxfjava)

## 2. ä½¿ç”¨åˆ†å¸ƒå¼é”çš„æ³¨æ„äº‹é¡¹

### 2.1 å•æœºæœåŠ¡

å•æœºæœåŠ¡è™½ç„¶å¯ä»¥ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨`synchronized`ç›´æ¥åŠ é”è§£å†³é—®é¢˜ã€‚

### 2.2 é”é‡Šæ”¾é—®é¢˜

Redissonæ”¯æŒå¤šç§åŠ é”æ–¹å¼ï¼Œä¸‹é¢ç®€å•ä»‹ç»ä¸‹ã€‚

é¦–å…ˆå…ˆè·å–é”ï¼Œå¯ä»¥ä½¿ç”¨`å·¥ç¨‹å:æ–¹æ³•å:æ•°æ®å”¯ä¸€æ ‡å¿—`ç­‰å‘½åï¼Œ

`RLock lock = redissonUtil.getLock("é”åç§°");`

**java.util.concurrent.locks.Lock**ç±»é‡Œçš„åŠ é”æ¥å£


```java
/**
 * è·å–é”ã€‚å¦‚æœé”ä¸å¯ç”¨ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°†è¿›å…¥ä¼‘çœ çŠ¶æ€ç­‰å¾…ï¼Œç›´åˆ°è·å¾—é”ä¸ºæ­¢ã€‚
 * é»˜è®¤é”30sï¼Œé€šè¿‡çœ‹é—¨ç‹—è°ƒåº¦ï¼Œæ¯10sæ£€æŸ¥ä¸šåŠ¡æ˜¯å¦æ‰§è¡Œå®Œï¼Œå¦‚æœæ²¡æ‰§è¡Œå®Œï¼Œè‡ªåŠ¨ç»­æœŸä¸º30s
 */
void lock();
```

```java
/**
 * å°è¯•è·å–é”ã€‚å¦‚æœé”å¯ç”¨ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚
 * é»˜è®¤é”30sï¼Œé€šè¿‡çœ‹é—¨ç‹—è°ƒåº¦ï¼Œæ¯10sæ£€æŸ¥ä¸šåŠ¡æ˜¯å¦æ‰§è¡Œå®Œï¼Œå¦‚æœæ²¡æ‰§è¡Œå®Œï¼Œè‡ªåŠ¨ç»­æœŸä¸º30s
 */
boolean tryLock();
```

```java
/**
 * å°è¯•è·å–é”ã€‚å¦‚æœé”å¯ç”¨ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿›å…¥ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœç­‰å¾…æ—¶é—´å†…ï¼Œé”ä»ä¸å¯ç”¨ï¼Œåˆ™è¿”å›falseã€‚
 * é»˜è®¤é”30sï¼Œé€šè¿‡çœ‹é—¨ç‹—è°ƒåº¦ï¼Œæ¯10sæ£€æŸ¥ä¸šåŠ¡æ˜¯å¦æ‰§è¡Œå®Œï¼Œå¦‚æœæ²¡æ‰§è¡Œå®Œï¼Œè‡ªåŠ¨ç»­æœŸä¸º30s
 * 
 * @param time ç­‰å¾…é”çš„æœ€å¤§æ—¶é—´
 * @param unit æ—¶é—´å•ä½
 */
boolean tryLock(long time, TimeUnit unit) throws InterruptedException;
```
**org.redisson.api.RLock**ç±»é‡Œçš„åŠ é”æ¥å£

```java
/**
 * è·å–é”ã€‚å¦‚æœé”ä¸å¯ç”¨ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°†è¿›å…¥ä¼‘çœ çŠ¶æ€ç­‰å¾…ï¼Œç›´åˆ°è·å¾—é”ä¸ºæ­¢ã€‚
 * é”ä¸ä¼šé€šè¿‡çœ‹é—¨ç‹—è°ƒåº¦è¿›è¡Œè‡ªåŠ¨ç»­æœŸï¼Œè¾¾åˆ°leaseTimeçš„æ—¶é—´åï¼Œä¸è®ºä¸šåŠ¡æ˜¯å¦æ‰§è¡Œå®Œï¼Œé”éƒ½ä¼šé‡Šæ”¾æ‰
 * 
 * @param leaseTime é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´
 * @param unit æ—¶é—´å•ä½
 */
void lock(long leaseTime, TimeUnit unit);
```

```java
/**
 * å°è¯•è·å–é”ã€‚å¦‚æœé”å¯ç”¨ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿›å…¥ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœç­‰å¾…æ—¶é—´å†…ï¼Œé”ä»ä¸å¯ç”¨ï¼Œåˆ™è¿”å›falseã€‚
 * é”ä¸ä¼šé€šè¿‡çœ‹é—¨ç‹—è°ƒåº¦è¿›è¡Œè‡ªåŠ¨ç»­æœŸï¼Œè¾¾åˆ°leaseTimeçš„æ—¶é—´åï¼Œä¸è®ºä¸šåŠ¡æ˜¯å¦æ‰§è¡Œå®Œï¼Œé”éƒ½ä¼šé‡Šæ”¾æ‰
 * 
 * @param waitTime ç­‰å¾…é”çš„æœ€å¤§æ—¶é—´
 * @param leaseTime é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´
 * @param unit æ—¶é—´å•ä½
 */
boolean tryLock(long waitTime, long leaseTime, TimeUnit unit) throws InterruptedException;
```

**æ³¨æ„äº‹é¡¹ï¼š**

é’ˆå¯¹ä¸Šè¿°çš„å‡ ç§æ–¹æ³•ï¼Œæœ‰å‡ ç‚¹éœ€è¦æˆ‘ä»¬å®é™…ä½¿ç”¨çš„è¿‡ç¨‹ä¸­æƒè¡¡ã€‚

* æƒ…æ™¯ä¸€ï¼šå¦‚æœè¯·æ±‚å¿…é¡»ç­‰å¾…ä¸Šä¸€ä¸ªè¯·æ±‚æ‰§è¡Œå®Œæˆï¼Œå¦‚æœä¸Šä¸ªè¯·æ±‚æœªå®Œæˆï¼Œåˆ™æ— è„‘ç­‰å¾…ï¼›æ— è„‘ä½¿ç”¨`void lock();`å³å¯ã€‚
* æƒ…æ™¯äºŒï¼šå¦‚æœä¸æƒ³ç­‰å¾…ï¼Œè·å–ä¸åˆ°é”ï¼Œç«‹é©¬è¿”å›ï¼Œä½¿ç”¨`boolean tryLock();`ã€‚
* æƒ…æ™¯ä¸‰ï¼šå¦‚æœå¯ä»¥ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œä¸€æ®µæ—¶é—´å†…è·å–ä¸åˆ°é”ï¼Œè¿”å›çš„å¯ä»¥ä½¿ç”¨`boolean tryLock(long time, TimeUnit unit)`ã€‚
* æƒ…æ™¯å››ï¼šå¦‚æœä¸æƒ³ç­‰å¾…ï¼Œè·å–ä¸åˆ°é”ï¼Œç«‹é©¬è¿”å›ï¼Œä¸”ä¸šåŠ¡æ‰§è¡Œåˆ°æŒ‡å®šæ—¶é—´ä¸ç®¡æ˜¯å¦å®Œæˆï¼Œå¿…é¡»è¿”å›çš„ï¼Œå¯ä»¥ä½¿ç”¨`void lock(long leaseTime, TimeUnit unit);`ã€‚
* æƒ…æ™¯äº”ï¼šå¦‚æœå¯ä»¥ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œä¸”ä¸šåŠ¡æ‰§è¡Œåˆ°æŒ‡å®šæ—¶é—´ä¸ç®¡æ˜¯å¦å®Œæˆï¼Œå¿…é¡»è¿”å›çš„ï¼Œå¯ä»¥ä½¿ç”¨`boolean tryLock(long waitTime, long leaseTime, TimeUnit unit)`ã€‚

æ³¨æ„ç‚¹ï¼šå¦‚æœè®¾ç½®äº†`leaseTime`ï¼Œå®é™…æƒ…å†µä¸­ï¼Œä¸šåŠ¡æŸä¸ªèŠ‚ç‚¹æ‰§è¡Œè¶…è¿‡äº†è®¾ç½®çš„`leaseTime`æ—¶é—´ã€‚è¿™ç§æƒ…å†µä¸šåŠ¡æ•°æ®å¦‚ä½•å¤„ç†ä¸€å®šè¦è€ƒè™‘æ¸…æ¥šã€‚ä¸‹æ–‡ç¤ºä¾‹ä¸­æœ‰ç®€å•çš„æƒ…æ™¯å¤„ç†æ–¹æ³•ä¾›å‚è€ƒã€‚


## 3. Redissonå®ç°åˆ†å¸ƒå¼é”

### 3.1 å¼•å…¥ä¾èµ–

åœ¨é¡¹ç›®çš„ `pom.xml` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–

```java
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson-spring-boot-starter</artifactId>
    <version>3.16.8</version>
</dependency>
```

### 3.2 ç¼–å†™é…ç½®æ–‡ä»¶

åœ¨ `application.yml` æ–‡ä»¶ä¸­é…ç½® Redis çš„è¿æ¥ä¿¡æ¯

```java
spring:
  data:
    redis:
      host: 127.0.0.1 # RedisæœåŠ¡å™¨çš„ä¸»æœºåœ°å€
      port: 6379 # RedisæœåŠ¡å™¨çš„ç«¯å£å·
      password: 123456 # è®¿é—®RedisæœåŠ¡å™¨çš„å¯†ç 
      database: 0 # Redisæ•°æ®åº“çš„ç´¢å¼•
```

### 3.3 åˆå§‹åŒ– RedissonClient

å¦‚æœé¡¹ç›®å·²ç»ä½¿ç”¨redisï¼Œå­˜åœ¨redisçš„configé…ç½®ç±»ã€‚åˆ™æ— éœ€é…ç½®ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨Redissonã€‚

å¦åˆ™éœ€è¦é…ç½®Redissonã€‚Redisson æä¾›äº†å¤šç§é…ç½®æ–¹å¼ï¼ŒåŒ…æ‹¬å•èŠ‚ç‚¹ã€é›†ç¾¤ã€å“¨å…µç­‰ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨ Redis çš„å•èŠ‚ç‚¹é…ç½®ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºæœ¬çš„ Redisson é…ç½®ç¤ºä¾‹ï¼š

~~~java
package com.maple.redis.config;

import lombok.extern.slf4j.Slf4j;
import org.redisson.Redisson;
import org.redisson.api.RedissonClient;
import org.redisson.config.Config;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * redisson é…ç½®
 * redisson æ”¯æŒå•ç‚¹ã€ä¸»ä»ã€å“¨å…µã€é›†ç¾¤ç­‰éƒ¨ç½²æ–¹å¼
 */
@Slf4j
@Configuration
public class RedissonConfig {
    @Value("${spring.redis.host}")
    private String host;

    @Value("${spring.redis.port}")
    private int port;

    @Value("${spring.redis.password}")
    private String password;

    @Value("${spring.redis.database}")
    private Integer database;
    /**
     * redisson å®¢æˆ·ç«¯
     * @return
     */
    @Bean
    public RedissonClient redissonClient() {
        //å•ç‚¹
        Config config = new Config();
        //åœ°å€åŠå¯†ç 
        String redisUrl = String.format("redis://%s:%s", host + "", port + "");
        config.useSingleServer()
                .setAddress(redisUrl)
                .setPassword(password)
                // é‡è¯•é—´éš”
                .setRetryInterval(3000)
                // é‡è¯•æ¬¡æ•°
                .setRetryAttempts(5)
                // å‘½ä»¤ç­‰å¾…è¶…æ—¶æ—¶é—´
                .setTimeout(10000)
                // é…ç½®è¿æ¥æ± å¤§å°
                .setConnectionPoolSize(64)
                // é…ç½®æœ€å°ç©ºé—²è¿æ¥æ•°
                .setConnectionMinimumIdleSize(10)
                // é€‰æ‹©æ•°æ®åº“0
                .setDatabase(database);
        log.info("redisson å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ");
        return Redisson.create(config);

        //ä¸»ä»
//        Config config = new Config();
//        config.useMasterSlaveServers()
//            .setMasterAddress("redis://127.0.0.1:6379").setPassword("123456")
//            .addSlaveAddress("redis://127.0.0.1:6389")
//            .addSlaveAddress("redis://127.0.0.1:6399");
//        return Redisson.create(config);

        //å“¨å…µ
//        Config config = new Config();
//        config.useSentinelServers()
//            .setMasterName("myMaster")
//            .addSentinelAddress("redis://127.0.0.1:6379", "redis://127.0.0.1:6389")
//            .addSentinelAddress("redis://127.0.0.1:6399");
//        return Redisson.create(config);

        //é›†ç¾¤
//        Config config = new Config();
//        config.useClusterServers()
//                //cluster state scan interval in milliseconds
//            .setScanInterval(2000)
//            .addNodeAddress("redis://127.0.0.1:6379", "redis://127.0.0.1:6389")
//            .addNodeAddress("redis://127.0.0.1:6399");
//        return Redisson.create(config);
    }
}

~~~

å®šä¹‰ä¸€ä¸ªRedissonçš„å·¥å…·ç±»ï¼Œä¹Ÿå¯ä»¥ä¸å®šä¹‰ã€‚ä¸‹é¢ä»£ç ä¸­æœ‰ç”¨åˆ°ï¼Œæ‡’çš„å¤„ç†ä»£ç äº†ï¼Œåˆæ€•æœ‰å°ä¼™ä¼´æ‰¾ä¸åˆ°ã€‚

~~~java
package com.maple.redis.util;

import org.redisson.api.*;
import org.springframework.stereotype.Component;

import java.util.concurrent.TimeUnit;

/**
 * @author ç¬‘å°æ«  https://xiaoxiaofeng.com/
 * @date 2023/8/28
 */
@Component
public class RedissonUtil {

    private final RedissonClient client;

    public RedissonUtil(RedissonClient client) {
        this.client = client;
    }

    /**
     * å†™å…¥ç¼“å­˜
     */
    public <T> void set(String key, T value) {
        RBucket<T> rBucket = client.getBucket(key);
        rBucket.set(value);
    }

    /**
     * å†™å…¥ç¼“å­˜è®¾ç½®æ—¶æ•ˆæ—¶é—´
     */
    public <T> void set(String key, T value, long seconds) {
        RBucket<T> rBucket = client.getBucket(key);
        rBucket.set(value, seconds, TimeUnit.SECONDS);
    }

    /**
     * å†™å…¥ç¼“å­˜è®¾ç½®æ—¶æ•ˆæ—¶é—´ï¼Œå¹¶æŒ‡å®šæ—¶é—´ç±»å‹
     */
    public <T> void set(String key, T value, long timeToLive, TimeUnit timeUnit) {
        RBucket<T> rBucket = client.getBucket(key);
        rBucket.set(value, timeToLive, timeUnit);
    }

    /**
     * è·å–ç¼“å­˜å†…å®¹
     */
    public <T> T get(String key) {
        RBucket<T> rBucket = client.getBucket(key);
        return rBucket.get();
    }

    /**
     * åˆ é™¤ç¼“å­˜
     */
    public <T> boolean delete(String key) {
        RBucket<T> rBucket = client.getBucket(key);
        return rBucket.delete();
    }

    /**
     * åˆ é™¤ç¼“å­˜ï¼Œå¹¶è¿”å›ç¼“å­˜çš„å€¼
     */
    public <T> T getAndDelete(String key) {
        RBucket<T> rBucket = client.getBucket(key);
        return rBucket.getAndDelete();
    }

    /**
     * è·å–åŸå­é€’å¢Longç±»å‹å€¼
     */
    public RAtomicLong getAtomicLong(String key) {
        return client.getAtomicLong(key);
    }

    /**
     * è·å–ä¸€ä¸ªæ™®é€šçš„RMapå®ä¾‹
     */
    public <K, V> RMap<K, V> getMap(String key) {
        return client.getMap(key);
    }

    /**
     * è·å–ä¸€ä¸ªå¸¦ç¼“å­˜è‡ªåŠ¨è¿‡æœŸåŠŸèƒ½çš„RMapCacheå®ä¾‹
     */
    public <K, V> RMapCache<K, V> getMapCache(String key) {
        return client.getMapCache(key);
    }

    /**
     * è·å–RSetå®ä¾‹
     */
    public <T> RSet<T> getSet(String key) {
        return client.getSet(key);
    }

    /**
     * è·å–RListå®ä¾‹
     */
    public <T> RList<T> getList(String key) {
        return client.getList(key);
    }

    /**
     * è·å–RQueueå®ä¾‹
     */
    public <T> RQueue<T> getQueue(String key) {
        return client.getQueue(key);
    }

    /**
     * è·å–Redisé”
     * åŸºäºRedisçš„Redissonåˆ†å¸ƒå¼å¯é‡å…¥é”RLock Javaå¯¹è±¡å®ç°äº†java.util.concurrent.locks.Lockæ¥å£ã€‚
     */
    public RLock getLock(String key) {
        return client.getLock(key);
    }

    /**
     * è·å–Rediså…¬å¹³é”
     * å®ƒä¿è¯äº†å½“å¤šä¸ªRedissonå®¢æˆ·ç«¯çº¿ç¨‹åŒæ—¶è¯·æ±‚åŠ é”æ—¶ï¼Œä¼˜å…ˆåˆ†é…ç»™å…ˆå‘å‡ºè¯·æ±‚çš„çº¿ç¨‹ã€‚
     */
    public RLock getFairLock(String key) {
        return client.getFairLock(key);
    }

    /**
     * Redisäº‹åŠ¡
     * Redissonäº‹åŠ¡é€šè¿‡åˆ†å¸ƒå¼é”ä¿è¯äº†è¿ç»­å†™å…¥çš„åŸå­æ€§ï¼ŒåŒæ—¶åœ¨å†…éƒ¨é€šè¿‡æ“ä½œæŒ‡ä»¤é˜Ÿåˆ—å®ç°äº†RedisåŸæœ¬æ²¡æœ‰çš„æäº¤ä¸æ»šå›åŠŸèƒ½ã€‚
     */
    public RTransaction getTransaction() {
        TransactionOptions options = TransactionOptions.defaults()
                // è®¾ç½®å‚ä¸æœ¬æ¬¡äº‹åŠ¡çš„ä¸»èŠ‚ç‚¹ä¸å…¶ä»èŠ‚ç‚¹åŒæ­¥çš„è¶…æ—¶æ—¶é—´, é»˜è®¤å€¼æ˜¯5ç§’ã€‚
                .syncSlavesTimeout(5, TimeUnit.SECONDS)
                // å¤„ç†ç»“æœè¶…æ—¶, é»˜è®¤å€¼æ˜¯3ç§’ã€‚
                .responseTimeout(3, TimeUnit.SECONDS)
                // å‘½ä»¤é‡è¯•ç­‰å¾…é—´éš”æ—¶é—´ã€‚ä»…é€‚ç”¨äºæœªå‘é€æˆåŠŸçš„å‘½ä»¤,  é»˜è®¤å€¼æ˜¯1.5ç§’ã€‚
                .retryInterval(2, TimeUnit.SECONDS)
                // å‘½ä»¤é‡è¯•æ¬¡æ•°ã€‚ä»…é€‚ç”¨äºæœªå‘é€æˆåŠŸçš„å‘½ä»¤, é»˜è®¤å€¼æ˜¯3æ¬¡ã€‚
                .retryAttempts(3)
                // äº‹åŠ¡è¶…æ—¶æ—¶é—´ã€‚å¦‚æœè§„å®šæ—¶é—´å†…æ²¡æœ‰æäº¤è¯¥äº‹åŠ¡åˆ™è‡ªåŠ¨æ»šå›, é»˜è®¤å€¼æ˜¯5ç§’ã€‚
                .timeout(5, TimeUnit.SECONDS);
        return client.createTransaction(options);
    }
}
~~~





### 3.4 åˆ†å¸ƒå¼é”çš„ä½¿ç”¨

é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªgetè¯·æ±‚çš„æ–¹æ³•ï¼Œæ–¹æ³•ä¸­å¤šä¸ªçº¿ç¨‹æ¨¡æ‹Ÿå¹¶å‘è¯·æ±‚

å¯åŠ¨10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªä¸šåŠ¡ä¼‘çœ 50msï¼Œæ¨¡æ‹Ÿå¤„ç†ä¸šåŠ¡

~~~java
    @GetMapping("/handleStockRedisLock")
    public void handleStockRedisLock() {
        ExecutorService threadPool = new ThreadPoolExecutor(
                5,
                10,
                2L,
                TimeUnit.SECONDS,
                new ArrayBlockingQueue<>(5),
                Executors.defaultThreadFactory(),
                new ThreadPoolExecutor.DiscardOldestPolicy());
        Random random = new Random();
        redisUtil.set("maple:stock", 100);
        for (int i = 1; i <= 10; i++) {
            int finalI = i;
            threadPool.execute(() -> testLockService.handleStockRedisLock(finalI, random.nextInt(10) + 1, 50L));
        }
    }
~~~

çœ‹ä¸‹å®ç°

~~~java
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void handleStockRedisLock(Integer index, Integer buyNum, Long sleepTime) {
        RLock lock = redissonUtil.getLock("handleStockRedisLock");
        boolean isOk = false;
        try {
            // å°è¯•è·å–é”ï¼Œç­‰å¾…5sï¼Œ5så†…æ²¡æœ‰è·å–åˆ°é”ï¼ŒisOk=false;
            // ä¸šåŠ¡æ‰§è¡Œ30sï¼Œ30åæœªæ‰§è¡Œå®Œä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œlock.unlock()å†æ¬¡æ‰§è¡Œé‡Šæ”¾é”æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸
            isOk = lock.tryLock(5, 30, TimeUnit.SECONDS);
            if (!isOk) {
                log.error("ç¬¬" + index + "æ¬¡ï¼Œè·å–åˆ†å¸ƒå¼é”å¤±è´¥");
                return;
            }
            // ä¸šåŠ¡ä¼ªä»£ç 
            int stockNum = redissonUtil.get("maple:stock");
            log.info("ç¬¬" + index + "æ¬¡ï¼Œè´­ä¹°å•†å“" + buyNum + "ï¼Œè·å–åº“å­˜ï¼Œåº“å­˜æ•°ï¼š" + stockNum);
            Thread.sleep(sleepTime);
            redissonUtil.set("maple:stock", stockNum - buyNum);
            log.info("ç¬¬" + index + "æ¬¡ï¼Œå¤„ç†åçš„åº“å­˜æ•°ï¼š" + redissonUtil.get("maple:stock"));
        } catch (InterruptedException e) {
            log.error("çº¿ç¨‹ä¸­æ–­");
            Thread.currentThread().interrupt();
        } finally {
            if (isOk) {
                log.info("ç¬¬" + index + "æ¬¡ï¼Œé‡Šæ”¾é”");
                lock.unlock();
            }
        }
    }
~~~

#### 3.4.1 æ­£å¸¸æ‰§è¡Œç»“æœ

å…ˆçœ‹ä¸‹æ­£å¸¸çš„æ‰§è¡Œï¼Œçº¿ç¨‹ä¾æ¬¡æ‰§è¡Œã€‚

![image-20250115111307945](https://image.xiaoxiaofeng.site/blog/2025/01/15/xxf-20250115111308.png?xxfjava)

#### 3.4.2 è·å–é”å¤±è´¥æ‰§è¡Œç»“æœ

å†çœ‹ä¸‹è·å–é”å¤±è´¥çš„æƒ…æ™¯ï¼Œå› ä¸ºé”çš„ç­‰å¾…æ—¶é—´æ˜¯5sï¼Œè°ƒæ•´ä¸šåŠ¡å¤„ç†ä¼‘çœ æ—¶é—´sleepTimeä¸º3sï¼Œå°±ä¼šæœ‰éƒ¨åˆ†çº¿ç¨‹è·å–ä¸åˆ°é”

![image-20250115111235107](https://image.xiaoxiaofeng.site/blog/2025/01/15/xxf-20250115111235.png?xxfjava)

#### 3.4.3 ä¸šåŠ¡æ‰§è¡Œè¶…æ—¶æ‰§è¡Œç»“æœ

å†çœ‹ä¸‹ä¸šåŠ¡æ‰§è¡Œè¶…æ—¶çš„æƒ…æ™¯ï¼Œè°ƒæ•´é”çš„ç¦»å¼€æ—¶é—´ï¼ˆleaseTimeï¼‰ä¸º5sï¼Œè°ƒæ•´ä¸šåŠ¡å¤„ç†ä¼‘çœ æ—¶é—´sleepTimeä¸º6sï¼Œå³å¯æ¨¡æ‹Ÿ

å› ä¸º5sçš„æ—¶å€™ï¼ŒRLockä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œä¸šåŠ¡6sæ‰§è¡Œå®Œåï¼Œä»ç„¶ä¼šæ‰§è¡Œfinallyä»£ç å—çš„`lock.unlock()`ï¼Œå› ä¸ºé”å·²é‡Šæ”¾ï¼Œæ‰€ä»¥æŠ›å‡ºå¼‚å¸¸ã€‚

å¦‚æœæ•°æ®å¤„ç†éƒ½åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œé¢ï¼Œè¶…æ—¶éœ€è¦å›æ»šæ•°æ®ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨`@Transactional(rollbackFor = Exception.class)`äº‹åŠ¡å›æ»šã€‚å¦‚æœæœ‰å…¶ä»–å¼‚æ­¥æ•°æ®å¤„ç†ï¼Œå¯ä»¥æ•æ‰å¼‚å¸¸è¿›è¡Œå¤„ç†ã€‚

**å»ºè®®ï¼š**å¯ä»¥æŠŠéå¿…è¦ä¸šåŠ¡é€»è¾‘ç§»é™¤é”çš„ä»£ç å—ï¼Œå°½é‡å‡å°‘é”çš„ä»£ç å—é€»è¾‘ï¼Œåˆç†çš„å®‰æ’leaseTimeçš„æ—¶é—´ã€‚

![image-20250115144249513](https://image.xiaoxiaofeng.site/blog/2025/01/15/xxf-20250115144249.png?xxfjava)

#### 3.4.4 åŠ é”æ—¶ï¼Œredisçš„æ•°æ®æƒ…å†µ

åŠ é”è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ°redisä¸­ï¼Œå‡ºç°äº†ä¸€ä¸ªHASHç±»å‹çš„æ•°æ®ï¼Œkeyå¯¹ç”¨æˆ‘ä»¬çš„é”åç§°ï¼Œæœ‰æ•ˆæœŸæ˜¯æˆ‘ä»¬è®¾ç½®çš„leaseTimeæ—¶é—´æˆ–æœªè®¾ç½®æ—¶é»˜è®¤çš„30s

![image-20250116110647210](https://image.xiaoxiaofeng.site/blog/2025/01/16/xxf-20250116110647.png?xxfjava)

## 4. åŸºäºæ³¨è§£çš„å®ç°

ä¸ºäº†æ–¹ä¾¿åˆ†å¸ƒå¼é”çš„æ—¥å¸¸ä½¿ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨è§£çš„å½¢å¼ï¼Œç„¶åé€šè¿‡Aopåˆ‡é¢ï¼Œç›´æ¥é”æ•´ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨æ—¶ä¸šåŠ¡æ— ä¾µå…¥ï¼Œæ–¹ä¾¿å¿«æ·ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ–¹æ³•é‡Œçš„ä¸šåŠ¡å¤„ç†æ¯”è¾ƒå¤šï¼Œä¸å»ºè®®ç›´æ¥ä½¿ç”¨æ³¨è§£ï¼Œå¯ä»¥å°†ä¸šåŠ¡æ‹†åˆ†ï¼Œæˆ–è€…é’ˆå¯¹éœ€è¦åŠ é”çš„ä¸šåŠ¡é’ˆå¯¹æ€§çš„ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚

### 4.1 å®šä¹‰æ³¨è§£

~~~java
package com.maple.redis.util;

import java.lang.annotation.*;
import java.util.concurrent.TimeUnit;

/**
 * ä½¿ç”¨redisè¿›è¡Œåˆ†å¸ƒå¼é”
 * @author ç¬‘å°æ«
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RedisLock {

    /**
     * redisé” åå­—
     */
    String lockName() default "";

    /**
     * redisé” key æ”¯æŒspelè¡¨è¾¾å¼
     */
    String key() default "";

    /**
     * ç­‰å¾…æ¯«ç§’æ•°,é»˜è®¤ä¸º5000æ¯«ç§’
     *
     * @return æœ€å¤§ç­‰å¾…æ¯«ç§’æ•°
     */
    int waitTime() default 5000;

    /**
     * è¿‡æœŸæ¯«ç§’æ•°,é»˜è®¤ä¸º-1 ä¸è‡ªåŠ¨è§£é”
     *
     * @return è½®è¯¢é”çš„æ—¶é—´
     */
    int leaseTime() default -1;

    /**
     * è¶…æ—¶æ—¶é—´å•ä½
     *
     * @return ç§’
     */
    TimeUnit timeUnit() default TimeUnit.MILLISECONDS;
}
~~~

### 4.2 å®šä¹‰åˆ‡é¢

~~~java
/*
 * Copyright (c) 2018-2999 ä¸Šæµ·åˆé½è½¯ä»¶ç§‘æŠ€ç§‘æŠ€æœ‰é™å…¬å¸ All rights reserved.
 *
 *
 *
 * æœªç»å…è®¸ï¼Œä¸å¯åšå•†ä¸šç”¨é€”ï¼
 *
 * ç‰ˆæƒæ‰€æœ‰ï¼Œä¾µæƒå¿…ç©¶ï¼
 */

package com.maple.redis.util;

import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.Signature;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.reflect.MethodSignature;
import org.redisson.api.RLock;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.expression.MethodBasedEvaluationContext;
import org.springframework.core.LocalVariableTableParameterNameDiscoverer;
import org.springframework.expression.ExpressionParser;
import org.springframework.expression.spel.standard.SpelExpressionParser;
import org.springframework.expression.spel.support.StandardEvaluationContext;
import org.springframework.stereotype.Component;

import java.lang.reflect.Method;

/**
 * @author lgh
 */
@Aspect
@Component
public class RedisLockAspect {

    @Autowired
    private RedissonUtil redissonUtil;

    private static final String REDISSON_LOCK_PREFIX = "redisson_lock:";

    @Around("@annotation(redisLock)")
    public Object around(ProceedingJoinPoint joinPoint, RedisLock redisLock) throws Throwable {
        String spel = redisLock.key();
        String lockName = redisLock.lockName();
        RLock rLock = redissonUtil.getLock(getRedisKey(joinPoint, lockName, spel));
        Object result;
        boolean isLock = false;
        try {
            isLock = rLock.tryLock(redisLock.waitTime(), redisLock.leaseTime(), redisLock.timeUnit());
            if (!isLock) {
                throw new RuntimeException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·é‡è¯•");
            }
            //æ‰§è¡Œæ–¹æ³•
            result = joinPoint.proceed();
        } finally {
            if (isLock) {
                rLock.unlock();
            }
        }
        return result;
    }

    /**
     * å°†spelè¡¨è¾¾å¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²
     *
     * @param joinPoint åˆ‡ç‚¹
     * @return redisKey
     */
    private String getRedisKey(ProceedingJoinPoint joinPoint, String lockName, String spel) {
        Signature signature = joinPoint.getSignature();
        MethodSignature methodSignature = (MethodSignature) signature;
        Method targetMethod = methodSignature.getMethod();
        Object target = joinPoint.getTarget();
        Object[] arguments = joinPoint.getArgs();
        return REDISSON_LOCK_PREFIX + lockName + ":" + parse(target, spel, targetMethod, arguments);
    }


    /**
     * æ”¯æŒ #p0 å‚æ•°ç´¢å¼•çš„è¡¨è¾¾å¼è§£æ
     *
     * @param rootObject æ ¹å¯¹è±¡,method æ‰€åœ¨çš„å¯¹è±¡
     * @param spel       è¡¨è¾¾å¼
     * @param method     ï¼Œç›®æ ‡æ–¹æ³•
     * @param args       æ–¹æ³•å…¥å‚
     * @return è§£æåçš„å­—ç¬¦ä¸²
     */
    public static String parse(Object rootObject, String spel, Method method, Object[] args) {
        if (spel == null || "".equals(spel)) {
            return "";
        }
        //è·å–è¢«æ‹¦æˆªæ–¹æ³•å‚æ•°ååˆ—è¡¨(ä½¿ç”¨Springæ”¯æŒç±»åº“)
        LocalVariableTableParameterNameDiscoverer u =
                new LocalVariableTableParameterNameDiscoverer();
        String[] paraNameArr = u.getParameterNames(method);
        if (paraNameArr == null || paraNameArr.length == 0) {
            return spel;
        }
        //ä½¿ç”¨SPELè¿›è¡Œkeyçš„è§£æ
        ExpressionParser parser = new SpelExpressionParser();
        //SPELä¸Šä¸‹æ–‡
        StandardEvaluationContext context = new MethodBasedEvaluationContext(rootObject, method, args, u);
        //æŠŠæ–¹æ³•å‚æ•°æ”¾å…¥SPELä¸Šä¸‹æ–‡ä¸­
        for (int i = 0; i < paraNameArr.length; i++) {
            context.setVariable(paraNameArr[i], args[i]);
        }
        return parser.parseExpression(spel).getValue(context, String.class);
    }
}
~~~

### 4.3 å®šä¹‰ä¸€ä¸ªæµ‹è¯•æ–¹æ³•

~~~java
    @GetMapping("/handleStockRedisLockAnnotation")
    public void handleStockRedisLockAnnotation() {
        ExecutorService threadPool = new ThreadPoolExecutor(
                5,
                10,
                2L,
                TimeUnit.SECONDS,
                new ArrayBlockingQueue<>(5),
                Executors.defaultThreadFactory(),
                new ThreadPoolExecutor.DiscardOldestPolicy());
        Random random = new Random();
        redisUtil.set("maple:stock", 100);
        for (int i = 1; i <= 10; i++) {
            int finalI = i;
            threadPool.execute(() -> testLockService.handleStockRedisLockAnnotation(finalI, random.nextInt(10) + 1, 600L));
        }
    }
~~~

### 4.4 å®šä¹‰ä¸€ä¸ªå®ç°æ¥å£

~~~java
    @SneakyThrows
    @Override
    @RedisLock(lockName = "handleStockRedisLockAnnotation")
    public void handleStockRedisLockAnnotation(Integer index, Integer buyNum, Long sleepTime) {
        handle(index, buyNum, sleepTime);
    }

    private void handle(Integer index, Integer buyNum, Long sleepTime) throws InterruptedException {
        int stockNum = redissonUtil.get("maple:stock");
        log.info("ç¬¬" + index + "æ¬¡ï¼Œè´­ä¹°å•†å“" + buyNum + "ï¼Œè·å–åº“å­˜ï¼Œåº“å­˜æ•°ï¼š" + stockNum);
        Thread.sleep(sleepTime);
        redissonUtil.set("maple:stock", stockNum - buyNum);
        log.info("ç¬¬" + index + "æ¬¡ï¼Œå¤„ç†åçš„åº“å­˜æ•°ï¼š" + redissonUtil.get("maple:stock"));
    }
~~~

### 4.5 æµ‹è¯•ç»“æœ

è·‘10ä¸ªçº¿ç¨‹ï¼Œä¸šåŠ¡å¤„ç†600msï¼Œé”ç­‰å¾…å®šä¹‰5sï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚

![image-20250116160023011](https://image.xiaoxiaofeng.site/blog/2025/01/16/xxf-20250116160023.png?xxfjava)

## 5. æœ¬æ–‡æºç 

ä½¿ç”¨Redisçš„è¿‡ç¨‹ä¸­è¿˜ä¼šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚ç¼“å­˜æ•°æ®ä¸€è‡´æ€§ï¼Œç¼“å­˜æ•°æ®æŒä¹…åŒ–ï¼Œå†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œç¼“å­˜é›ªå´©ç­‰ç­‰ç­‰ï¼Œåœ¨é¢è¯•çš„æ—¶å€™ä¹Ÿç»å¸¸ä¼šç”¨åˆ°ï¼Œåšä¸»æ•´ç†äº†ä¸€ä»½Rediså¸¸è§çš„é¢è¯•ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥çœ‹ä¸‹ï¼š

[ã€é¢è¯•1v1å®æ™¯æ¨¡æ‹Ÿã€‘Redisé¢è¯•å®˜ä¼šæ€ä¹ˆæé—®ï¼Ÿ](https://www.xiaoxiaofeng.com/archives/interviewredis)

æœ¬æ–‡æºç ï¼š[https://github.com/hack-feng/maple-product/](https://github.com/hack-feng/maple-product/)

å…¶ä¸­`maple-redis`æ¨¡å—å³ä¸ºæœ¬æ–‡çš„Demoæºç ã€‚éœ€è¦çš„æœ‹å‹å¯ä»¥çœ‹ä¸‹ã€‚

æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å¸®å¿™ç‚¹ä¸ªstarâ­â­â­â­â­åç»­ä¼šæœ‰æ›´å¤šJavaç›¸å…³çš„é›†æˆDemoï¼Œè®©æˆ‘æ¥åšä½ çš„ç™¾å®è¢‹å§ã€‚

> ğŸ¾æˆ‘æ˜¯ç¬‘å°æ«ï¼Œå…¨ç½‘çš†å¯æœçš„ã€[ç¬‘å°æ«](https://www.xiaoxiaofeng.com)ã€‘
