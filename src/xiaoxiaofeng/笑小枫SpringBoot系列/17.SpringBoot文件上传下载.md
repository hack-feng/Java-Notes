## æœ¬æ–‡ç®€ä»‹ğŸ¨

åœ¨javaå¼€å‘ä¸­æ–‡ä»¶çš„ä¸Šä¼ ã€ä¸‹è½½ã€åˆ é™¤åŠŸèƒ½è‚¯å®šæ˜¯å¾ˆå¸¸è§çš„ï¼Œæœ¬æ–‡ä¸»è¦åŸºäºä¸Šä¼ å›¾ç‰‡æˆ–æ–‡ä»¶åˆ°æŒ‡å®šçš„ä½ç½®å±•å¼€ï¼Œé€šè¿‡è¯¦ç»†çš„ä»£ç å’Œå·¥å…·ç±»ï¼Œè®²è¿°javaå¦‚ä½•å®ç°æ–‡ä»¶çš„ä¸Šä¼ ã€ä¸‹è½½ã€åˆ é™¤ã€‚

åç»­æˆ‘ä¼šé›†æˆæ›´å¤šçš„äº‘å­˜å‚¨ç©ºé—´ä¸Šä¼ ï¼Œåƒé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€åä¸ºäº‘ã€åˆæ‹äº‘ç­‰ç­‰ï¼Œæœ¬æ–‡åç»­ä¼šæŠŠè¿™äº›ç›¸å…³çš„ä¸Šä¼ æ“ä½œä»¥é“¾æ¥çš„å½¢å¼é›†æˆåˆ°æœ¬æ–‡ä¸­ï¼Œåˆ°å®¶å¯ä»¥å…ˆç‚¹ä¸ªå…³æ³¨å‘¦ã€‚

æœ¬æ–‡è®¾è®¡åˆ°çš„æ‰€æœ‰ä»£ç ï¼Œå‡åœ¨æ–‡æœ«çš„githubå¼€æºé¡¹ç›®é‡Œï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å¸®å¿™ç‚¹ä¸ªstarğŸ˜˜ğŸ˜˜ğŸ˜˜

## åŠŸèƒ½å®ç°ğŸ§

> è¯ä¸å¤šè¯´ï¼Œç›´æ¥å¼€æ•´

é¦–å…ˆï¼Œéœ€è¦åœ¨ymlé…ç½®æ–‡ä»¶é‡Œé¢é…ç½®æ–‡ä»¶ä¸Šä¼ çš„è·¯å¾„ï¼Œè¿™é‡Œè®¾æƒ³çš„æ˜¯å›¾ç‰‡ä¸€ä¸ªç›®å½•ï¼Œæ–‡ä»¶ä¸€ä¸ªç›®å½•ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ¼”ç¤ºï¼Œå¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œé…ç½®ã€‚

~~~yml
file:
  local:
    maxFileSize: 10485760
    imageFilePath: D:/test/image/
    docFilePath: D:/test/file/
~~~

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸‹åŠŸèƒ½å®ç°çš„æ ¸å¿ƒä»£ç ã€‚

> è¿™é‡Œåªæ˜¯ä¸ºäº†å±•ç¤ºåŠŸèƒ½å®ç°ï¼Œä¸€äº›éç›¸å…³çš„ä»£ç æ²¡æœ‰è´´ï¼Œå¯ä»¥åœ¨æ–‡æœ«githubæºç é‡Œé¢æŸ¥çœ‹æ›´å¤šã€‚

è¿™é‡Œæ˜¯é…ç½®æ–‡ä»¶çš„ä¸€ä¸ªé…ç½®ç±»ï¼Œè¿™è¦ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ymlé…ç½®æ–‡ä»¶é‡Œé¢çš„é…ç½®ã€‚

~~~java
package com.maple.demo.config.bean;

import lombok.Data;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;

/**
 * @author ç¬‘å°æ«
 * @date 2022/7/22
 * @see <a href="https://www.xiaoxiaofeng.com">https://www.xiaoxiaofeng.com</a>
 */
@Data
@Configuration
public class FileProperties {
    // ---------------æœ¬åœ°æ–‡ä»¶é…ç½® start------------------
    /**
     * å›¾ç‰‡å­˜å‚¨è·¯å¾„
     */
    @Value("${file.local.imageFilePath}")
    private String imageFilePath;
    
    /**
     * æ–‡æ¡£å­˜å‚¨è·¯å¾„
     */
    @Value("${file.local.docFilePath}")
    private String docFilePath;

    /**
     * æ–‡ä»¶é™åˆ¶å¤§å°
     */
    @Value("${file.local.maxFileSize}")
    private long maxFileSize;
    // --------------æœ¬åœ°æ–‡ä»¶é…ç½® end-------------------
    
}

~~~

å®šä¹‰`WebMvcConfig`å®ç°`WebMvcConfigurer`ï¼ŒæŒ‡å‘æˆ‘ä»¬æ–‡ä»¶çš„å­˜æ”¾è·¯å¾„ã€‚

~~~java
package com.maple.demo.config;

import com.maple.demo.config.bean.FileProperties;
import lombok.AllArgsConstructor;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

/**
 * @author ç¬‘å°æ«
 * @date 2022/7/22
 * @see <a href="https://www.xiaoxiaofeng.com">https://www.xiaoxiaofeng.com</a>
 */
@Configuration
@AllArgsConstructor
public class WebMvcConfig implements WebMvcConfigurer {

    private final FileProperties fileProperties;

    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        //é‡å†™æ–¹æ³•
        //ä¿®æ”¹tomcat è™šæ‹Ÿæ˜ å°„
        //å®šä¹‰å›¾ç‰‡å­˜æ”¾è·¯å¾„ è¿™é‡ŒåŠ /exampleæ˜¯ä¸ºäº†æµ‹è¯•é¿å¼€ç³»ç»Ÿçš„tokenæ ¡éªŒï¼Œå®é™…è®¿é—®åœ°å€æ ¹æ®è‡ªå·±éœ€æ±‚æ¥
        registry.addResourceHandler("/example/images/**").
                addResourceLocations("file:" + fileProperties.getImageFilePath());
        //å®šä¹‰æ–‡æ¡£å­˜æ”¾è·¯å¾„
        registry.addResourceHandler("/example/doc/**").
                addResourceLocations("file:" + fileProperties.getDocFilePath());
    }
}

~~~

æ–‡ä»¶ä¸Šä¼ ä¸‹è½½çš„æ ¸å¿ƒå·¥å…·ç±»ğŸ˜‰ï¼Œæƒ³ç™½å«–çš„ï¼Œcopyå®ƒå°±å¯¹äº†...

~~~java
package com.maple.demo.util.file;

import com.maple.demo.config.bean.ErrorCode;
import com.maple.demo.config.bean.FileProperties;
import com.maple.demo.config.exception.MapleCheckException;
import lombok.AllArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Component;
import org.springframework.web.multipart.MultipartFile;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletResponse;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.text.SimpleDateFormat;
import java.util.*;

/**
 * @author ç¬‘å°æ«
 * @date 2022/7/22
 * @see <a href="https://www.xiaoxiaofeng.com">https://www.xiaoxiaofeng.com</a>
 */
@Slf4j
@Component
@AllArgsConstructor
public class FileUtil {

    private final FileProperties fileProperties;


    private static final List<String> FILE_TYPE_LIST_IMAGE = Arrays.asList(
            "image/png",
            "image/jpg",
            "image/jpeg",
            "image/bmp");

    public String uploadImage(MultipartFile file) {
        // æ£€æŸ¥å›¾ç‰‡ç±»å‹
        String contentType = file.getContentType();
        if (!FILE_TYPE_LIST_IMAGE.contains(contentType)) {
            throw new MapleCheckException(ErrorCode.COMMON_ERROR, "ä¸Šä¼ å¤±è´¥ï¼Œä¸å…è®¸çš„æ–‡ä»¶ç±»å‹");
        }
        int size = (int) file.getSize();
        if (size > fileProperties.getMaxFileSize()) {
            throw new MapleCheckException(ErrorCode.COMMON_ERROR, "æ–‡ä»¶è¿‡å¤§");
        }
        String fileName = file.getOriginalFilename();
        //è·å–æ–‡ä»¶åç¼€
        String afterName = StringUtils.substringAfterLast(fileName, ".");
        //è·å–æ–‡ä»¶å‰ç¼€
        String prefName = StringUtils.substringBeforeLast(fileName, ".");
        //è·å–ä¸€ä¸ªæ—¶é—´æ¯«ç§’å€¼ä½œä¸ºæ–‡ä»¶å
        fileName = new SimpleDateFormat("yyyyMMddHHmmss").format(new Date()) + "_" + prefName + "." + afterName;
        File filePath = new File(fileProperties.getImageFilePath(), fileName);

        //åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å·²ç»å­˜åœ¨
        if (filePath.exists()) {
            throw new MapleCheckException(ErrorCode.COMMON_ERROR, "æ–‡ä»¶å·²ç»å­˜åœ¨");
        }
        //åˆ¤æ–­æ–‡ä»¶çˆ¶ç›®å½•æ˜¯å¦å­˜åœ¨
        if (!filePath.getParentFile().exists()) {
            filePath.getParentFile().mkdirs();
        }
        try {
            file.transferTo(filePath);
        } catch (IOException e) {
            log.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥", e);
            throw new MapleCheckException(ErrorCode.COMMON_ERROR, "å›¾ç‰‡ä¸Šä¼ å¤±è´¥");
        }
        return fileName;
    }

    public List<Map<String, Object>> uploadFiles(MultipartFile[] files) {
        int size = 0;
        for (MultipartFile file : files) {
            size = (int) file.getSize() + size;
        }
        if (size > fileProperties.getMaxFileSize()) {
            throw new MapleCheckException(ErrorCode.COMMON_ERROR, "æ–‡ä»¶è¿‡å¤§");
        }
        List<Map<String, Object>> fileInfoList = new ArrayList<>();
        for (int i = 0; i < files.length; i++) {
            Map<String, Object> map = new HashMap<>();
            String fileName = files[i].getOriginalFilename();
            //è·å–æ–‡ä»¶åç¼€
            String afterName = StringUtils.substringAfterLast(fileName, ".");
            //è·å–æ–‡ä»¶å‰ç¼€
            String prefName = StringUtils.substringBeforeLast(fileName, ".");

            String fileServiceName = new SimpleDateFormat("yyyyMMddHHmmss")
                    .format(new Date()) + i + "_" + prefName + "." + afterName;
            File filePath = new File(fileProperties.getDocFilePath(), fileServiceName);
            // åˆ¤æ–­æ–‡ä»¶çˆ¶ç›®å½•æ˜¯å¦å­˜åœ¨
            if (!filePath.getParentFile().exists()) {
                filePath.getParentFile().mkdirs();
            }
            try {
                files[i].transferTo(filePath);
            } catch (IOException e) {
                log.error("æ–‡ä»¶ä¸Šä¼ å¤±è´¥", e);
                throw new MapleCheckException(ErrorCode.COMMON_ERROR, "æ–‡ä»¶ä¸Šä¼ å¤±è´¥");
            }
            map.put("fileName", fileName);
            map.put("filePath", filePath);
            map.put("fileServiceName", fileServiceName);
            fileInfoList.add(map);
        }
        return fileInfoList;
    }

    /**
     * æ‰¹é‡åˆ é™¤æ–‡ä»¶
     *
     * @param fileNameArr æœåŠ¡ç«¯ä¿å­˜çš„æ–‡ä»¶çš„åæ•°ç»„
     */
    public void deleteFile(String[] fileNameArr) {
        for (String fileName : fileNameArr) {
            String filePath = fileProperties.getDocFilePath() + fileName;
            File file = new File(filePath);
            if (file.exists()) {
                try {
                    Files.delete(file.toPath());
                } catch (IOException e) {
                    e.printStackTrace();
                    log.warn("æ–‡ä»¶åˆ é™¤å¤±è´¥", e);
                }
            } else {
                log.warn("æ–‡ä»¶: {} åˆ é™¤å¤±è´¥ï¼Œè¯¥æ–‡ä»¶ä¸å­˜åœ¨", fileName);
            }
        }
    }

    /**
     * ä¸‹è½½æ–‡ä»¶
     */
    public void downLoadFile(HttpServletResponse response, String fileName) throws UnsupportedEncodingException {
        String encodeFileName = URLDecoder.decode(fileName, "UTF-8");
        File file = new File(fileProperties.getDocFilePath() + encodeFileName);
        // ä¸‹è½½æ–‡ä»¶
        if (!file.exists()) {
            throw new MapleCheckException(ErrorCode.COMMON_ERROR, "æ–‡ä»¶ä¸å­˜åœ¨ï¼");
        }
        try (FileInputStream inputStream = new FileInputStream(file);
             ServletOutputStream outputStream = response.getOutputStream()) {
            response.reset();
            //è®¾ç½®å“åº”ç±»å‹	PDFæ–‡ä»¶ä¸º"application/pdf"ï¼ŒWORDæ–‡ä»¶ä¸ºï¼š"application/msword"ï¼Œ EXCELæ–‡ä»¶ä¸ºï¼š"application/vnd.ms-excel"ã€‚
            response.setContentType("application/octet-stream;charset=utf-8");
            //è®¾ç½®å“åº”çš„æ–‡ä»¶åç§°,å¹¶è½¬æ¢æˆä¸­æ–‡ç¼–ç 
            String afterName = StringUtils.substringAfterLast(fileName, "_");
            //ä¿å­˜çš„æ–‡ä»¶å,å¿…é¡»å’Œé¡µé¢ç¼–ç ä¸€è‡´,å¦åˆ™ä¹±ç 
            afterName = response.encodeURL(new String(afterName.getBytes(), StandardCharsets.ISO_8859_1.displayName()));
            response.setHeader("Content-type", "application-download");
            //attachmentä½œä¸ºé™„ä»¶ä¸‹è½½ï¼›inlineå®¢æˆ·ç«¯æœºå™¨æœ‰å®‰è£…åŒ¹é…ç¨‹åºï¼Œåˆ™ç›´æ¥æ‰“å¼€ï¼›æ³¨æ„æ”¹å˜é…ç½®ï¼Œæ¸…é™¤ç¼“å­˜ï¼Œå¦åˆ™å¯èƒ½ä¸èƒ½çœ‹åˆ°æ•ˆæœ
            response.addHeader("Content-Disposition", "attachment;filename=" + afterName);
            response.addHeader("filename", afterName);
            //å°†æ–‡ä»¶è¯»å…¥å“åº”æµ
            int length = 1024;
            byte[] buf = new byte[1024];
            int readLength = inputStream.read(buf, 0, length);
            while (readLength != -1) {
                outputStream.write(buf, 0, readLength);
                readLength = inputStream.read(buf, 0, length);
            }
            outputStream.flush();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

~~~

ç¼–å†™ä¸€ä¸ªæµ‹è¯•çš„controllerå§

~~~java
package com.maple.demo.controller;

import com.maple.demo.config.bean.ErrorCode;
import com.maple.demo.config.exception.MapleCheckException;
import com.maple.demo.util.file.FileUtil;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.AllArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import javax.servlet.http.HttpServletResponse;
import java.util.List;
import java.util.Map;

/**
 * @author ç¬‘å°æ«
 * @date 2022/7/22
 * @see <a href="https://www.xiaoxiaofeng.com">https://www.xiaoxiaofeng.com</a>
 */
@Slf4j
@RestController
@AllArgsConstructor
@Api(tags = "æ–‡ä»¶ç›¸å…³æ“ä½œæ¥å£")
@RequestMapping("/example")
public class TestFileController {

    private final FileUtil fileUtil;

    @PostMapping("/uploadImage")
    @ApiOperation("å›¾ç‰‡ä¸Šä¼ ")
    public String uploadImage(@RequestParam(value = "file") MultipartFile file) {
        if (file.isEmpty()) {
            throw new MapleCheckException(ErrorCode.COMMON_ERROR, "å›¾ç‰‡å†…å®¹ä¸ºç©ºï¼Œä¸Šä¼ å¤±è´¥!");
        }
        return fileUtil.uploadImage(file);
    }

    @PostMapping("/uploadFiles")
    @ApiOperation("æ–‡ä»¶æ‰¹é‡ä¸Šä¼ ")
    public List<Map<String, Object>> uploadFiles(@RequestParam(value = "file") MultipartFile[] files) {
        return fileUtil.uploadFiles(files);
    }


    @PostMapping("/deleteFiles")
    @ApiOperation("æ‰¹é‡åˆ é™¤æ–‡ä»¶")
    public void deleteFiles(@RequestParam(value = "files") String[] files) {
        fileUtil.deleteFile(files);
    }

    @GetMapping(value = "/download/{fileName:.*}")
    @ApiOperation("æ–‡ä»¶ä¸‹è½½åŠŸèƒ½")
    public void download(@PathVariable("fileName") String fileName, HttpServletResponse response) {
        try {
            fileUtil.downLoadFile(response, fileName);
        } catch (Exception e) {
            log.error("æ–‡ä»¶ä¸‹è½½å¤±è´¥", e);
        }
    }
}

~~~

## åŠŸèƒ½æµ‹è¯•âœŒ

### å•å¼ å›¾ç‰‡ä¸Šä¼ 

ä½¿ç”¨postmanè¯·æ±‚æ¥å£ï¼šhttp://localhost:6666/example/uploadImage

![image-20220916153235824](https://image.xiaoxiaofeng.site/article/img/2022/09/16/xxf-20220916153237.png)

ä¸Šä¼ æˆåŠŸåå¯ä»¥åœ¨å¯¹åº”çš„æ–‡ä»¶å¤¹ä¸‹é¢çœ‹åˆ°æˆ‘ä»¬ä¸Šä¼ çš„æ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20220917161506652](https://image.xiaoxiaofeng.site/article/img/2022/09/17/xxf-20220917161508.png)

### è®¿é—®ä¸Šä¼ çš„å›¾ç‰‡

ä¸Šä¸ªcaseæˆ‘ä»¬ä¸Šä¼ äº†ä¸€å¼ å›¾ç‰‡ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆè¿›è¡Œè®¿é—®å‘¢ï¼Ÿè¿™ä¸ªæˆ‘ä»¬åœ¨WebMvcConfigæ–‡ä»¶ä¸­é…ç½®çš„ï¼Œåœ°å€åœ¨ymlæ–‡ä»¶ä¸­é…ç½®ã€‚

å‘é€è¯·æ±‚ï¼šhttp://localhost:6666/example/images/20220916153101_29170841.jpg

![image-20220916153333705](https://image.xiaoxiaofeng.site/article/img/2022/09/16/xxf-20220916153336.png)



### å¤šæ–‡ä»¶ä¸Šä¼ 

fileæ”¯æŒæ•°ç»„å½¢å¼çš„ä¸Šä¼ ï¼Œæµ‹è¯•ä¸Šä¼ é“¾æ¥ï¼šhttp://localhost:6666/example/uploadFiles

![image-20220916153611419](https://image.xiaoxiaofeng.site/article/img/2022/09/16/xxf-20220916153613.png)

### åˆ é™¤æ–‡ä»¶

æµ‹è¯•åˆ é™¤æ–‡ä»¶é“¾æ¥ï¼Œåé¢è·Ÿæ–‡ä»¶åå³å¯ï¼šhttp://localhost:6666/example/deleteFiles?files=202209161535210_9c59247e8182b769f7ca23e4ad06b41.jpg

![image-20220916153711441](https://image.xiaoxiaofeng.site/article/img/2022/09/16/xxf-20220916153712.png)

åˆ é™¤æˆåŠŸåï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¤šæ–‡ä»¶ä¸Šä¼ çš„ä¸¤å¼ å›¾ç‰‡ä»…å‰©ä¸€å¼ äº†ã€‚

![image-20220916153736777](https://image.xiaoxiaofeng.site/article/img/2022/09/16/xxf-20220916153738.png)

## äº‘ç©ºé—´æ–‡ä»¶ä¸Šä¼ 

[ã€ŠJAVAå®ç°ä¸Šä¼ æ–‡ä»¶åˆ°åˆæ‹äº‘ã€‹](https://xiaoxiaofeng.com/archives/youpaiyun)

[ã€ŠJAVAä½¿ç”¨é˜¿é‡Œäº‘OSSäº‘å­˜å‚¨ã€‹](https://www.xiaoxiaofeng.com/archives/alioss)

## å…³äºç¬‘å°æ«ğŸ’•

> æœ¬ç« åˆ°è¿™é‡Œç»“æŸäº†ï¼Œå–œæ¬¢çš„æœ‹å‹å…³æ³¨ä¸€ä¸‹æˆ‘å‘¦ï¼Œå¤§ä¼™çš„æ”¯æŒï¼Œå°±æ˜¯æˆ‘åšæŒå†™ä¸‹å»çš„åŠ¨åŠ›ã€‚
>
> å¾®ä¿¡å…¬ä¼—å·ï¼šç¬‘å°æ«
>
> ç¬‘å°æ«ä¸ªäººåšå®¢ï¼š[https://www.xiaoxiaofeng.com](https://www.xiaoxiaofeng.com)
>
> CSDNï¼š[https://zhangfz.blog.csdn.net](https://zhangfz.blog.csdn.net)
>
> æœ¬æ–‡æºç ï¼š[https://github.com/hack-feng/maple-demo](https://github.com/hack-feng/maple-demo)

