摘要

2021年3月，我参与了山东省某港口“绿色化港口云平台”的建设项目，在项目中担任系统架构师的职位。该项目旨在构建以港口为核心，融合航运、货运及港口业务的综合性统一平台，涵盖电子口岸信息查询、集装箱运输、件杂化运输、干散货运输等多个业务模块。通过对平台建设需求的分析，鉴于平台业务线的多样性，以及部分业务需要针对用户访问量自动扩容等需求，我们项目组经过讨论摒弃了传统的SOA架构，选择使用云原生架构进行平台的设计、部署与运维。经过项目组成员不懈的努力下，项目历时15个月开发完成，项目成功上线并稳定运行两年多，显著提升了港口作业效率，赢得了港口管理层、业务人员及外部用户的高度评价。

论文

随着信息技术的飞速发展，信息化建设与企业上云已成为各行各业的重要战略。该港口作为多港区、多业务线的综合性港口，面临着业务系统独立、数据孤岛、操作繁琐等问题。例如货主、货代进港作业需要在对应的业务平台上进行操作，不同的业务系统也要单独的维护司机、车辆信息，司机进港运输货物需要只有货代公司开具的货物提货证明、提货明细等纸质单据，这些单据极易丢失、损坏等。为解决这些问题，港口决定构建“绿色化港口云平台”，实现用户、司机、车辆信息的统一管理，用户可以在平台录入司机车辆信息，进行预约提入货，同时将各业务线的纸质单据转化为电子单据，港口实现根据车牌号识别自动抬杆出入港，业务人员通过车牌号和司机身份证信息自动获取预约的提入货订单进行作业。在此过程中，我们选择了云原生架构作为技术支撑，以期实现平台的灵活扩展、高效运维与可靠运行。

云原生架构以其服务化、强韧性、可观测性和自动化的设计原则，成为我们构建平台的理想选择。其中服务化是将应用程序进行拆分为多个服务，每个服务具有独立的业务和职责，服务之间可以通过轻量级通信机制进行交互，从而系统的灵活性和可扩展性；强韧性说明系统要具备一定的容错性和自动扩容能力，当系统出现故障需要具备一定的自我恢复能力，从而保障系统的可靠性和高可用。可观测性是能够展现服务之间的运行情况，通过对日志、链路进行观测、分析，预测或及时的查找系统出现的故障问题，保障系统的稳定运行、提高运维效率；通过自动化部署、自动化扩展、自动化运维，提高了云原生框架的搭建效率，提升了系统的运维能力，通过搭建CI/CD可持续部署交付平台，实现高效快速的实现开发运维。

通过对港内业务需求的分析，我们针对不同的业务线进行服务拆分，针对用户、司机、车辆信息进行整合，实现整个系统的数据高内聚、不同业务线之间低耦合。系统开发架构我们采用Spring Cloud框架，使用Mysql数据库保存数据，考虑到拆分后将会产生大量的业务微服务，服务的单独部署的困难性，我们针对性开发了一套CI/CD持续交付平台。

在“绿色化港口云平台”的建设过程中，如何针对服务进行拆分、服务拆分的粒度是我们遇到的一个问题，项目组中有人提议按港口进行服务拆分，每个港口拆分为一个服务，但考虑到每个港口中存在不同的业务，并且各港口之间存在交叉的信息和业务，显然按港口拆分不是一种很好的方式，我们最终按照业务线进行拆分，以单独的服务整合用户、车辆信息，同时将各个业务线拆分为单独的服务，同时添加分港口字段标志信息，区分不同港口的业务数据。通过这种服务拆分的方式，实现了数据级别的聚合，相关数据放在一起，方便数据的分析，维护。将不同的业务线拆分为单独的服务，各服务之间独立运行，相对灵活，即使出现故障也互不影响，同时如果出现新的业务场景，可以再开一个新的服务集成即可，大大的提升了系统的灵活性、可用性和可扩展性。

在设计的过程中，我们通过对系统的各项指标进行监控，以便达到业务瓶颈的时候自动进行扩容操作。例如针对电子口岸信息查询的服务，当查询达到我们预设的峰值时，我们为了保障用户的使用，会对服务进行自动扩容操作，当请求达到我们设置的并发请求数后，对后续的请求进行熔断处理，给用户提示，并良好的引导用户稍后再试，防止因服务器因超出最大负载能力而出现故障。同时为了保障系统的可用性，防止出现恶意爬取数据的行为，我们针对电子口岸信息查询，通过账号、设备信息等多个维度设定规则，通过设置单位时间内最大的可查询数量进行设置，拦截一些非法爬取数据的行为。但某个服务发生故障时，通过心跳检测服务运行状况，如果心跳连接失败，将自动启动备用服务，从而保障系统的可靠性，提高系统的强韧度。

通过使用Nacos当作注册中心，可以全局化的监测服务运行状况，使服务的运行具备可观测性。使用ELK对应用产生的系统日志和业务日志进行收集和展现，通过ES支持的强大的的检索能力，我们创建日志检索服务，可以快速的排查各个信息的日志，定位系统的错误位置。并通过Zipkin对服务间的调用链路进行采集、分析，使云原生架构更具备可检测性。

通过搭建CI/CD持续化交付平台，提升应用系统的自动化能力。在“绿色化港口云平台”种，我们使用GitLab对项目源码进行版本管理，使用Docker容器对服务进行打包，配合使用Jenkins对服务进行自动化测试验证和部署，使用K8S对实现容器间的管理、调度。通过CI/CD持续化交付平台，在日常的版本迭代的过程中，只需要将测试过的代码合并到生产分支CI/CD平台上申请部署上线，经相关负责人审核通过后，部署平台将自动拉取代码，进行打包发布。当服务发生故障时，通过K8S编排自动启用备用服务，并会第一时间通知运维人员，保障系统的可靠性。

在整个平台的建设过程中，使用云原生架构虽然大大提高了系统的灵活性和可扩展性，但是多个服务之间的调用分布式事务和数据一致性是一个难题，针对这个问题我们引入了分布式事务中间件Seata，并坚持将与外部系统交互放在最后的原则来解决分布式事务的问题。当然针对必须先调用外部系统后，我们系统出现异常的情况，我们对接口进行熔断降级，并采用补偿机制，保证与外部系统的数据一致性。

在全体项目组成员的共同努力下，我们按时保质保量的完成了“绿色化港口云平台”的建设，通过使用云原生架构的使用，打破了传统的单机瓶颈，显著提高了平台的灵活性、可扩展性和高可用性。平台的上线不仅大幅提高了港口作业效率，还通过电子化转型每年节省了大量纸张资源，为港口行业的绿色发展树立了典范。未来，我们将继续探索云原生技术的创新应用，为港口的智能化、绿色化发展贡献力量。

