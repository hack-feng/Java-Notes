摘要
2021年3月，我在山东省某港口参与“现在化绿色港口平台”项目的建设，该项目是打造以港口为基础，整合港口航运、货运与港口业务为一体的统一平台。我在项目中担任软件架构师的职位，主要负责系统整体架构设计与搭建，控制项目的开发方向。针对港口业务的需求，我们项目中经过讨论，最终决策认为使用微服务架构实现最为合适，该项目作为港口统一对外平台，要与现有的各个业务线的生产系统对接，将整个港口的用户和车辆整合到统一的服务作为基础服务，同时将不同的业务线拆分到单独的服务，彼此之间单独部署，互不影响，服务之间功能清晰明确，易于维护。整个项目耗时16个月开发完成，到目前，项目已经稳定运行2年多，大大提高了港口的作业效率和用户进港办理业务的便利性，得到了领导、港口员工和用户的一致好评。

正文

随着社会的发展，加强信息化建设已经是各单位的重要任务。该港口分为多个港区，各个港区又拥有不同的业务线，例如提供电子口岸查询信息、集装箱运输、件杂货货物运输、干散货货物运输等。该港区现状是各个系统各自运行，用户信息和车辆信息各个系统单独维护一套，数据之间没有打通，同一个司机到不同的港区运输货物需要开通不同账号，车辆进港作业需要开各种的纸质证明，且证明容易丢失、损坏。针对这种种现象，该港口决定打造用户一端注册，多港区可用的统一化平台，将港口的用户、车辆进行统一化管理；消除纸质化各种单据，实现通过平台预约，车辆进港时自动抬杆，并根据司机身份证刷卡自动获取对应提入货信息；集成现有的各个业务生产系统，实现用户在同一个平台可以进行各个业务线的业务操作，打通各个业务系统之间的数据，实现业务数据统一化，避免“信息孤岛”的出现。

根据业务需求的分析，因港口业务生产系统众多，且需要逐一对接，除用户和车辆的信息外，每个业务线的功能相对独立，分析了主流的软件架构风格，我们项目组一致任务使用微服务的架构风格比较适用，将用户和车辆信息搭建单独的基础服务，使用基础数据的聚合，将需要集成的各个业务线单独拆分到对应的服务，实现细颗粒拆分，各个服务之间开发部署互不影响，且易于维护。在技术选型上，我们选择使用主流的Spring Cloud框架，采用Nacos作为服务注册中心和配置管理，使用Mysql数据库存储数据，针对热点数据使用Redis做缓存，使用Mq进行异步消息通知。针对展现给用户的界面，考虑到用户使用的易用性和便利性，我们使用Vue开发网站端，提供更为强大的界面展示功能，针对进港作业的司机用户，我们针对性的开发了配套的APP，方便司机用户随时随地的查看作业信息。

微服务架构是将一个大的应用系统拆分成多个小的服务，各个服务之间相互独立，可以单独部署，升级时，彼此不依赖的服务互不影响，服务之间可以通过http请求进行通信交互。通过服务的拆分，可以解决应用单机的性能瓶颈，通过服务模块的划分，各个服务之间项目独立，服务的业务比较清晰，减少了系统的复杂度，提升了系统的可靠性；同时各个服务相互独立，维护互不影响，易于维护；基础的通用服务进行聚合，数据统一管理，不同的业务系统可以直接调用，提高了模块的可复用。但是服务的拆分，势必会影响到应用的复杂度，加大服务间的管理难度，因此我们引入Sentinel微服务监控组件。

针对港口的需求，我们在架构设计阶段，将整个系统服务拆分为三种类型。一、框架的基础服务，框架的基础服务是保障整个项目的开发运行，是SpringCloud框架搭建所需要的服务，例如作为注册中心和配置中心的Nacos，解决分布式事务的Seata，消息中间件Rabbit MQ等。二、应用的基础服务，例如港内员工中心、用户中心、车辆中心等数据聚合，供其它服务所依赖的基础的服务。三、各个业务系统的服务，例如电子口岸信息查询服务、集装箱运输服务、件杂货运输服务、干散货运输服务等。通过三个服务类型的拆分，我们针对各个类型的服务也做了差异化的设计和开发部署。

框架的基础服务，是整个项目运行的保障，它提供了微服务的基础功能，像服务注册、配置管理、服务链路追踪等，对底层框架基别的服务，我们采取集群方式的部署，防止出现单机故障，导致整个系统不可用的问题，提高系统的可靠性。

应用的基础服务，是整个项目的基层，几乎所有的服务都会依赖底层服务，服务的部署我们也是采用高可用的集群方式部署，注册到Nacos注册中心，并以心跳的方式监控服务的可用性，如果服务心跳链接异常，自动通知运维人员进行管理。同时对用户信息和司机信息的数据设计，我们采用主从同步，通过主从设计，可以实现数据的读写分离，提高了数据库的访问性能，同时将数据冗余存放多份，保障数据的安全性，如果主库出现故障，自动推选从库为主库，在突破单机性能屏障的同时，可以防止出现单机不可用的问题。

对于各个业务系统的服务，是系统的主要组成部分，负责和业务生产系统进行交互，并将生产信息整合展示给用户。在和业务生产系统交互的过程中，我们采取统一的交互方式，统一使用http请求，以json的格式对数据进行传输，通过制定统一数据交互方式，提高了系统之间的互操作性，同时也降低系统因不同交互方式带来的不统一性和复杂度。在和各个系统的交互过程中，我们采取数字签名，保障系统之间的调用不可抵赖和数据的完整性，同时对数据进行加密传输，保障数据的安全性。在将业务数据展示给用户的界面，我们使用响应式布局，通过流式布局的方式，根据用户所使用设备的分辨率，自动切换页面展示的样式，方便用户在不同设备端上访问系统，提高系统的可用性和易读性。

在项目运行维护阶段，我们也遇到了一些问题，例如电子口岸信息查询量大，数据库压力过大，且存在异常过量查询的行为。针对用户查询量十分庞大，且用户大多查询最近的数据，我们对最近的热点数据使用Redis进行缓存，当用户查询数据时，优先查询缓存数据，如果查询的数据在缓存中不存在，再去查询数据库，如果查询的数据创建时间在3天内，则放入redis缓存，并设置缓存的有效时间，提升数据的查询的效率，并降低了数据库的压力。同时针对异常过量查询的行为，我们采取账号和IP等多维度的查询监控，当在一定的时间范围内，某个账号或IP出现大量的疑似非人为的查询时，我们对其进行拒绝服务。

在我们整个项目的共同努力下，我们按时的保质保量完成了任务。项目通过使用微服务架构，整个项目稳定运行，一些请求量较大的功能，我们也针对性的通过集群部署，负载均衡等方案，使其性能大大提升。通过系统的上线，用户在进港作业上的便利性得到了大大的提升，同时消除了纸质化的单据转为线上化的电子数据，每年将会节约百万张纸张，也间接的保护了大自然的环境，科技造福人类的同时，也必将造福与大自然。
