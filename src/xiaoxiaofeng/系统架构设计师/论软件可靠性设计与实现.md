摘要

2021年3月，我在山东省某港口参与"智慧港口平台"的建设，整个平台打造统一对外平台，集成港口的件杂货运输、干散货运输、油品运输、集装箱运输等业务子系统。我在项目重担任系统架构师一职，负责对整个平台的系统架构搭建，控制平台的搭建方向。由于是打造的对外的统一平台，象征着港口对外的门面，所以系统的可靠性尤为重要。针对智慧港口平台的建设需求，从容错技术、检错技术和系统复杂度三个方面进行了可靠性设计，实现了系统的7*24小时稳定运行，并显著提升了港口作业效率。整个平台搭建历时1年8个月开发完成，时至今日，系统已稳定运行1年半的时间，得到了领导、港口作业人员以及社会进港办理业务的人员的一致好评。

正文

随着社会的发展，加强信息化建设是各单位的首要任务。该港口分为多个港区，各个港区有不同的业务线，例如电子口岸信息查询、集装箱运输、件杂货货物运输、干散货货物运输等。港口现状是货主和货代对货物查询需要到不同的港区作业柜台或者客服电话查询，业务量巨大，且极为不方便；同时，对货物运输时，进港车辆需要持有货主或货代公司开具的进港证明，货物进出货单据等等一些列的纸质证明。因此，该港口决定打造一端注册，多港可用的统一化平台。提供信息查询、业务办理线上化，让用户在有网的环境下，可以随时随地的查询业务信息；统一管理用户信息，车辆信息，让来港办理业务的用户和车辆提前在系统中登记备案，并根据车牌号自动设别车辆进出港，根据用户身份证和车牌号自动从系统中获取提入货信息；和港内各个生产系统打通，进行操作交互，打通各生产业务系统的数据，实现港口数据统一化，避免“信息孤岛的”出现。

首先，根据项目的需求分析，整个项目对可靠性要求非常高。正常情况下，平台需要7*24小时运行，在设计的过程中，需要考虑系统的容错性，防止在系统运行过程中，软硬件出现问题，导致系统不可用，从而影响港口作业；港口提供了大量的电子口岸信息查询，系统本身查询的数据量就非常巨大，为了防止存在恶意非正常的数据查询，系统需要一定的检错能力设计；同时涉及到多个不同港口的信息集成，各个港口又存在不同的业务线，不同港口、业务线的集成方式应尽量统一，通过标准的方式进行不同系统之间的接入，减少代码的复杂度，从而提高系统的可用性。整个平台的搭建使用微服务的系统设计架构，将各港口的用户、车辆抽取到统一的服务中，集中式管理，同时将不同的生产线业务拆分成单独的服务进行开发部署。

在架构设计阶段，系统的可靠性要求是比较明确的，系统的核心模块运行都要有可靠性的保障。主流的可靠性设计通常需要考虑多个方面，我们在系统设计过程中，主要通过三个方面来提升系统的可靠性。一、系统的容错技术设计，常用的方式有块恢复技术、N版本设计、冗余设计、防卫式程序设计等，容错性设计要求要有错误的自我恢复能力；二、检错技术设计，通过对一些行为进行监控，如验证码登录、电子口岸信息查询，设置阈值，如果超出阈值将自动禁止用户操作行为，防止一些恶意的操作影响系统的可用性；三、降低系统的复杂度，通过对一致性的信息进行统一管理，提高相同数据的内聚管理，是信息管理统一方便，并对不同的业务流程拆分单独服务部署管理，降低不同业务系统的耦合度，不相关的系统之间故障互不影响，对不同的业务系统采用标准统一的对接方式，降低系统的复杂性。

在整个架构设计阶段，我们整个小组通过对港口核心业务进行分析分组，整合项目开发过程中需要注意的可靠性设计，并对一些相关的可靠性问题进行分组归类，采用故障模式分析法，对可能出现的故障问题进行预测分析，通过各种手段提高系统的可用性；同时对一些系统的风险分析，对一些系统中常见的方案拿来类比，尽量及早的发现有风险的问题，并预防风险的发生。

在系统的容错性技术设计上，我们采用了冗余设计和防卫式编程。关于冗余设计，我们对用的各个中间件进行集群搭建。例如数据库，我们采取主从部署，通过主从模式搭建，实现数据读写分离，在提升用户对数据访问的性能的同时，如果主库出现故障，将自动切换从库成为主库，并在多个库都冗余了数据，防止一台服务器出现故障，导致数据丢失的问题；对于Redis，我们采用集群的方式部署，防止出现单机不可用的情况；服务部署同样采用冗余部署，当主服务器出现不可用的情况，自动切换备用服务器，同时在用户访问量剧增的场景，自动进行扩容，尽可能地提高系统的可用性。其中防卫式编程，我们对一些可预见的操作进行异常拦截处理，尽可能地防止出现不可控的错误，对拦截到的异常，执行断路器，进行数据回滚，如果数据已同步到集成的业务系统，同时也要通知业务系统进行数据回滚，保证数据的一致性。

在系统的检错性技术设计上，我们针对一些不同的使用场景采取了不同的方案。例如，对一些核心操作，像业务数据的增删改操作，我们记录操作日志，如果出现数据异常，可以通过操作日志进行还原整个的数据操作过程，分析具体的原因；针对一些可能存在恶意的访问进行校验拦截，像验证码登录，为了方便用户对系统的使用，第一次发送验证码不做限制，之后发送，采用图形拖动校验码校验是否真人操作，同时通过用户手机号、IP地址等多个维度记录一定时间范围内的发送次数，并设置阈值，对达到发送阈值的请求进行提示，防止恶意刷验证码事件。同时也对软硬件环境进行监测，软件方面，对一些付费有限额的外部中间件进行余额检测，达到设置的额度，自动进行短信和邮件通知相应的负责人进行续费等；硬件方面，对一些机器配置进行监控，像服务器的CPU、内存、资源等信息，如果出现异常或不足时，自动通知运维人员进行管理，从而预见性的提高系统的可靠性，防止出现问题后再进行排查。

在系统的复杂度设计上，我们采用高内聚、低耦合的设计思想，对相同类型的操作或数据进行内聚，对不同的业务操作进行拆分，降低耦合度，减少系统之间的相互影响，间接的提高系统的可靠性。对外部的接口交互中，统一使用http请求，数据报文统一使用json格式，交互统一化，减少各种因数据请求不对或数据格式问题带来的系统不可用的问题。因为和外部业务系统没有登录校验拦截，我们针对不同的系统，下发不同的密钥，通过公钥对数据加密，使用私钥对数据验签，同时对数据进行加密传输，方正出现数据泄露或恶意接口调用的问题，提高接口交互的安全性。

在系统的整个运行周期中，除大版本迭代通知用户更新外，服务暂未出现较大的不可用事故。系统曾出现过因不可抗拒的原因导致的主服务不可用的故障，系统自动切换到备用服务器上，用户使用过程中基本无感。通过设计阶段对系统的可靠性进行设计，很大程度上减少了系统的故障率，提升了系统的高可用。在整个运维使用的过程中，我们也针对使用的情况进行了多个版本的迭代，其中针对可靠性，我们也针对性的做了优化，例如使用比较频繁的服务我们增加了多机部署，使用Nginx负载均衡的方式提高系统的性能；针对一些实时性，历史阶段基本不用数据，进行策略设计，自动归档，节约资源的同时，也提高了系统的查询性能，从而间接的提高了系统可靠性。

最后，经过整个项目组的共同努力下，我们按期保质保量的完成了这个项目，通过对系统可靠性的设计，运行期间，我们得到了用户一致性的好评反馈。用户通过使用"智慧港口平台"，进港运输作业效率提升30%左右，电子口岸查询业务节省了约80%的工作人员，这些工作人员投入了更为需要的岗位上，同时将单据信息通过纸质化转为电子化，每年节约上百万纸张，信息系统的建设化，在提升了工作效率的同时，也间接的保护了大自然的环境。

